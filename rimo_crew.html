<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì–´ë“œë¯¼ Â· í¬ë£¨ ìƒì„±</title>
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#232333;
    --tile:#141627; --tile2:#101223; --accent:#7aa7ff; --good:#2aa84a; --bad:#ff5d5d;
    --chip-bg:#14172a; --chip-bd:#2b2e54; --accent-glow: rgba(122,167,255,.35);

    /* Theme Colors */
    --t-red:#ff5d5d;      --t-red-bg:rgba(255,93,93,.14);      --t-red-br:rgba(255,93,93,.35);
    --t-blue:#7aa7ff;     --t-blue-bg:rgba(122,167,255,.14);   --t-blue-br:rgba(122,167,255,.35);
    --t-yellow:#ffd85d;   --t-yellow-bg:rgba(255,216,93,.16);  --t-yellow-br:rgba(255,216,93,.38);
    --t-green:#56d364;    --t-green-bg:rgba(86,211,100,.16);   --t-green-br:rgba(86,211,100,.42);
    --t-purple:#a78bfa;   --t-purple-bg:rgba(167,139,250,.16); --t-purple-br:rgba(167,139,250,.42);

    /* ë¼ë²¨/ê°„ê²© */
    --label-w: 56px; --label-gap: 2px;
    --label-w-sm: 44px; --label-gap-sm: 2px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}

  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{font-weight:900;font-size:16px}
  .home-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:30px;border-radius:8px;border:none;background:transparent;cursor:pointer;transition:background .2s}
  .home-btn:hover{background:rgba(255,255,255,.08)}

  main{padding:16px;display:grid;gap:16px;max-width:980px;margin:0 auto;padding-bottom:120px}
  .panel{background:var(--tile);border:1px solid var(--line);border-radius:14px;padding:4px 14px 16px 16px}

  /* í¼ ê·¸ë¦¬ë“œ */
  .row{display:grid;grid-template-columns: var(--label-w) 1fr;gap: var(--label-gap);align-items:center;margin:10px 0}
  .row.no-label{grid-template-columns:1fr}
  .row>label{font-weight:700;color:#cfd1e8;font-size:14px;justify-self:start;text-align:left;white-space:nowrap}
  .field{min-width:0}.field>*{width:100%}
  @media (max-width:560px){ .row{grid-template-columns: var(--label-w-sm) 1fr;gap: var(--label-gap-sm)} }

  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2c2f48;background:#0f1020;color:#fff;font-size:14px;transition:border-color .15s, box-shadow .15s}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow),0 0 0 1px var(--accent) inset}
  .row:has(input:focus),.row:has(select:focus),.row:has(textarea:focus)>label{color:#eef3ff}

  .coords{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .toggles{display:flex;gap:10px;flex-wrap:wrap;margin:0}
  .toggle{display:inline-flex;align-items:center;gap:14px;padding:8px 12px;border-radius:999px;color:#e6e9ff;font-size:13px;cursor:pointer;user-select:none;white-space:nowrap;transition:transform .15s, box-shadow .15s;background:var(--chip-bg); border:1px solid var(--chip-bd)}
  .toggle.active{border-color:var(--accent); background:rgba(122,167,255,.16); box-shadow:0 0 10px var(--accent-glow); transform:translateY(-1px) scale(1.01); font-weight:500}

  .themes{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .theme-btn{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:0;padding:4px 8px;border-radius:16px;border:1px solid #2b2e48;background:#14172a;color:#e8e8ef;font-size:12px;font-weight:500;cursor:pointer;user-select:none;flex:0 0 auto;white-space:nowrap;transition:transform .12s, box-shadow .12s}
  .theme-btn .badge{width:14px;height:14px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;background:#0f1020;border:0}
  .theme-btn.active{transform:translateY(-1px) scale(1.02);box-shadow:0 0 0 1px currentColor inset, 0 0 12px currentColor;background:transparent}
  .theme-btn[data-theme="red"]{color:#ff5d5d;background:rgba(255,93,93,.14);border-color:rgba(255,93,93,.35)}
  .theme-btn[data-theme="blue"]{color:#7aa7ff;background:rgba(122,167,255,.14);border-color:rgba(122,167,255,.35)}
  .theme-btn[data-theme="yellow"]{color:#ffd85d;background:rgba(255,216,93,.16);border-color:rgba(255,216,93,.38)}
  .theme-btn[data-theme="green"]{color:#56d364;background:rgba(86,211,100,.16);border-color:rgba(86,211,100,.42)}
  .theme-btn[data-theme="purple"]{color:#a78bfa;background:rgba(167,139,250,.16);border-color:rgba(167,139,250,.42)}

  .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b2e48;background:#1b1d2e;color:#fff;cursor:pointer;margin-top:6px;font-weight:700}
  .btn.primary{background:#2a5bff;border-color:#3d6aff}
  .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:center;}

  /* ===== ì¹´ë“œ ì»´í¬ë„ŒíŠ¸ ===== */
  .r-card{
    position:relative; background:#121428; border:1px solid rgba(255,255,255,.14);
    border-radius:16px; padding:14px; box-shadow:0 2px 14px rgba(0,0,0,.28);margin-bottom:10px
  }
  .r-card h3{margin:0 0 6px;font-size:16px;font-weight:700}
  .r-meta{display:flex;align-items:center;gap:6px;color:#cfd2ff;font-size:14px;flex-wrap:wrap}
  .r-meta .sep{opacity:.5}
  .r-route{display:flex;align-items:center;gap:8px;margin:6px 0 4px;color:#ced2f9;font-size:14px}
  .r-msg{color:#e6e8ff;font-size:14px;margin:6px 0}
  .r-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .r-chip{
    padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#e6e8ef
  }
  .r-chip.is-urban{background:#1e2d55;border-color:#2c4484}
  .r-chip.is-curve{background:#2a1f56;border-color:#40307a}
  .r-chip.is-tour{background:#1e3b3a;border-color:#2f5f5d}
  .r-chip.is-easy{background:#1f3a1f;border-color:#2f5a2f}
  .r-chip.is-balanced{background:#3a341e;border-color:#5a4f2f}
  .r-chip.is-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .r-actions{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}
  .r-actions .act{padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer;border:1px solid #2b2e48; background:#1b1d2e; color:#e6e8ff;}
  .r-actions .act.pub{ background:#2340ff; border-color:#3450ff; }
  .r-actions .act.del{ background:#2a1b24; border-color:#5a2f44; }

  .r-del{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:8px;border:1px solid #2b2e48;background:#171a2c;color:#cfd2ff;font-weight:900;cursor:pointer;}
  .r-del:hover{background:#1f2340}

  .r-card[data-theme="red"]   { border-color:var(--t-red-br) }
  .r-card[data-theme="blue"]  { border-color:var(--t-blue-br) }
  .r-card[data-theme="yellow"]{ border-color:var(--t-yellow-br) }
  .r-card[data-theme="green"] { border-color:var(--t-green-br) }
  .r-card[data-theme="purple"]{ border-color:var(--t-purple-br) }

  .edit-banner{margin:8px 0 0;color:#cfe0ff;font-size:12px}

  .btmnav{position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(11,11,15,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
  .btmnav .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;padding:8px}
  .navitem{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px 4px;border-radius:10px;border:1px solid #2b2e48;background:#14172a;cursor:pointer;font-size:12px;text-align:center;user-select:none;text-decoration:none;color:var(--fg)}
  .navitem.active{background:#27306a;border-color:#3a4aa2}
  .navitem .ico{font-size:18px;line-height:1}

  .small-btn{margin-left:auto;padding:6px 10px;border-radius:8px;border:1px solid #2b2e48;background:#14172a;color:#e6e8ef;cursor:pointer;font-size:12px}
  .list-head{display:flex;align-items:center;gap:10px;margin:0 0 8px 0}

  #cardsPanel { padding: 12px 16px 6px; margin-top: 16px; margin-bottom: 0; }
  .hint{color:#cfd2ff99;font-size:14px;padding:12px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ğŸï¸ RIMO â€” ì–´ë“œë¯¼ Â· í¬ë£¨ ìƒì„±</div>
    <button class="home-btn" id="goMain" title="ë©”ì¸ ì´ë™">ğŸ </button>
  </div>
</header>

<main>
  <section class="panel">

    <!-- í¸ì§‘ ë°°ë„ˆ -->
    <div id="editBanner" class="edit-banner" style="display:none">âœï¸ í˜„ì¬ <b id="editId"></b>ë¥¼ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤. ì €ì¥í•˜ë©´ ì¹´ë“œê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</div>

    <!-- ì œëª© -->
    <div class="row">
      <label for="c_title">ì œëª©</label>
      <div class="field"><input id="c_title" placeholder="ì˜ˆ: &lt;ê°€ì„ë§ì´ ì¹´í˜ ë¼ì´ë”©&gt;"></div>
    </div>

    <!-- ì¼ì‹œ -->
    <div class="row">
      <label for="c_datetime">ì¼ì‹œ</label>
      <div class="field"><input id="c_datetime" type="datetime-local" step="1800"></div>
    </div>

    <!-- ì¶œë°œ -->
    <div class="row">
      <label for="c_from">ì¶œë°œ</label>
      <div class="field">
        <input id="c_from" placeholder="ì˜ˆ: GS25 í•œê°•ë¥´ë„¤ìƒìŠ¤ ë°˜í¬2í˜¸">
        <div class="coords" style="margin-top:8px">
          <input id="from_lat" type="number" step="any" placeholder="ìœ„ë„ (ì˜ˆ: 33.509768)" inputmode="decimal" min="-90" max="90">
          <input id="from_lng" type="number" step="any" placeholder="ê²½ë„ (ì˜ˆ: 126.511954)" inputmode="decimal" min="-180" max="180">
        </div>
      </div>
    </div>

    <!-- ë„ì°© -->
    <div class="row">
      <label for="c_to">ë„ì°©</label>
      <div class="field">
        <input id="c_to" placeholder="ì˜ˆ: RSG ì„±ìˆ˜">
        <div class="coords" style="margin-top:8px">
          <input id="to_lat" type="number" step="any" placeholder="ìœ„ë„" inputmode="decimal" min="-90" max="90">
          <input id="to_lng" type="number" step="any" placeholder="ê²½ë„" inputmode="decimal" min="-180" max="180">
        </div>
      </div>
    </div>

    <!-- ì¸ì› (ì”ì—¬/ì •ì›) -->
    <div class="row">
      <label>ì¸ì›</label>
      <div class="field">
        <div class="coords">
          <input id="c_remaining" type="number" min="0" placeholder="ì”ì—¬">
          <input id="c_capacity" type="number" min="1" placeholder="ì •ì›">
        </div>
      </div>
    </div>

    <!-- ë°°ê¸°ëŸ‰ -->
    <div class="row">
      <label for="c_cc">ë°°ê¸°ëŸ‰</label>
      <div class="field">
        <select id="c_cc">
          <option value="">ê´€ê³„ì—†ìŒ</option>
          <option>125cc ì´í•˜</option>
          <option>125~250</option>
          <option>250~400</option>
          <option>400~800</option>
          <option>800 ì´ìƒ</option>
        </select>
      </div>
    </div>

    <!-- ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤ -->
    <div class="row">
      <label>ìŠ¤íƒ€ì¼</label>
      <div class="field"><div id="styleToggles" class="toggles"></div></div>
    </div>
    <div class="row">
      <label>í˜ì´ìŠ¤</label>
      <div class="field"><div id="paceToggles" class="toggles"></div></div>
    </div>

    <!-- ë©”ì‹œì§€ -->
    <div class="row">
      <label for="c_msg">ë©”ì‹œì§€</label>
      <div class="field"><input id="c_msg" maxlength="30" placeholder="30ì ì´ë‚´"></div>
    </div>

    <!-- í…Œë§ˆ -->
    <div class="row no-label"><div class="field"><div id="themeBar" class="themes"></div></div></div>

    <!-- ë²„íŠ¼ -->
    <div class="btnbar">
      <button class="btn" id="btnDraft">ë“œë˜í”„íŠ¸ ì €ì¥</button>
      <button class="btn" id="btnReset">ìƒˆë¡œ ì‘ì„±</button>
    </div>
  </section>

  <section class="panel" id="cardsPanel">
    <div class="list-head">
      <h3 style="margin:0;font-size:16px;">ë°œí–‰ëœ ë¼ì´ë”© ì¹´ë“œ ëª©ë¡</h3>
      <button class="small-btn" id="btnClearHidden" title="ìˆ¨ê¸´ ì¹´ë“œ ëª¨ë‘ ë³µêµ¬">ğŸ’¾ ë³µêµ¬</button>
      <button class="small-btn" id="btnResync" title="ì„œë²„ì™€ ìƒˆë¡œ ë™ê¸°í™”">ë™ê¸°í™” ğŸ”„</button>
    </div>
    <div id="cards" class="cards"></div>
  </section>
</main>

<nav class="btmnav" aria-label="í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜">
  <div class="wrap">
    <a class="navitem active" href="rimo_crew.html" title="í¬ë£¨ ìƒì„±">
      <div class="ico">ğŸ› ï¸</div><div>í¬ë£¨ ìƒì„±</div>
    </a>
    <a class="navitem" href="rimo_joins.html" title="ë§¤ì¹­ í¬ë§">
      <div class="ico">ğŸ¤</div><div>ë§¤ì¹­ í¬ë§</div>
    </a>
    <a class="navitem" href="rimo_routes.html" title="ë£¨íŠ¸ ì œì•ˆ">
      <div class="ico">ğŸ—ºï¸</div><div>ë£¨íŠ¸ ì œì•ˆ</div>
    </a>
    <a class="navitem" href="rimo_feedback.html" title="í›„ê¸° ëª¨ìŒ">
      <div class="ico">ğŸ“</div><div>í›„ê¸° ëª¨ìŒ</div>
    </a>
    <a class="navitem" href="rimo_data.html" title="ìë£Œ ê´€ë¦¬">
      <div class="ico">ğŸ—„ï¸</div><div>ìë£Œ ê´€ë¦¬</div>
    </a>
  </div>
</nav>

<script>
/* ---------- ê¸°ë³¸ ì„¤ì • ---------- */
const DEBUG = true;
const MAIN_URL = "https://roowalix.github.io/RIMO-test/index.html";

/* ---------- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì›¹ì•± ---------- */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4BXsdN6GEkqKyto0Yxwc3G1b6gn1p8YLOrW2PMOSRpbIZcKKZpjF0GlDcJuCPB7jiTw/exec";
const SHARED_TOKEN = ""; // (ì˜µì…˜)

/* ---------- ì˜µì…˜ ---------- */
const STYLE_OPTS = ["Urban","Curve","Tour"];
const PACE_OPTS  = ["Easy","Balanced","Dynamic"];
const THEME_OPTS = [
  {key:'red',    label:'ë ˆë“œ',   emoji:'ğŸ”´'},
  {key:'blue',   label:'ë¸”ë£¨',   emoji:'ğŸ”µ'},
  {key:'yellow', label:'ì˜ë¡œ',   emoji:'ğŸŸ¡'},
  {key:'green',  label:'ê·¸ë¦°',   emoji:'ğŸŸ¢'},
  {key:'purple', label:'í¼í”Œ',   emoji:'ğŸŸ£'}
];

/* ---------- ìœ í‹¸ ---------- */
const qs=(s,p=document)=>p.querySelector(s);
const qsa=(s,p=document)=>Array.from(p.querySelectorAll(s));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,def)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch(e){return def}};

const DRAFT_KEY='rimo_create_draft_v6';
const PUBLIST_KEY='rimo_published_cards_server_cache';
const HIDE_KEY='rimo_hidden_card_ids_v1';
let editingId = null;

/* ìˆ¨ê¹€ ìœ í‹¸(ë¡œì»¬ ì „ìš©) */
const getHidden=()=>{ try{return JSON.parse(localStorage.getItem(HIDE_KEY)||'[]')}catch(_){return[]} };
const setHidden=(arr)=>localStorage.setItem(HIDE_KEY, JSON.stringify(arr));
function hideCard(id){
  const a=getHidden(); if(!a.includes(id)) a.push(id);
  setHidden(a);
  const list = load(PUBLIST_KEY,[]);
  renderCards(list);
}
function clearHidden(){
  localStorage.removeItem(HIDE_KEY);
  const list = load(PUBLIST_KEY,[]);
  renderCards(list);
}

/* í† ê¸€ */
function makeToggle(label, active=false){
  const el=document.createElement('button');
  el.type='button';
  el.className='toggle'+(active?' active':'');
  el.dataset.val=label;
  el.textContent = label;
  el.addEventListener('click',()=> el.classList.toggle('active'));
  return el;
}
function renderToggles(containerId, options, selected=[]){
  const box=qs('#'+containerId); box.innerHTML='';
  options.forEach(opt=> box.appendChild(makeToggle(opt, selected.includes(opt))) );
}
function selectedToggles(containerId){
  return qsa('#'+containerId+' .toggle.active').map(el=>el.dataset.val);
}

/* í…Œë§ˆ */
function renderThemes(selected='blue'){
  const bar = qs('#themeBar'); bar.innerHTML='';
  THEME_OPTS.forEach(opt=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='theme-btn'+(opt.key===selected?' active':'');
    btn.dataset.theme=opt.key;
    btn.innerHTML = `<span class="badge">${opt.emoji}</span><span class="tx">${opt.label}</span>`;
    btn.addEventListener('click',()=>{
      qsa('.theme-btn', bar).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    });
    bar.appendChild(btn);
  });
}
function getSelectedTheme(){
  const cur = qs('#themeBar .theme-btn.active');
  return cur ? cur.dataset.theme : 'blue';
}

/* ë‚ ì§œ */
function formatKDate(dt){
  const y  = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd = String(dt.getDate()).padStart(2,'0');
  let h = dt.getHours();
  const ampm = (h >= 12) ? 'ì˜¤í›„' : 'ì˜¤ì „';
  h = h % 12; if (h === 0) h = 12;
  const hh = String(h).padStart(2,'0');
  const mi = String(dt.getMinutes()).padStart(2,'0');
  return `${y}/${mm}/${dd}/${ampm} ${hh}:${mi}`;
}
const pad=n=>String(n).padStart(2,'0');
function toLocalDatetimeValue(d){
  const y=d.getFullYear(), m=pad(d.getMonth()+1), day=pad(d.getDate()), hh=pad(d.getHours()), mi=pad(d.getMinutes());
  return `${y}-${m}-${day}T${hh}:${mi}`;
}
function getDateFromInput(){
  const v = qs('#c_datetime').value;
  if(!v) return null;
  const [date,time] = v.split('T'); if(!date||!time) return null;
  const [Y,M,D] = date.split('-').map(Number);
  const [h,m] = time.split(':').map(Number);
  return new Date(Y, M-1, D, h, m||0, 0);
}

/* ì¢Œí‘œ ìë™ ë¶„ë¦¬ */
function extractCoords(text){
  if(!text) return null;
  text = String(text).trim();
  let m = text.match(/@(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if(!m) m = text.match(/[?&]q=(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if(!m){
    const nums = text.match(/-?\d+(?:\.\d+)?/g);
    if(nums && nums.length>=2) m=[, nums[0], nums[1]];
  }
  if(!m) return null;
  let lat = parseFloat(m[1]), lng = parseFloat(m[2]);
  if(Math.abs(lat)>90 && Math.abs(lng)<=90){ const t=lat; lat=lng; lng=t; }
  if(Math.abs(lat)>90 || Math.abs(lng)>180) return null;
  return {lat, lng};
}
function attachAutoSplit(latId,lngId){
  const latEl = qs('#'+latId), lngEl = qs('#'+lngId);
  const onPaste = (e)=>{
    const text = e.clipboardData?.getData('text'); const c = extractCoords(text);
    if(c){ e.preventDefault(); latEl.value=c.lat; lngEl.value=c.lng; }
  };
  const onChange = (e)=>{
    const c = extractCoords(e.target.value);
    if(c){ latEl.value=c.lat; lngEl.value=c.lng; }
  };
  latEl.addEventListener('paste', onPaste); lngEl.addEventListener('paste', onPaste);
  latEl.addEventListener('change', onChange); lngEl.addEventListener('change', onChange);
}

/* ê°’ ë³´ì • */
function normList(v){
  if(Array.isArray(v)) return v.map(x=>String(x));
  if(v==null) return [];
  let s=String(v).trim();
  try{
    if(s.startsWith('[') && s.endsWith(']')){
      const a=JSON.parse(s); if(Array.isArray(a)) return a.map(x=>String(x));
    }
  }catch(_){}
  if(/Ljava\.lang\.Object/i.test(s)) return [];
  return s.split(/[,\|]/).map(t=>t.trim()).filter(Boolean);
}

/* í¼ ìˆ˜ì§‘/ì„¸íŒ… */
function getForm(){
  const dt = getDateFromInput() || new Date();
  return {
    id: editingId || '',
    title: qs('#c_title').value.trim(),
    datetime: dt.toISOString(),
    datetime_display: formatKDate(dt),
    from: qs('#c_from').value.trim(),
    to: qs('#c_to').value.trim(),
    from_lat: parseFloat(qs('#from_lat').value||''),
    from_lng: parseFloat(qs('#from_lng').value||''),
    to_lat: parseFloat(qs('#to_lat').value||''),
    to_lng: parseFloat(qs('#to_lng').value||''),
    cc: qs('#c_cc').value, // ''(ê´€ê³„ì—†ìŒ)ë„ ê·¸ëŒ€ë¡œ
    styles: selectedToggles('styleToggles'),
    pace: selectedToggles('paceToggles'),
    message: qs('#c_msg').value.trim(),
    remaining: parseInt(qs('#c_remaining').value||'0',10),
    capacity: parseInt(qs('#c_capacity').value||'0',10),
    theme: getSelectedTheme()
  };
}
function setForm(it){
  qs('#c_title').value = it.title||'';
  qs('#c_from').value = it.from||'';
  qs('#c_to').value = it.to||'';
  qs('#from_lat').value = it.from_lat??'';
  qs('#from_lng').value = it.from_lng??'';
  qs('#to_lat').value = it.to_lat??'';
  qs('#to_lng').value = it.to_lng??'';
  qs('#c_cc').value = (it.cc ?? '');
  qs('#c_msg').value = it.message||'';
  qs('#c_remaining').value = it.remaining ?? '';
  qs('#c_capacity').value  = it.capacity ?? '';
  const dt = it.datetime ? new Date(it.datetime) : new Date();
  qs('#c_datetime').value = toLocalDatetimeValue(dt);
  renderToggles('styleToggles', STYLE_OPTS, normList(it.styles));
  renderToggles('paceToggles',  PACE_OPTS,  normList(it.pace));
  renderThemes(it.theme || 'blue');
}

/* ìœ íš¨ì„± */
function validate(form){
  const errs=[];
  if(!form.title) errs.push('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!qs('#c_datetime').value) errs.push('ì¼ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if(!form.from) errs.push('ì¶œë°œì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!form.to) errs.push('ë„ì°©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!(form.capacity>0)) errs.push('ì •ì›ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(form.remaining<0) errs.push('ì”ì—¬ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(form.remaining>form.capacity) errs.push('ì”ì—¬ê°€ ì •ì›ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(form.message.length>30) errs.push('ë©”ì‹œì§€ëŠ” 30ì ì´ë‚´ì…ë‹ˆë‹¤.');
  return errs;
}

/* ì„œë²„ ì—°ë™ (ì“°ê¸°: no-cors, ì½ê¸°: fetchâ†’JSONP í´ë°± + ê°•ì œíŒŒì‹±) */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now();
    const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    const u = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    s.src=u;
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}

async function sendToSheet(formOrId, op){
  const payload = new URLSearchParams();
  payload.set('op', op);
  if(SHARED_TOKEN) payload.set('token', SHARED_TOKEN);
  if (typeof formOrId === 'object' && formOrId && !formOrId.id) {
    payload.set('record', JSON.stringify(formOrId));
  } else {
    payload.set('record', JSON.stringify(formOrId));
  }
  try{
    await fetch(WEB_APP_URL, {
      method:'POST', mode:'no-cors',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: payload.toString()
    });
  }catch(e){ console.warn('sendToSheet failed:', e); }
}

/* ë³‘í•© */
function mergeById(localArr=[], serverArr=[]){
  const map = new Map();
  (localArr||[]).forEach(it => { if (it?.id) map.set(it.id, it); });
  (serverArr||[]).forEach(it => { if (it?.id) map.set(it.id, it); });
  return Array.from(map.values()).sort((a,b)=>{
    const ad = a?.datetime || '';
    const bd = b?.datetime || '';
    return bd.localeCompare(ad);
  });
}

/* ====== ê°•ì œ íŒŒì„œ & ë¡œë” ë³´ê°• ====== */
function htmlDecodeEntities(str){
  const map = { '&quot;':'"', '&#34;':'"', '&#39;':"'", '&amp;':'&', '&lt;':'<', '&gt':'>' , '&gt;':'>'};
  return String(str).replace(/(&quot;|&#34;|&#39;|&amp;|&lt;|&gt;)/g, m => map[m] || m);
}
function safeJSONParse(maybe){ try { return JSON.parse(maybe); } catch { return null; } }
function deepParseJSON(maybe){
  let v = safeJSONParse(maybe);
  if (typeof v === 'string') {
    const v2 = safeJSONParse(v);
    if (v2 !== null) return v2;
  }
  return v;
}
function extractJSONFromText(txt){
  const pre = String(txt).match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
  let raw = pre ? pre[1] : String(txt);
  raw = htmlDecodeEntities(raw.trim());
  // object
  let s = raw.indexOf('{'), e = raw.lastIndexOf('}');
  if(s!==-1 && e>s){
    const slice = raw.slice(s, e+1);
    const obj = deepParseJSON(slice);
    if(obj!=null) return obj;
  }
  // array
  s = raw.indexOf('['); e = raw.lastIndexOf(']');
  if(s!==-1 && e>s){
    const slice = raw.slice(s, e+1);
    const arr = deepParseJSON(slice);
    if(arr!=null) return arr;
  }
  const last = deepParseJSON(raw);
  return last;
}
async function tryParseResponse(r){
  try { return await r.json(); } catch(_){}
  try {
    const txt = await r.text();
    const j = extractJSONFromText(txt);
    if (j != null) return j;
    return JSON.parse(txt);
  } catch(_){}
  return null;
}
function extractRows(payload){
  if(Array.isArray(payload)) return payload;
  if(!payload || typeof payload!=='object') return [];
  if(Array.isArray(payload.rows))      return payload.rows;
  if(Array.isArray(payload.data))      return payload.data;
  if(Array.isArray(payload.items))     return payload.items;
  if(Array.isArray(payload.result))    return payload.result;
  if(Array.isArray(payload.published)) return payload.published;
  if(Array.isArray(payload.list))      return payload.list;
  if(Array.isArray(payload.cards))     return payload.cards;
  if(payload.data && Array.isArray(payload.data.rows)) return payload.data.rows;
  return [];
}
function buildCandidateURLs(){
  const base = WEB_APP_URL + (WEB_APP_URL.includes('?') ? '&' : '?');
  const tok  = SHARED_TOKEN ? `&token=${encodeURIComponent(SHARED_TOKEN)}` : '';
  const ts   = `&_=${Date.now()}`;
  return [
    `${base}op=list&scope=published${tok}${ts}`,
    `${base}op=list&scope=main${tok}${ts}`,
    `${base}op=list&scope=all${tok}${ts}`,
  ];
}

/* ì•ˆì „í•œ ë™ê¸°í™”: ì„œë²„ ì„±ê³µ ì‹œì—ë§Œ ìºì‹œ êµì²´ */
async function loadFromServer(){
  // 1) ë¡œì»¬ ìºì‹œ ìš°ì„  í‘œì‹œ
  let cached=[]; 
  try { cached=JSON.parse(localStorage.getItem(PUBLIST_KEY)||'[]'); } catch(_){}
  if(cached.length){ if(DEBUG) console.log('[crew] cache pre-render:', cached.length); renderCards(cached); }

  const urls = buildCandidateURLs();
  for (const listURL of urls){
    // fetch (ì»¨í…íŠ¸íƒ€ì… ë¬´ì‹œí•˜ê³  ê°•ì œ íŒŒì‹±)
    try{
      const res = await fetch(listURL, {cache:'no-store', redirect:'follow'});
      if(res.ok){
        const payload = await tryParseResponse(res);
        const rows = extractRows(payload);
        if (rows.length){
          if(DEBUG) console.log('[crew] fetch OK:', listURL, rows.length);
          const merged = mergeById(cached, rows);
          save(PUBLIST_KEY, merged);
          renderCards(merged);
          return merged;
        } else if (DEBUG) {
          console.warn('[crew] fetch parsed but no rows:', payload);
        }
      } else if (DEBUG) {
        console.warn('[crew] fetch status:', res.status);
      }
    }catch(e){
      if(DEBUG) console.warn('[crew] fetch error:', e.message);
    }
    // JSONP í´ë°±
    try{
      const data = await fetchJSONP(listURL);
      const rows = extractRows(data);
      if (rows.length){
        if(DEBUG) console.log('[crew] JSONP OK:', listURL, rows.length);
        const merged = mergeById(cached, rows);
        save(PUBLIST_KEY, merged);
        renderCards(merged);
        return merged;
      } else if (DEBUG) {
        console.warn('[crew] jsonp parsed but no rows:', data);
      }
    }catch(e){
      if(DEBUG) console.warn('[crew] jsonp error:', e.message);
    }
  }
  if(DEBUG) console.log('[crew] fallback to cache (no fresh data)');
  return cached;
}

/* ì €ì¥/ë°œí–‰/ìˆ˜ì •/ì´ˆê¸°í™” */
function saveDraft(){
  const form=getForm();
  const errs=validate(form); 
  if(errs.length){ alert(errs.join('\n')); return; }
  if(!editingId){ form.id = `crew_${Date.now().toString(36)}`; }
  else{ form.id = editingId; }
  // ì„œë²„ upsert
  sendToSheet(form,'publish');

  // ë¡œì»¬ ì¦‰ì‹œ ë°˜ì˜
  let list=load(PUBLIST_KEY,[]);
  const idx=list.findIndex(x=>x.id===form.id);
  if(idx>=0) list[idx]=form; else list.unshift(form);
  save(PUBLIST_KEY,list); 
  renderCards(list);

  editingId = form.id;
  qs('#editId').textContent = editingId;
  qs('#editBanner').style.display='block';

  alert('ë“œë˜í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function resetForm(){ localStorage.removeItem(DRAFT_KEY); location.reload(); }

/* ë©”ì¸ ë°œí–‰/ì‚­ì œ */
function publishToMain(id){
  if(!id) return;
  sendToSheet({id}, 'main_on');
  alert('ë©”ì¸ì— ë°œí–‰ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
}
function removeFromMain(id){
  if(!id) return;
  if(!confirm('ë©”ì¸ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
  sendToSheet({id}, 'main_off');
  alert('ë©”ì¸ ì‚­ì œ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
}

/* ê°•ì œ ë™ê¸°í™” ë²„íŠ¼ */
async function fullResync(){
  const backup = load(PUBLIST_KEY, []);
  try{
    const rows = await loadFromServer();
    if (Array.isArray(rows) && rows.length){
      save(PUBLIST_KEY, rows);
      renderCards(rows);
      return;
    }
    renderCards(backup);
    alert('ì„œë²„ì—ì„œ ëª©ë¡ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬/ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }catch(e){
    console.warn(e);
    renderCards(backup);
    alert('ë™ê¸°í™” ì‹¤íŒ¨: ê¸°ì¡´ ëª©ë¡ì„ ìœ ì§€í•©ë‹ˆë‹¤.');
  }
}

/* ì¹´ë“œ ë Œë” */
function cls(label){
  switch(String(label).toLowerCase()){
    case 'urban': return 'is-urban';
    case 'curve': return 'is-curve';
    case 'tour': return 'is-tour';
    case 'easy': return 'is-easy';
    case 'balanced': return 'is-balanced';
    case 'dynamic': return 'is-dynamic';
    default: return '';
  }
}
function chip(label){ return `<span class="r-chip ${cls(label)}">${label}</span>`; }

function renderCards(list){
  const hidden = new Set(getHidden());
  const box=qs('#cards'); box.innerHTML='';
  const visible = (list||[]).filter(it => !hidden.has(it.id));
  if(visible.length===0){ box.innerHTML='<div class="hint">ì•„ì§ ë°œí–‰ëœ ì¹´ë“œê°€ ì—†ê±°ë‚˜ ìˆ¨ê²¨ì¡ŒìŠµë‹ˆë‹¤.</div>'; return; }

  visible.forEach(it=>{
    const theme = it.theme || 'blue';
    const styles=normList(it.styles);
    const pace  =normList(it.pace);
    const dt    = new Date(it.datetime || Date.now());
    const when  = it.datetime_display || formatKDate(dt);

    const capacity  = Math.max(0, Number(it.capacity) || 0);
    const remaining = Math.max(0, Number.isFinite(Number(it.remaining)) ? Number(it.remaining) : 0);
    const attended  = Math.min(capacity, Math.max(0, capacity - remaining));

    const ccLabel = (it.cc === '' || it.cc == null) ? 'ê´€ê³„ì—†ìŒ' : String(it.cc);

    const el=document.createElement('article');
    el.className='r-card'; el.dataset.theme=theme; el.dataset.id=it.id;

    el.innerHTML = `
      <button class="r-del" title="ì´ í™”ë©´ì—ì„œ ìˆ¨ê¸°ê¸°" aria-label="ìˆ¨ê¸°ê¸°">âœ•</button>
      <h3>${escapeHtml(it.title||'(ì œëª© ì—†ìŒ)')}</h3>
      <div class="r-meta">â°<span>${when}</span></div>
      <div class="r-route">ğŸ“Œ  ${escapeHtml(it.from||'-')} - ${escapeHtml(it.to||'-')}</div>

      <div class="r-meta cc-line">
        ğŸ ${escapeHtml(ccLabel)} <span class="sep">Â·</span>
        ğŸ‘¥ ì°¸ì„ ${attended}/${capacity} <span class="sep">Â·</span>
        ì”ì—¬ ${remaining}
      </div>

      <div class="r-msg">ğŸ’¬  ${escapeHtml(it.message||'-')}</div>
      <div class="r-chips">
        ${styles.map(chip).join('')}
        ${pace.map(chip).join('')}
      </div>

      <div class="r-actions">
        <button class="act pub" data-act="main_on">ë©”ì¸ ë°œí–‰</button>
        <button class="act del" data-act="main_off">ë©”ì¸ ì‚­ì œ</button>
      </div>
    `;

    el.addEventListener('click', ()=> startEdit(it));
    el.querySelector('.r-del').addEventListener('click', (e)=>{
      e.stopPropagation();
      hideCard(it.id);
    });
    el.querySelectorAll('.r-actions .act').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const act = btn.dataset.act;
        if(act === 'main_on') publishToMain(it.id);
        if(act === 'main_off') removeFromMain(it.id);
      });
    });

    box.appendChild(el);
  });
}

/* XSS ë°©ì§€ */
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

/* í¸ì§‘ íë¦„ */
function startEdit(it){
  editingId = it.id;
  qs('#editId').textContent = editingId;
  qs('#editBanner').style.display='block';
  setForm(it);
}

/* ì´ˆê¸°í™” */
(async function init(){
  renderToggles('styleToggles', STYLE_OPTS, []);
  renderToggles('paceToggles',  PACE_OPTS,  []);
  qs('#c_datetime').value = toLocalDatetimeValue(new Date());
  attachAutoSplit('from_lat','from_lng'); attachAutoSplit('to_lat','to_lng');
  renderThemes('blue');

  const list = await loadFromServer();
  renderCards(list);

  const d = load(DRAFT_KEY,null); if(d){ setForm(d); }

  qs('#btnDraft').addEventListener('click', saveDraft);
  qs('#btnReset').addEventListener('click', resetForm);
  qs('#btnClearHidden').addEventListener('click', clearHidden);
  qs('#btnResync')?.addEventListener('click', ()=>{ fullResync().catch(()=>alert('ë™ê¸°í™” ì‹¤íŒ¨')); });

  qs('#goMain')?.addEventListener('click',(e)=>{
    if(!MAIN_URL){ e.preventDefault(); alert("MAIN_URLì„ ë©”ì¸ì£¼ì†Œë¡œ ì„¤ì •í•˜ì„¸ìš”."); return; }
    window.open(MAIN_URL,'_blank');
  });
})();
</script>
</body>
</html>
