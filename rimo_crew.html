<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì–´ë“œë¯¼ Â· í¬ë£¨ ìƒì„±</title>
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#232333;
    --tile:#141627; --tile2:#101223; --accent:#7aa7ff; --accent-glow: rgba(122,167,255,.35);
    /* í…Œë§ˆ ë³´ë”(í•„ ë°°ì§€ëŠ” ì•ˆ ë³´ì—¬ì¤Œ) */
    --t-red:#ff5d5d;      --t-red-br:rgba(255,93,93,.45);
    --t-blue:#7aa7ff;     --t-blue-br:rgba(122,167,255,.45);
    --t-yellow:#ffd85d;   --t-yellow-br:rgba(255,216,93,.48);
    --t-green:#56d364;    --t-green-br:rgba(86,211,100,.50);
    --t-purple:#a78bfa;   --t-purple-br:rgba(167,139,250,.52);

    /* í¼ ê·¸ë¦¬ë“œ ê³ ì • í­ */
    --label-w:56px; --label-gap:6px;
    --label-w-sm:44px; --label-gap-sm:4px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}

  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{font-weight:900;font-size:16px}
  .home-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:22px;border-radius:8px;border:none;background:transparent;color:#fff;cursor:pointer}
  .home-btn:hover{background:rgba(255,255,255,.08)}
  main{padding:16px;display:grid;gap:16px;max-width:980px;margin:0 auto;padding-bottom:120px}
  .panel{background:var(--tile);border:1px solid var(--line);border-radius:14px;padding:12px 14px 16px}

  /* í¼ ê·¸ë¦¬ë“œ */
  .row{display:grid;grid-template-columns:var(--label-w) 1fr;gap:var(--label-gap);align-items:center;margin:10px 0}
  .row.no-label{grid-template-columns:1fr}
  .row>label{font-weight:700;color:#cfd1e8;font-size:14px;justify-self:start;text-align:left;white-space:nowrap}
  .field{min-width:0}.field>*{width:100%}
  @media (max-width:560px){ .row{grid-template-columns:var(--label-w-sm) 1fr;gap:var(--label-gap-sm)} }

  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2c2f48;background:#0f1020;color:#fff;font-size:14px;transition:border-color .15s,box-shadow .15s}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow),0 0 0 1px var(--accent) inset}
  .row:has(input:focus),.row:has(select:focus),.row:has(textarea:focus)>label{color:#eef3ff}
  .coords{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  /* í† ê¸€ */
  .toggles{display:flex;gap:10px;flex-wrap:wrap;margin:0}
  .toggle{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:#14172a;border:1px solid #2b2e54;color:#e6e9ff;font-size:13px;cursor:pointer;user-select:none}
  .toggle.active{border-color:var(--accent);background:rgba(122,167,255,.16);box-shadow:0 0 10px var(--accent-glow);font-weight:600}

  /* í…Œë§ˆ ì„ íƒ(ë°°ì§€ë§Œ, ì¹´ë“œ ì•ˆì—ì„œëŠ” í…Œë§ˆ ë¼ë²¨ ë¯¸ë…¸ì¶œ) */
  .themes{display:flex;gap:8px;flex-wrap:wrap}
  .theme-btn{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:6px;padding:4px 8px;border-radius:16px;border:1px solid #2b2e48;background:#14172a;color:#e8e8ef;font-size:12px;cursor:pointer}
  .theme-btn .badge{width:14px;height:14px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#0f1020}
  .theme-btn.active{box-shadow:0 0 0 1px currentColor inset,0 0 10px currentColor}
  .theme-btn[data-theme="red"]{color:var(--t-red)}
  .theme-btn[data-theme="blue"]{color:var(--t-blue)}
  .theme-btn[data-theme="yellow"]{color:var(--t-yellow)}
  .theme-btn[data-theme="green"]{color:var(--t-green)}
  .theme-btn[data-theme="purple"]{color:var(--t-purple)}

  /* ë²„íŠ¼ */
  .btnbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b2e48;background:#1b1d2e;color:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:#2a5bff;border-color:#3d6aff}

  /* ====== ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼(ë©”ì¸ê³¼ ë™ì¼) ====== */
  .cards{display:grid;gap:12px}
  .card{
    border:1px solid var(--line); border-radius:14px; padding:14px;
    display:flex; flex-direction:column; gap:8px; background:#141628; cursor:pointer
  }
  .card h3{margin:0 0 4px 0;font-size:18px}
  .meta{font-size:14px;color:#bfc2dc}
  .msg{font-size:14px}
  .pillrow{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 9px;border-radius:999px;font-size:12px;font-weight:600;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e6e8ef}
  .chip.pill-urban{background:#1e2d55;border-color:#2c4484}
  .chip.pill-curve{background:#2a1f56;border-color:#40307a}
  .chip.pill-tour{background:#1e3b3a;border-color:#2f5f5d}
  .chip.pill-easy{background:#1f3a1f;border-color:#2f5a2f}
  .chip.pill-balanced{background:#3a341e;border-color:#5a4f2f}
  .chip.pill-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .route{display:flex;align-items:center;gap:8px;color:#e6e8ef}
  .pin{width:8px;height:8px;border-radius:999px;background:currentColor}
  .dash{flex:1;border-top:1px dashed currentColor;opacity:.6}

  /* ì¹´ë“œ ë³´ë” ìƒ‰(í…Œë§ˆ) */
  .card[data-theme="red"]{border-color:var(--t-red-br)}
  .card[data-theme="blue"]{border-color:var(--t-blue-br)}
  .card[data-theme="yellow"]{border-color:var(--t-yellow-br)}
  .card[data-theme="green"]{border-color:var(--t-green-br)}
  .card[data-theme="purple"]{border-color:var(--t-purple-br)}

  .edit-banner{margin:8px 0 0;color:#cfe0ff;font-size:12px}
  .btmnav{position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(11,11,15,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
  .btmnav .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;padding:8px}
  .navitem{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px 4px;border-radius:10px;border:1px solid #2b2e48;background:#14172a;cursor:pointer;font-size:12px;text-align:center;user-select:none;text-decoration:none;color:var(--fg)}
  .navitem.active{background:#27306a;border-color:#3a4aa2}
  .navitem .ico{font-size:18px;line-height:1}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ğŸï¸ RIMO â€” ì–´ë“œë¯¼ Â· í¬ë£¨ ìƒì„±</div>
    <button class="home-btn" id="goMain" title="ë©”ì¸ ì´ë™">ğŸ </button>
  </div>
</header>

<main>
  <section class="panel">
    <div id="editBanner" class="edit-banner" style="display:none">âœï¸ í˜„ì¬ <b id="editId"></b>ë¥¼ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤.</div>

    <div class="row"><label for="c_title">ì œëª©</label><div class="field"><input id="c_title" placeholder="ì˜ˆ: &lt;ê°€ì„ë§ì´ ì¹´í˜ ë¼ì´ë”©&gt;"></div></div>
    <div class="row"><label for="c_datetime">ì¼ì‹œ</label><div class="field"><input id="c_datetime" type="datetime-local" step="1800"></div></div>

    <div class="row">
      <label for="c_from">ì¶œë°œ</label>
      <div class="field">
        <input id="c_from" placeholder="ì˜ˆ: GS25 í•œê°•ë¥´ë„¤ìƒìŠ¤ ë°˜í¬2í˜¸">
        <div class="coords" style="margin-top:8px">
          <input id="from_lat" type="number" step="any" placeholder="ìœ„ë„" inputmode="decimal" min="-90" max="90">
          <input id="from_lng" type="number" step="any" placeholder="ê²½ë„" inputmode="decimal" min="-180" max="180">
        </div>
      </div>
    </div>

    <div class="row">
      <label for="c_to">ë„ì°©</label>
      <div class="field">
        <input id="c_to" placeholder="ì˜ˆ: RSG ì„±ìˆ˜">
        <div class="coords" style="margin-top:8px">
          <input id="to_lat" type="number" step="any" placeholder="ìœ„ë„" inputmode="decimal" min="-90" max="90">
          <input id="to_lng" type="number" step="any" placeholder="ê²½ë„" inputmode="decimal" min="-180" max="180">
        </div>
      </div>
    </div>

    <div class="row"><label>ì¸ì›</label><div class="field"><div class="coords"><input id="c_remaining" type="number" min="0" placeholder="ì”ì—¬"><input id="c_capacity" type="number" min="1" placeholder="ì •ì›"></div></div></div>

    <div class="row">
      <label for="c_cc">ë°°ê¸°ëŸ‰</label>
      <div class="field">
        <select id="c_cc">
          <option value="">ê´€ê³„ì—†ìŒ</option><option>125cc ì´í•˜</option><option>125~250</option>
          <option>250~400</option><option>400~800</option><option>800 ì´ìƒ</option>
        </select>
      </div>
    </div>

    <div class="row"><label>ìŠ¤íƒ€ì¼</label><div class="field"><div id="styleToggles" class="toggles"></div></div></div>
    <div class="row"><label>í˜ì´ìŠ¤</label><div class="field"><div id="paceToggles" class="toggles"></div></div></div>

    <div class="row"><label for="c_msg">ë©”ì‹œì§€</label><div class="field"><input id="c_msg" maxlength="30" placeholder="30ì ì´ë‚´"></div></div>

    <div class="row no-label"><div class="field"><div id="themeBar" class="themes"></div></div></div>

    <div class="btnbar">
      <button class="btn" id="btnDraft">ë“œë˜í”„íŠ¸ ì €ì¥</button>
      <button class="btn primary" id="btnSave">ë©”ì¸ì— ë°œí–‰</button>
      <button class="btn" id="btnReset">ìƒˆë¡œ ì‘ì„±</button>
    </div>
  </section>

  <section class="panel" id="cardsPanel">
    <h3 style="margin:0 0 8px 0;font-size:16px;">ë°œí–‰ëœ ë¼ì´ë”© ì¹´ë“œ ëª©ë¡</h3>
    <div id="cards" class="cards"></div>
  </section>
</main>

<nav class="btmnav" aria-label="í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜">
  <div class="wrap">
    <a class="navitem active" href="rimo_crew.html" title="í¬ë£¨ ìƒì„±"><div class="ico">ğŸ› ï¸</div><div>í¬ë£¨ ìƒì„±</div></a>
    <a class="navitem" href="rimo_joins.html"  title="ë§¤ì¹­ í¬ë§"><div class="ico">ğŸ¤</div><div>ë§¤ì¹­ í¬ë§</div></a>
    <a class="navitem" href="rimo_routes.html" title="ë£¨íŠ¸ ì œì•ˆ"><div class="ico">ğŸ—ºï¸</div><div>ë£¨íŠ¸ ì œì•ˆ</div></a>
    <a class="navitem" href="rimo_feedback.html" title="í›„ê¸° ëª¨ìŒ"><div class="ico">ğŸ“</div><div>í›„ê¸° ëª¨ìŒ</div></a>
    <a class="navitem" href="rimo_data.html" title="ìë£Œ ê´€ë¦¬"><div class="ico">ğŸ—„ï¸</div><div>ìë£Œ ê´€ë¦¬</div></a>
  </div>
</nav>

<script>
/* ===== ìƒìˆ˜ ===== */
const MAIN_URL   = "https://roowalix.github.io/RIMO-test/index.html";
const WEB_APP_URL= "https://script.google.com/macros/s/AKfycbw7jNF2Qk0IqOSQhsGPJW5I7ifiSNl74FyNRTdHvi9jXikDDZAM19RG6zwNMakwPukn9w/exec";
const DRAFT_KEY  = "rimo_create_draft_v6";
const CACHE_KEY  = "rimo_published_cards_server_cache";
let editingId    = null;

/* ì˜µì…˜ */
const STYLE_OPTS=["Urban","Curve","Tour"];
const PACE_OPTS =["Easy","Balanced","Dynamic"];
const THEME_OPTS=[
  {key:"blue",label:"ë¸”ë£¨",emoji:"ğŸ”µ"},
  {key:"yellow",label:"ì˜ë¡œ",emoji:"ğŸŸ¡"},
  {key:"green",label:"ê·¸ë¦°",emoji:"ğŸŸ¢"},
  {key:"purple",label:"í¼í”Œ",emoji:"ğŸŸ£"},
  {key:"red",label:"ë ˆë“œ",emoji:"ğŸ”´"}
];

/* ìœ í‹¸ */
const qs=(s,p=document)=>p.querySelector(s);
const qsa=(s,p=document)=>Array.from(p.querySelectorAll(s));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,def)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch(e){return def}};

function pad(n){return String(n).padStart(2,'0')}
function toLocalDatetimeValue(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function formatKDate(dt){return `${dt.getMonth()+1}ì›” ${dt.getDate()}ì¼ ${pad(dt.getHours())}:${pad(dt.getMinutes())}`}

/* ë°°ì—´/ë¬¸ì íŒŒì„œ(ì„œë²„ì—ì„œ [Ljava... ë¬¸ì œ í¬í•¨ ë°©ì–´) */
function toList(v){
  if (v==null) return [];
  if (Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean);
  const s=String(v).trim();
  if (!s) return [];
  if (/^\[Ljava\.lang\.Object;/.test(s)) return []; // ì´ìƒ ë¬¸ìì—´ì€ ë¬´ì‹œ
  try{ const j=JSON.parse(s); if(Array.isArray(j)) return j.map(x=>String(x).trim()).filter(Boolean); }catch(_){}
  return s.split(/[,\|/Â·]/).map(x=>x.trim()).filter(Boolean);
}

/* í† ê¸€/í…Œë§ˆ */
function makeToggle(label,active=false){ const b=document.createElement('button'); b.type='button'; b.className='toggle'+(active?' active':''); b.dataset.val=label; b.textContent=label; b.onclick=()=>b.classList.toggle('active'); return b; }
function renderToggles(id,opts,sel=[]){ const box=qs('#'+id); box.innerHTML=''; opts.forEach(o=>box.appendChild(makeToggle(o, (sel||[]).includes(o)))); }
function selectedToggles(id){ return qsa('#'+id+' .toggle.active').map(el=>el.dataset.val); }
function renderThemes(selected='blue'){
  const bar=qs('#themeBar'); bar.innerHTML='';
  THEME_OPTS.forEach(opt=>{
    const btn=document.createElement('button');
    btn.type='button'; btn.className='theme-btn'+(opt.key===selected?' active':''); btn.dataset.theme=opt.key;
    btn.innerHTML=`<span class="badge">${opt.emoji}</span><span>${opt.label}</span>`;
    btn.onclick=()=>{ qsa('.theme-btn',bar).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
    bar.appendChild(btn);
  });
}
function getSelectedTheme(){ return qs('#themeBar .theme-btn.active')?.dataset.theme || 'blue'; }

/* ì¢Œí‘œ ë¶™ì—¬ë„£ê¸° íŒŒì„œ */
function extractCoords(text){
  if(!text) return null;
  let m=String(text).trim().match(/@(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/) ||
         String(text).trim().match(/[?&]q=(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)/);
  if(!m){ const nums=String(text).match(/-?\d+(?:\.\d+)?/g); if(nums?.length>=2) m=[,nums[0],nums[1]]; }
  if(!m) return null; let lat=+m[1], lng=+m[2]; if(Math.abs(lat)>90 && Math.abs(lng)<=90){[lat,lng]=[lng,lat]} ; if(Math.abs(lat)>90||Math.abs(lng)>180) return null; return {lat,lng};
}
function attachAutoSplit(latId,lngId){
  const lat=qs('#'+latId), lng=qs('#'+lngId);
  const onPaste=e=>{ const c=extractCoords(e.clipboardData?.getData('text')); if(c){ e.preventDefault(); lat.value=c.lat; lng.value=c.lng; } };
  const onChange=e=>{ const c=extractCoords(e.target.value); if(c){ lat.value=c.lat; lng.value=c.lng; } };
  lat.addEventListener('paste',onPaste); lng.addEventListener('paste',onPaste);
  lat.addEventListener('change',onChange); lng.addEventListener('change',onChange);
}

/* í¼ ìˆ˜ì§‘/ì„¸íŒ… */
function getForm(){
  const dt = (function(){ const v=qs('#c_datetime').value; if(!v) return null; const [d,t]=v.split('T'); if(!d||!t) return null; const [Y,M,D]=d.split('-').map(Number); const [h,m]=t.split(':').map(Number); return new Date(Y,M-1,D,h,m||0,0); })() || new Date();
  return {
    id: editingId || '',
    title: qs('#c_title').value.trim(),
    datetime: dt.toISOString(),
    datetime_display: formatKDate(dt),
    from: qs('#c_from').value.trim(),
    to: qs('#c_to').value.trim(),
    from_lat: parseFloat(qs('#from_lat').value||''),
    from_lng: parseFloat(qs('#from_lng').value||''),
    to_lat: parseFloat(qs('#to_lat').value||''),
    to_lng: parseFloat(qs('#to_lng').value||''),
    cc: qs('#c_cc').value,
    styles: selectedToggles('styleToggles'),
    pace: selectedToggles('paceToggles'),
    message: qs('#c_msg').value.trim(),
    remaining: parseInt(qs('#c_remaining').value||'0',10),
    capacity: parseInt(qs('#c_capacity').value||'0',10),
    theme: getSelectedTheme()
  };
}
function setForm(it){
  qs('#c_title').value = it.title||'';
  qs('#c_from').value  = it.from||'';
  qs('#c_to').value    = it.to||'';
  qs('#from_lat').value= it.from_lat??'';
  qs('#from_lng').value= it.from_lng??'';
  qs('#to_lat').value  = it.to_lat??'';
  qs('#to_lng').value  = it.to_lng??'';
  qs('#c_cc').value    = it.cc||'';
  qs('#c_msg').value   = it.message||'';
  qs('#c_remaining').value = it.remaining ?? '';
  qs('#c_capacity').value  = it.capacity ?? '';
  const dt = it.datetime ? new Date(it.datetime) : new Date();
  qs('#c_datetime').value = toLocalDatetimeValue(dt);
  renderToggles('styleToggles', STYLE_OPTS, toList(it.styles));
  renderToggles('paceToggles',  PACE_OPTS,  toList(it.pace));
  renderThemes(it.theme || 'blue');
}

/* ìœ íš¨ì„± */
function validate(form){
  const errs=[];
  if(!form.title) errs.push('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!qs('#c_datetime').value) errs.push('ì¼ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if(!form.from) errs.push('ì¶œë°œì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!form.to) errs.push('ë„ì°©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  if(!(form.capacity>0)) errs.push('ì •ì›ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(form.remaining<0) errs.push('ì”ì—¬ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  if(form.remaining>form.capacity) errs.push('ì”ì—¬ê°€ ì •ì›ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(form.message.length>30) errs.push('ë©”ì‹œì§€ëŠ” 30ì ì´ë‚´ì…ë‹ˆë‹¤.');
  return errs;
}

/* ì„œë²„ I/O */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now();
    const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadFromServer(){
  let cached=load(CACHE_KEY,[]);
  if(cached.length) renderCards(cached);
  try{
    const r=await fetch(WEB_APP_URL+'?op=list&_='+Date.now(),{cache:'no-store'});
    if(r.ok){ const j=await r.json(); const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
      save(CACHE_KEY,rows); return rows; }
  }catch(_){}
  try{ const j=await fetchJSONP(WEB_APP_URL+'?op=list'); const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]); if(rows.length){ save(CACHE_KEY,rows); return rows; } }catch(_){}
  return cached;
}
async function sendToSheet(form, op){
  const p=new URLSearchParams();
  p.set('op',op); p.set('record',JSON.stringify(form));
  try{ await fetch(WEB_APP_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()}); }catch(_){}
}

/* ì €ì¥/ìˆ˜ì • */
function saveDraft(){ save(DRAFT_KEY, getForm()); alert('ë“œë˜í”„íŠ¸ ì €ì¥ ì™„ë£Œ'); }
async function saveOrPublish(){
  const form=getForm(); const errs=validate(form); if(errs.length){ alert(errs.join('\n')); return; }
  let list=load(CACHE_KEY,[]);
  if(!editingId){ form.id=`crew_${Date.now().toString(36)}`; await sendToSheet(form,'publish'); list.unshift(form); }
  else{ form.id=editingId; await sendToSheet(form,'update'); const i=list.findIndex(x=>x.id===editingId); if(i>=0) list[i]=form; else list.unshift(form); exitEditMode(); }
  save(CACHE_KEY,list); renderCards(list); save(DRAFT_KEY,form);
  qs('#cardsPanel').scrollIntoView({behavior:'smooth',block:'start'});
  alert('ì„œë²„ì— ë°˜ì˜ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.');
}
function startEdit(it){ editingId=it.id; qs('#editId').textContent=editingId; qs('#editBanner').style.display='block'; qs('#btnSave').textContent='ë³€ê²½ ì €ì¥'; setForm(it); }
function exitEditMode(){ editingId=null; qs('#editBanner').style.display='none'; qs('#editId').textContent=''; qs('#btnSave').textContent='ë©”ì¸ì— ë°œí–‰'; }
function resetForm(){ localStorage.removeItem(DRAFT_KEY); location.reload(); }

/* ì¹´ë“œ ë Œë”(ê³µí†µ ìŠ¤íƒ€ì¼) */
function chipClass(v){ switch(String(v).toLowerCase()){ case 'urban':return 'pill-urban'; case 'curve':return 'pill-curve'; case 'tour':return 'pill-tour'; case 'easy':return 'pill-easy'; case 'balanced':return 'pill-balanced'; case 'dynamic':return 'pill-dynamic'; default:return ''; } }
function chip(v){ return `<span class="chip ${chipClass(v)}">${v}</span>`; }
function normalizeRow(it){
  return {
    id: it.id || `id_${Math.random().toString(36).slice(2,8)}`,
    title: it.title||'(ì œëª© ì—†ìŒ)',
    datetime: it.datetime || it.date || '',
    datetime_display: it.datetime_display || (it.datetime?formatKDate(new Date(it.datetime)): ''),
    from: it.from||'-', to: it.to||'-',
    from_lat: +it.from_lat||null, from_lng:+it.from_lng||null, to_lat:+it.to_lat||null, to_lng:+it.to_lng||null,
    cc: it.cc||'',
    styles: toList(it.styles),
    pace: toList(it.pace),
    message: it.message||'',
    remaining: Number.isFinite(+it.remaining)? +it.remaining : 0,
    capacity:  Number.isFinite(+it.capacity)?  +it.capacity  : 0,
    theme: it.theme||'blue'
  };
}
function renderCards(list){
  const box=qs('#cards'); box.innerHTML='';
  if(!list || !list.length){ box.innerHTML='<div class="meta">ì•„ì§ ë°œí–‰ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  list.map(normalizeRow).forEach(it=>{
    const joined = Math.max(0,(it.capacity||0)-(it.remaining||0));
    const el=document.createElement('article');
    el.className='card'; el.dataset.theme=it.theme; el.dataset.id=it.id;
    el.innerHTML=`
      <h3>${it.title}</h3>
      <div class="meta">â° ${it.datetime_display || (it.datetime?formatKDate(new Date(it.datetime)):'')}</div>
      <div class="route"><span class="pin"></span><span>${it.from}</span><span class="dash"></span><span class="pin"></span><span>${it.to}</span></div>
      ${it.message?`<div class="msg">ğŸ’¬ ${it.message}</div>`:''}
      <div class="pillrow">
        ${toList(it.styles).map(chip).join('')}
        ${toList(it.pace).map(chip).join('')}
        ${it.cc?chip(it.cc):''}
      </div>
      <div class="meta">ğŸ‘¥ ${joined}/${it.capacity||0}</div>
    `;
    el.onclick=()=>startEdit(it);
    box.appendChild(el);
  });
}

/* init */
(async function init(){
  renderToggles('styleToggles',STYLE_OPTS,[]);
  renderToggles('paceToggles', PACE_OPTS, []);
  qs('#c_datetime').value = toLocalDatetimeValue(new Date());
  attachAutoSplit('from_lat','from_lng'); attachAutoSplit('to_lat','to_lng');
  renderThemes('blue');

  const list = await loadFromServer(); renderCards(list);
  const d=load(DRAFT_KEY,null); if(d) setForm(d);

  qs('#btnDraft').onclick=saveDraft; qs('#btnSave').onclick=saveOrPublish; qs('#btnReset').onclick=resetForm;
  qs('#goMain').onclick=()=>window.open(MAIN_URL,'_blank');
})();
</script>
</body>
</html>
