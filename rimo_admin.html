<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 관리자 미니페이지</title>
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#232333;
    --tile:#141627; --tile2:#101223; --accent:#7aa7ff; --good:#2aa84a; --bad:#ff5d5d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px}
  .title{font-weight:900}
  .tabs{display:flex;gap:8px;margin-left:auto}
  .tab{padding:8px 12px;border-radius:10px;background:#1b1d2e;border:1px solid #2b2e48;cursor:pointer;white-space:nowrap}
  .tab.active{background:#27306a;border-color:#3a4aa2}

  main{padding:16px;display:grid;gap:16px;max-width:980px;margin:0 auto;padding-bottom:90px}
  .panel{background:var(--tile);border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:16px}
  .grid{display:grid;gap:12px}
  .grid.cols2{grid-template-columns:1fr 1fr}
  @media (max-width:820px){
    .grid.cols2{grid-template-columns:1fr}
  }
  .row{display:flex;gap:10px;align-items:center}
  .row label{width:120px;color:#cfd1e8;font-weight:700}
  .row .field{flex:1}
  input,select,textarea{
    width:100%;padding:10px 12px;border-radius:8px;border:1px solid #2c2f48;background:#0f1020;color:#fff;font-size:14px
  }
  textarea{min-height:72px;resize:vertical}
  .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #2b2e48;background:#1b1d2e;color:#fff;cursor:pointer}
  .btn.primary{background:#2a5bff;border-color:#3d6aff}
  .btn.good{background:var(--good);border-color:#2a8d41}
  .btn.warn{background:#7a2a2a;border-color:#a23d3d}
  .btn.ghost{background:#121428}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{background:var(--tile2);border:1px solid #23263f;border-radius:12px;padding:12px}
  .mini{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1a1c2f;border:1px solid #2b2e54;font-size:12px}
  .line{height:1px;background:#23263f;margin:10px 0}
  .hint{color:#cdd0f6;font-size:13px}
  .kbd{background:#191b2d;border:1px solid #2b2e54;border-radius:6px;padding:2px 6px}

  /* 하단 네비게이션 */
  .btmnav{
    position:fixed;left:0;right:0;bottom:0;z-index:10;
    background:rgba(11,11,15,.9);backdrop-filter:blur(10px);
    border-top:1px solid var(--line);
  }
  .btmnav .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:8px}
  .navitem{
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:4px;padding:8px 4px;border-radius:10px;border:1px solid #2b2e48;background:#14172a;cursor:pointer;font-size:12px;text-align:center;
  }
  .navitem.active{background:#27306a;border-color:#3a4aa2}
  .navitem .ico{font-size:18px;line-height:1}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">🏍️ RIMO — 관리자 미니페이지</div>
    <div class="tabs">
      <!-- 상단 탭도 동일한 명칭으로 맞춤 -->
      <div class="tab active" data-tab="create">크루 생성</div>
      <div class="tab" data-tab="joins">매칭 관리</div>
      <div class="tab" data-tab="routes">루트 제안</div>
      <div class="tab" data-tab="feedback">후기 관리</div>
      <div class="tab" data-tab="data">DB관리</div>
    </div>
  </div>
</header>

<main>
  <!-- 크루 생성 -->
  <section class="panel" data-page="create">
    <h3>크루 생성</h3>
    <div class="grid cols2">
      <div class="panel" style="background:#101223">
        <div class="row"><label>제목</label><div class="field"><input id="c_title" placeholder="예: &lt;가을맞이 카페 라이딩&gt;"></div></div>
        <div class="row"><label>출발 일시</label><div class="field"><input id="c_time" type="text" placeholder="예: 9월 20일 23:00"></div></div>
        <div class="row"><label>출발지</label><div class="field"><input id="c_from" placeholder="예: GS25 한강르네상스 반포2호"></div></div>
        <div class="row"><label>도착지</label><div class="field"><input id="c_to" placeholder="예: RSG 성수"></div></div>
        <div class="row"><label>정원</label><div class="field"><input id="c_capacity" type="number" min="1" value="4"></div></div>
        <div class="row"><label>스타일/페이스</label>
          <div class="field"><input id="c_styles" placeholder="예: Urban, Easy"></div>
        </div>
        <div class="row"><label>배기량</label><div class="field"><input id="c_cc" placeholder="예: 400cc 이상"></div></div>
        <div class="row"><label>메시지</label><div class="field"><textarea id="c_msg" placeholder="간단한 안내/분위기"></textarea></div></div>
        <div class="row"><label>테마</label>
          <div class="field">
            <select id="c_theme">
              <option value="red">red</option>
              <option value="yellow">yellow</option>
              <option value="blue" selected>blue</option>
            </select>
          </div>
        </div>
      </div>

      <div class="panel" style="background:#101223">
        <div class="row"><label>출발 위도</label><div class="field"><input id="c_lat" type="number" step="0.000001" placeholder="37.xxxxxx"></div></div>
        <div class="row"><label>출발 경도</label><div class="field"><input id="c_lng" type="number" step="0.000001" placeholder="126.xxxxxx"></div></div>
        <div class="row"><label>도착 위도</label><div class="field"><input id="c_toLat" type="number" step="0.000001" placeholder="37.xxxxxx"></div></div>
        <div class="row"><label>도착 경도</label><div class="field"><input id="c_toLng" type="number" step="0.000001" placeholder="127.xxxxxx"></div></div>
        <div class="row"><label>현재/정원</label><div class="field"><input id="c_now" type="number" min="0" value="0"></div></div>
        <div class="btnbar">
          <button class="btn" id="btnDraft">드래프트 저장</button>
          <button class="btn primary" id="btnPublish">메인에 발행</button>
          <button class="btn ghost" id="btnNew">새로 작성</button>
        </div>
        <div class="hint">※ 좌표는 지도에 필요합니다. 모르면 임시로 출발/도착만 입력해두고 나중에 보정해도 됩니다.</div>
      </div>
    </div>

    <div class="panel">
      <h3>발행된 크루 목록</h3>
      <div id="pubList" class="list"></div>
    </div>
  </section>

  <!-- 매칭 관리 -->
  <section class="panel" data-page="joins" style="display:none">
    <h3>매칭 관리 (함께 타고 싶어요)</h3>
    <div class="hint">메인 페이지에서 “이대로 신청하기” 시 <span class="kbd">localStorage</span>에 저장됩니다.</div>
    <div class="row" style="margin-top:8px">
      <label>필터(크루ID)</label>
      <div class="field"><input id="f_joinCrewId" placeholder="빈칸=전체"></div>
      <button class="btn" id="btnJoinFilter">필터</button>
    </div>
    <div id="joinList" class="list" style="margin-top:10px"></div>
  </section>

  <!-- 루트 제안 -->
  <section class="panel" data-page="routes" style="display:none">
    <h3>루트 제안</h3>
    <div class="grid cols2">
      <div class="panel" style="background:#101223">
        <div class="row"><label>제안자</label><div class="field"><input id="r_who" placeholder="닉네임"></div></div>
        <div class="row"><label>출발지</label><div class="field"><input id="r_from"></div></div>
        <div class="row"><label>도착지</label><div class="field"><input id="r_to"></div></div>
        <div class="row"><label>메모</label><div class="field"><textarea id="r_note" placeholder="이유/요청 페이스 등"></textarea></div></div>
        <div class="btnbar"><button class="btn" id="btnRouteAdd">제안 저장</button></div>
      </div>
      <div class="panel" style="background:#101223">
        <div class="row"><label>스타일/페이스</label><div class="field"><input id="r_tags" placeholder="예: Urban, Easy"></div></div>
        <div class="row"><label>우선순위</label><div class="field"><select id="r_priority">
          <option>보통</option><option>높음</option><option>낮음</option></select></div></div>
        <div class="hint">저장된 제안을 아래 목록에서 “드래프트로 전송”하면 좌측 생성폼에 자동 채움됩니다.</div>
      </div>
    </div>

    <div class="panel">
      <h3>저장된 제안 목록</h3>
      <div id="routeList" class="list"></div>
    </div>
  </section>

  <!-- 후기 관리 -->
  <section class="panel" data-page="feedback" style="display:none">
    <h3>후기 관리 (라이딩 종료 후 피드백)</h3>
    <div class="grid cols2">
      <div class="panel" style="background:#101223">
        <div class="row"><label>크루ID</label><div class="field"><input id="fb_crewId" placeholder="예: crew1"></div></div>
        <div class="row"><label>평가</label><div class="field"><select id="fb_vote"><option value="up">추천 👍</option><option value="down">비추천 👎</option></select></div></div>
        <div class="row"><label>사유</label><div class="field"><textarea id="fb_reason" placeholder="간단 코멘트"></textarea></div></div>
        <div class="btnbar"><button class="btn good" id="btnFbSave">피드백 저장</button></div>
      </div>
      <div class="panel" style="background:#101223">
        <div class="row"><label>필터(크루ID)</label><div class="field"><input id="f_fbCrewId" placeholder="빈칸=전체"></div></div>
        <div class="btnbar"><button class="btn" id="btnFbFilter">조회</button></div>
        <div id="fbList" class="list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

  <!-- DB관리 -->
  <section class="panel" data-page="data" style="display:none">
    <h3>DB관리 (데이터 내보내기 / 가져오기)</h3>
    <div class="btnbar">
      <button class="btn" id="btnExport">전체 JSON 내보내기</button>
      <label class="btn">
        JSON 불러오기
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </label>
      <button class="btn warn" id="btnReset">전체 초기화</button>
    </div>
    <div class="line"></div>
    <div class="hint">
      사용 키: <span class="kbd">rimo_crews_v1</span>, <span class="kbd">rimo_applications_v1</span>,
      <span class="kbd">rimo_route_proposals_v1</span>, <span class="kbd">rimo_feedback_v1</span>
    </div>
  </section>
</main>

<!-- 하단 6개 네비 -->
<nav class="btmnav">
  <div class="wrap">
    <div class="navitem active" data-go="create" title="크루 생성">
      <div class="ico">🛠️</div><div>크루 생성</div>
    </div>
    <div class="navitem" data-go="joins" title="매칭 관리">
      <div class="ico">🤝</div><div>매칭 관리</div>
    </div>
    <div class="navitem" data-go="routes" title="루트 제안">
      <div class="ico">🗺️</div><div>루트 제안</div>
    </div>
    <div class="navitem" data-go="feedback" title="후기 관리">
      <div class="ico">📝</div><div>후기 관리</div>
    </div>
    <div class="navitem" data-go="data" title="DB관리">
      <div class="ico">🗄️</div><div>DB관리</div>
    </div>
    <a class="navitem" id="goMain" href="#" target="_blank" rel="noopener" title="메인 이동">
      <div class="ico">🏠</div><div>메인 이동</div>
    </a>
  </div>
</nav>

<script>
/* ---------- config ---------- */
const MAIN_URL = "https://roowalix.github.io/RIMO-test/index.html"; // TODO: RIMO 메인페이지 URL로 교체하세요.

/* ---------- storage helpers ---------- */
const KEYS={
  crews:'rimo_crews_v1',
  apps:'rimo_applications_v1',
  routes:'rimo_route_proposals_v1',
  fb:'rimo_feedback_v1',
};
const load=(k,def)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def))}catch(e){return def}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=> 'crew'+Math.random().toString(36).slice(2,7);

/* ---------- page switch (tabs + bottom nav 공통) ---------- */
function showPage(pageKey){
  document.querySelectorAll('[data-page]').forEach(p=>p.style.display = (p.dataset.page===pageKey)?'block':'none');
  // header tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===pageKey);
  });
  // bottom nav
  document.querySelectorAll('.btmnav .navitem').forEach(n=>{
    if(n.dataset.go){ n.classList.toggle('active', n.dataset.go===pageKey); }
  });
}
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=> showPage(t.dataset.tab);
});
document.querySelectorAll('.btmnav .navitem[data-go]').forEach(n=>{
  n.addEventListener('click', ()=> showPage(n.dataset.go));
});
document.getElementById('goMain').addEventListener('click', (e)=>{
  const a=e.currentTarget;
  if(!MAIN_URL || MAIN_URL==="#"){ e.preventDefault(); alert("MAIN_URL을 메인페이지 주소로 교체하세요."); return; }
  a.href = MAIN_URL;
});

/* ---------- publish list ---------- */
function renderPublished(){
  const list = document.getElementById('pubList');
  const crews = load(KEYS.crews,[]);
  list.innerHTML = crews.map(c=>`
    <div class="item">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div><b>${c.title}</b> <span class="mini">(${c.id})</span></div>
          <div class="mini">⏰ ${c.time} · 📍 ${c.from} → ${c.to} · 👥 ${c.peopleNow||0}/${c.peopleMax}</div>
          <div class="mini">🎯 ${((c.styles||[]).join(' · '))||'-'} · ${c.cc||'-'}</div>
        </div>
        <div class="btnbar">
          <button class="btn" onclick='fillForm(${JSON.stringify(c)})'>불러오기</button>
          <button class="btn warn" onclick='removeCrew("${c.id}")'>삭제</button>
        </div>
      </div>
    </div>
  `).join('') || '<div class="mini">발행된 크루가 없습니다.</div>';
}
function removeCrew(id){
  let crews = load(KEYS.crews,[]);
  crews = crews.filter(c=>c.id!==id);
  save(KEYS.crews,crews);
  renderPublished();
}

/* ---------- form helpers ---------- */
function getForm(){
  const styles = (document.getElementById('c_styles').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  return {
    id: document.getElementById('c_id')?.value || uid(),
    theme: document.getElementById('c_theme').value,
    title: document.getElementById('c_title').value,
    time: document.getElementById('c_time').value,
    from: document.getElementById('c_from').value,
    to: document.getElementById('c_to').value,
    lat: parseFloat(document.getElementById('c_lat').value),
    lng: parseFloat(document.getElementById('c_lng').value),
    toLat: parseFloat(document.getElementById('c_toLat').value),
    toLng: parseFloat(document.getElementById('c_toLng').value),
    peopleNow: parseInt(document.getElementById('c_now').value||'0',10),
    peopleMax: parseInt(document.getElementById('c_capacity').value||'0',10),
    styles: styles,
    cc: document.getElementById('c_cc').value,
    msg: document.getElementById('c_msg').value
  };
}
function setForm(c){
  document.getElementById('c_title').value=c.title||'';
  document.getElementById('c_time').value=c.time||'';
  document.getElementById('c_from').value=c.from||'';
  document.getElementById('c_to').value=c.to||'';
  document.getElementById('c_capacity').value=c.peopleMax||4;
  document.getElementById('c_styles').value=(c.styles||[]).join(', ');
  document.getElementById('c_cc').value=c.cc||'';
  document.getElementById('c_msg').value=c.msg||'';
  document.getElementById('c_theme').value=c.theme||'blue';
  document.getElementById('c_lat').value = (c.lat??'');
  document.getElementById('c_lng').value = (c.lng??'');
  document.getElementById('c_toLat').value = (c.toLat??'');
  document.getElementById('c_toLng').value = (c.toLng??'');
  document.getElementById('c_now').value = c.peopleNow||0;

  if(!document.getElementById('c_id')){
    const hidden=document.createElement('input');
    hidden.type='hidden'; hidden.id='c_id'; hidden.value=c.id||uid();
    document.body.appendChild(hidden);
  }else{
    document.getElementById('c_id').value=c.id||uid();
  }
}
function clearForm(){
  setForm({id:uid(),theme:'blue',peopleMax:4,peopleNow:0});
  document.getElementById('c_styles').value='';
}

/* draft/publish */
document.getElementById('btnDraft').onclick=()=>{
  const draft=getForm();
  localStorage.setItem('rimo_draft_card',JSON.stringify(draft));
  alert('드래프트 저장 완료');
};
document.getElementById('btnPublish').onclick=()=>{
  const card=getForm();
  if(!card.title || !card.time || !card.from || !card.to){
    alert('제목/시간/출발/도착은 필수입니다.'); return;
  }
  const crews=load(KEYS.crews,[]);
  const idx=crews.findIndex(x=>x.id===card.id);
  if(idx>=0) crews[idx]=card; else crews.push(card);
  save(KEYS.crews,crews);
  renderPublished();
  alert('메인에 발행되었습니다!');
};
document.getElementById('btnNew').onclick=()=>{ clearForm(); };

/* route proposals */
document.getElementById('btnRouteAdd').onclick=()=>{
  const r={ id:'rt'+Math.random().toString(36).slice(2,7),
    who:val('r_who'), from:val('r_from'), to:val('r_to'),
    note:val('r_note'), tags:val('r_tags'), priority:val('r_priority'), ts:Date.now()
  };
  const routes=load(KEYS.routes,[]);
  routes.unshift(r); save(KEYS.routes,routes); renderRoutes(); clearRouteForm();
};
function clearRouteForm(){['r_who','r_from','r_to','r_note','r_tags'].forEach(id=>document.getElementById(id).value='');}
function val(id){return document.getElementById(id).value||'';}
function renderRoutes(){
  const list=document.getElementById('routeList');
  const routes=load(KEYS.routes,[]);
  list.innerHTML = routes.map(r=>`
    <div class="item">
      <div><b>${r.from} → ${r.to}</b> <span class="mini">(${r.id}) · ${r.priority}</span></div>
      <div class="mini">제안: ${r.who||'-'} | 태그: ${r.tags||'-'}</div>
      <div class="mini">${r.note||''}</div>
      <div class="btnbar">
        <button class="btn" onclick='toDraftFromRoute("${r.id}")'>드래프트로 전송</button>
        <button class="btn warn" onclick='removeRoute("${r.id}")'>삭제</button>
      </div>
    </div>
  `).join('') || '<div class="mini">등록된 제안이 없습니다.</div>';
}
function toDraftFromRoute(id){
  const routes=load(KEYS.routes,[]);
  const r=routes.find(x=>x.id===id); if(!r) return;
  // 제안 → 생성 폼 자동 채움
  setForm({
    id: uid(),
    theme:'blue',
    title:`<루트 제안> ${r.from}→${r.to}`,
    time:'',
    from:r.from, to:r.to,
    peopleMax:4, peopleNow:0,
    styles:(r.tags||'').split(',').map(s=>s.trim()).filter(Boolean),
    cc:'', msg:r.note||'',
  });
  alert('생성 폼에 불러왔습니다. 세부 정보 입력 후 발행하세요.');
}
function removeRoute(id){
  let routes=load(KEYS.routes,[]);
  routes=routes.filter(x=>x.id!==id); save(KEYS.routes,routes); renderRoutes();
}

/* joins (applications) */
function renderJoins(filterId=''){
  const list=document.getElementById('joinList');
  const apps=load(KEYS.apps,[]);
  const data = filterId ? apps.filter(a=>a.crewId===filterId) : apps;
  list.innerHTML = data.map(a=>`
    <div class="item">
      <div class="mini">${new Date(a.ts).toLocaleString()}</div>
      <div><b>${a.title}</b> <span class="mini">(${a.crewId})</span></div>
      <div class="mini">${a.from} → ${a.to}</div>
      <div class="line"></div>
      <div style="white-space:pre-wrap">${a.text}</div>
    </div>
  `).join('') || '<div class="mini">아직 신청이 없습니다.</div>';
}
document.getElementById('btnJoinFilter').onclick=()=>{
  const v=document.getElementById('f_joinCrewId').value.trim();
  renderJoins(v);
}

/* feedback */
document.getElementById('btnFbSave').onclick=()=>{
  const fb=load(KEYS.fb,[]);
  const item={
    id:'fb'+Math.random().toString(36).slice(2,7),
    crewId: document.getElementById('fb_crewId').value.trim(),
    vote: document.getElementById('fb_vote').value,
    reason: document.getElementById('fb_reason').value.trim(),
    ts: Date.now()
  };
  if(!item.crewId){ alert('크루ID는 필수'); return; }
  fb.unshift(item); save(KEYS.fb,fb); alert('저장됨'); renderFb();
};
function renderFb(filterId=''){
  const list=document.getElementById('fbList');
  const fb=load(KEYS.fb,[]);
  const data=filterId ? fb.filter(x=>x.crewId===filterId) : fb;
  list.innerHTML = data.map(x=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <div><b>${x.crewId}</b> · <span class="mini">${new Date(x.ts).toLocaleString()}</span></div>
        <div class="pill" style="background:${x.vote==='up'?'#17331f':'#331717'};border-color:${x.vote==='up'?'#2f5a2f':'#5a2f2f'}">
          ${x.vote==='up'?'👍 추천':'👎 비추천'}
        </div>
      </div>
      <div class="mini" style="margin-top:6px;white-space:pre-wrap">${x.reason||''}</div>
    </div>
  `).join('') || '<div class="mini">피드백이 없습니다.</div>';
}
document.getElementById('btnFbFilter').onclick=()=>{
  const v=document.getElementById('f_fbCrewId').value.trim();
  renderFb(v);
}

/* data export/import/reset */
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify({
    crews:load(KEYS.crews,[]),
    apps:load(KEYS.apps,[]),
    routes:load(KEYS.routes,[]),
    feedback:load(KEYS.fb,[])
  },null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='rimo-data.json';
  a.click();
};
document.getElementById('importFile').onchange=(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const j=JSON.parse(fr.result);
      if(j.crews) save(KEYS.crews,j.crews);
      if(j.apps) save(KEYS.apps,j.apps);
      if(j.routes) save(KEYS.routes,j.routes);
      if(j.feedback) save(KEYS.fb,j.feedback);
      alert('불러오기 완료');
      renderPublished(); renderRoutes(); renderJoins(); renderFb();
    }catch(err){ alert('JSON 형식 오류'); }
  };
  fr.readAsText(file);
};
document.getElementById('btnReset').onclick=()=>{
  if(!confirm('정말 전체 초기화할까요?')) return;
  [KEYS.crews,KEYS.apps,KEYS.routes,KEYS.fb,'rimo_draft_card'].forEach(k=>localStorage.removeItem(k));
  renderPublished(); renderRoutes(); renderJoins(); renderFb(); clearForm();
};

/* helpers exposed */
window.fillForm=(c)=>setForm(c);

/* init */
(function init(){
  // 드래프트 복구
  const d=load('rimo_draft_card',null); if(d) setForm(d); else clearForm();
  renderPublished(); renderRoutes(); renderJoins(); renderFb();
  showPage('create'); // 첫 로딩은 '크루 생성'
})();
</script>
</body>
</html>
