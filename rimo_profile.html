<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ë¼ì´ë” í”„ë¡œí•„</title>

<link rel="stylesheet" href="rimo_theme.css?v=20250910" />

<style>
  :root{ --label-width:40px; }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky; top:0; z-index:5; background:rgba(11,11,15,.9); -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px); border-bottom:1px solid var(--border-1)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}.title{font-weight:800;opacity:.9}
  main{display:flex;flex-direction:column;gap:12px}
  .panel{padding:12px;display:flex;flex-direction:column;gap:10px}

  .form-row{display:flex;align-items:center;gap:6px;margin-bottom:0}
  .form-row label{width:var(--label-width);font-size:14px;font-weight:700;white-space:nowrap}
  .field{flex:1;min-width:0}

  /* ì§€ì—­/íƒ ë¤ 1í–‰ 2ì—´ (ì›í•˜ë©´ ìœ„/ì•„ë˜ë¡œ ë‚˜ëˆ ë„ ë¨) */
  .form-row.split{display:grid;grid-template-columns:minmax(0,1.6fr) minmax(0,1fr);column-gap:14px;align-items:center}
  .form-row.split .col{display:flex;align-items:center;gap:6px;min-width:0}
  .form-row.split .col label{width:var(--label-width);font-size:14px;font-weight:700;white-space:nowrap;color:#fff}
  /* íƒ ë¤ ì—´ë§Œ ì‚´ì§ íƒ€ì´íŠ¸í•˜ê²Œ */
  .form-row.split .col:nth-child(2){ gap:4px }
  .form-row.split .col:nth-child(2) label{ width:calc(var(--label-width) - 8px) }
  .form-row.split .col:nth-child(2) .field{ flex:1 1 auto; min-width:0 }
  .form-row.split .col:nth-child(2) select{ width:100% }

  textarea{resize:none;height:40px}
  .toggles{display:flex;gap:10px;flex-wrap:wrap;margin:0}
  .toggle{display:inline-flex;align-items:center;gap:12px;padding:8px 12px;border-radius:999px;cursor:pointer}
  .toggle.active{background:rgba(122,167,255,.16);box-shadow:0 0 10px rgba(122,167,255,.45);font-weight:800;transform:translateY(-1px) scale(1.03)}
  .profile-icons{display:flex;flex-direction:column;align-items:center;gap:10px;margin:0}
  .icons{display:grid;grid-template-columns:repeat(5,48px);grid-auto-rows:48px;gap:10px;justify-content:center}
  .icon-btn{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer}
  .icon-btn.active{box-shadow:0 0 10px rgba(122,167,255,.4);transform:scale(1.05)}
  .intro-box{width:calc(48px*5 + 10px*4);margin:8px 0 0}
  #intro{width:100%;text-align:center}
  .save-btn{width:100%;padding:14px;margin-top:10px;font-size:15px;font-weight:700;border:none;border-radius:10px;cursor:pointer}
  .save-btn[disabled]{opacity:.6;cursor:not-allowed}

  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:2500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:3000;padding:16px}
  .modal.show{display:flex}
  .modal-content.panel{max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .card-head{display:flex;gap:14px;align-items:center}
  .avatar{width:72px;height:72px;border-radius:50%;font-size:36px;display:flex;align-items:center;justify-content:center;flex:0 0 auto}
  .idcol{min-width:0}
  .name{margin:0 0 4px;font-size:18px;font-weight:800}
  .sub{margin:0;opacity:.85;font-size:13px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tag{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border-radius:999px;font-size:12px;white-space:nowrap}
  .modal-actions{display:flex;gap:12px;justify-content:center;margin-top:6px}
  .modal-actions button{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;font-weight:800;cursor:pointer}

  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);padding:10px 14px;background:rgba(0,0,0,.78);color:#fff;border-radius:10px;font-size:13px;display:none;z-index:5000;border:1px solid rgba(255,255,255,.12)}
  .toast.show{display:block;animation:fade 2s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}90%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ë¼ì´ë” í”„ë¡œí•„</div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="form-row">
      <label>ì´ë¦„</label>
      <div class="field"><input id="handle" type="text" placeholder="ì˜ˆ: RIMO rider" autocomplete="nickname"></div>
    </div>

    <div class="form-row">
      <label>ê¸°ì¢…</label>
      <div class="field"><input id="bike" type="text" placeholder="ì˜ˆ: Honda MSX125" autocomplete="off"></div>
    </div>

    <div class="form-row split">
      <div class="col">
        <label for="region">ì§€ì—­</label>
        <div class="field">
          <select id="region">
            <option value="">ì§€ì—­ ì„ íƒ</option>
            <option>ì„œìš¸ ê°•ë‚¨êµ¬</option><option>ì„œìš¸ ê°•ë™êµ¬</option><option>ì„œìš¸ ê°•ë¶êµ¬</option>
            <option>ì„œìš¸ ê°•ì„œêµ¬</option><option>ì„œìš¸ ê´€ì•…êµ¬</option><option>ì„œìš¸ ê´‘ì§„êµ¬</option>
            <option>ì„œìš¸ êµ¬ë¡œêµ¬</option><option>ì„œìš¸ ê¸ˆì²œêµ¬</option><option>ì„œìš¸ ë…¸ì›êµ¬</option>
            <option>ì„œìš¸ ë„ë´‰êµ¬</option><option>ì„œìš¸ ë™ëŒ€ë¬¸êµ¬</option><option>ì„œìš¸ ë™ì‘êµ¬</option>
            <option>ì„œìš¸ ë§ˆí¬êµ¬</option><option>ì„œìš¸ ì„œëŒ€ë¬¸êµ¬</option><option>ì„œìš¸ ì„œì´ˆêµ¬</option>
            <option>ì„œìš¸ ì„±ë™êµ¬</option><option>ì„œìš¸ ì„±ë¶êµ¬</option><option>ì„œìš¸ ì†¡íŒŒêµ¬</option>
            <option>ì„œìš¸ ì–‘ì²œêµ¬</option><option>ì„œìš¸ ì˜ë“±í¬êµ¬</option><option>ì„œìš¸ ìš©ì‚°êµ¬</option>
            <option>ì„œìš¸ ì€í‰êµ¬</option><option>ì„œìš¸ ì¢…ë¡œêµ¬</option><option>ì„œìš¸ ì¤‘êµ¬</option>
            <option>ì„œìš¸ ì¤‘ë‘êµ¬</option>
          </select>
        </div>
      </div>
      <div class="col">
        <label for="tandem">íƒ ë¤</label>
        <div class="field">
          <select id="tandem">
            <option value="í—ˆìš©">í—ˆìš©</option>
            <option value="ë¶ˆê°€">ë¶ˆê°€</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-row">
      <label>ì‹œê°„ëŒ€</label>
      <div class="field">
        <select id="time">
          <option value="">ì‹œê°„ëŒ€ ì„ íƒ</option>
          <option value="05:00â€“10:00 (ì•„ì¹¨)">05:00â€“10:00 (ì•„ì¹¨)</option>
          <option value="14:00â€“17:00 (ì˜¤í›„)">14:00â€“17:00 (ì˜¤í›„)</option>
          <option value="18:00â€“22:00 (ì €ë…)">18:00â€“22:00 (ì €ë…)</option>
          <option value="23:00â€“03:00 (ì‹¬ì•¼)">23:00â€“03:00 (ì‹¬ì•¼)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <label>ìŠ¤íƒ€ì¼</label>
      <div class="toggles" data-group="style">
        <span class="toggle" data-value="Urban">Urban</span>
        <span class="toggle" data-value="Curve">Curve</span>
        <span class="toggle" data-value="Tour">Tour</span>
      </div>
    </div>

    <div class="form-row">
      <label>í˜ì´ìŠ¤</label>
      <div class="toggles" data-group="speed">
        <span class="toggle" data-value="Easy">Easy</span>
        <span class="toggle" data-value="Balanced">Balanced</span>
        <span class="toggle" data-value="Dynamic">Dynamic</span>
      </div>
    </div>

    <div class="profile-icons">
      <div class="icons" id="iconSelect">
        <div class="icon-btn" data-icon="ğŸï¸">ğŸï¸</div>
        <div class="icon-btn" data-icon="ğŸ›µ">ğŸ›µ</div>
        <div class="icon-btn" data-icon="ğŸ”¥">ğŸ”¥</div>
        <div class="icon-btn" data-icon="ğŸŒŠ">ğŸŒŠ</div>
        <div class="icon-btn" data-icon="â˜•">â˜•</div>
        <div class="icon-btn" data-icon="â­">â­</div>
        <div class="icon-btn" data-icon="ğŸ">ğŸ</div>
        <div class="icon-btn" data-icon="ğŸ¶">ğŸ¶</div>
        <div class="icon-btn" data-icon="âš¡">âš¡</div>
        <div class="icon-btn" data-icon="ğŸ±">ğŸ±</div>
      </div>
      <div class="intro-box">
        <textarea id="intro" maxlength="25" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œ (25ì ì´ë‚´)"></textarea>
      </div>
    </div>

    <button class="save-btn" id="saveBtn">í”„ë¡œí•„ ì €ì¥</button>
  </section>
</main>

<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab primary">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- ë¯¸ë¦¬ë³´ê¸° -->
<div class="modal" id="previewModal">
  <div class="modal-content panel">
    <div class="card-head">
      <div class="avatar" id="avatarPreview">ğŸï¸</div>
      <div class="idcol">
        <h3 class="name" id="namePreview">ë¼ì´ë” ì´ë¦„</h3>
        <p class="sub" id="bikePreview">ë°”ì´í¬ ë¯¸ì…ë ¥ Â· ì„œìš¸</p>
      </div>
    </div>
    <div class="grid-2">
      <div class="tag" id="timePreview">-</div>
      <div class="tag" id="tandemPreview">íƒ ë¤ í—ˆìš©</div>
    </div>
    <div class="grid-3" id="styleGrid"></div>
    <div class="grid-3" id="paceGrid"></div>
    <div class="modal-actions">
      <button class="ok" id="confirmBtn">í™•ì¸</button>
      <button class="edit" id="editBtn">ìˆ˜ì •</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const REG_URL  = "https://script.google.com/macros/s/AKfycbz1P-KpgNGKUGqFDA20-QxUdcqsEEcWo8HEXtwQMW6voSnf6eHg18gi1yT7HpVzZCX6xw/exec";
const LS_KEY   = 'rimo_profile_v1';
const LS_UID   = 'rimo_uid_v1';
const LS_TOKEN = 'rimo_write_token_v1';
let selectedIcon = "ğŸï¸";

function getUID(){
  let uid = localStorage.getItem(LS_UID);
  if(!uid){
    uid = "u_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(LS_UID, uid);
  }
  return uid;
}

function showToast(msg, ms = 2000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.animationDuration = (ms/1000) + 's';
  t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=> t.classList.remove('show'), ms);
}

// ì•„ì´ì½˜
const iconWrap = document.getElementById("iconSelect");
iconWrap.addEventListener("click", e=>{
  const btn = e.target.closest(".icon-btn");
  if(!btn) return;
  selectedIcon = btn.dataset.icon;
  updateIconActive();
});
function updateIconActive(){
  iconWrap.querySelectorAll(".icon-btn").forEach(b=>{
    b.classList.toggle("active", b.dataset.icon === selectedIcon);
  });
}
updateIconActive();

// í† ê¸€
document.querySelectorAll('.toggles').forEach(group=>{
  group.addEventListener('click',e=>{
    if(e.target.classList.contains('toggle')) e.target.classList.toggle('active');
  });
});

// ë¡œì»¬ ë°˜ì˜
(function hydrate(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS_KEY)||'null');
    if(saved){
      handle.value = saved.name || '';
      bike.value   = saved.bike || '';
      region.value = saved.region || '';
      time.value   = saved.time || '';
      tandem.value = saved.tandem || 'í—ˆìš©';
      selectedIcon = saved.icon || 'ğŸï¸'; updateIconActive();
      (saved.styles||[]).forEach(v=>{
        const el = [...document.querySelectorAll('.toggles[data-group="style"] .toggle')].find(x=>x.dataset.value===v);
        if(el) el.classList.add('active');
      });
      (saved.pace||[]).forEach(v=>{
        const el = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle')].find(x=>x.dataset.value===v);
        if(el) el.classList.add('active');
      });
      intro.value = saved.intro || '';
    }
  }catch(_){}
})();

function collectProfile(){
  const styles = [...document.querySelectorAll('.toggles[data-group="style"] .toggle.active')].map(el=>el.dataset.value);
  const pace   = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle.active')].map(el=>el.dataset.value);
  return {
    uid: getUID(),
    name: handle.value.trim(),
    bike: bike.value.trim(),
    region: region.value,
    styles, pace,
    time: time.value,
    tandem: tandem.value,
    icon: selectedIcon,
    intro: (intro.value||'').slice(0,25)
  };
}
function saveProfileLocal(p){ localStorage.setItem(LS_KEY, JSON.stringify(p)); }

async function saveProfileRemote(p){
  const token = localStorage.getItem(LS_TOKEN) || '';
  const res = await fetch(REG_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" }, // preflight íšŒí”¼
    body: JSON.stringify({ action:"registerProfile", profile: p, writeToken: token })
  });
  const out = await res.json().catch(()=>({ok:false, msg:'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'}));
  return out;
}

function showPreview(p){
  avatarPreview.textContent = p.icon || 'ğŸï¸';
  namePreview.textContent   = p.name || 'ë¼ì´ë” ì´ë¦„';
  bikePreview.textContent   = `${p.region? p.region+' Â· ' : ''}${p.bike||'ë°”ì´í¬ ë¯¸ì…ë ¥'}`;
  timePreview.textContent   = p.time || '-';
  tandemPreview.textContent = `íƒ ë¤ ${p.tandem||'-'}`;
  styleGrid.innerHTML = p.styles.map(s=>`<div class="tag">${s}</div>`).join('');
  paceGrid.innerHTML  = p.pace.map(s=>`<div class="tag">${s}</div>`).join('');
  previewModal.classList.add('show');
}

const saveBtn = document.getElementById("saveBtn");
const handle  = document.getElementById("handle");
const bike    = document.getElementById("bike");
const region  = document.getElementById("region");
const time    = document.getElementById("time");
const tandem  = document.getElementById("tandem");
const intro   = document.getElementById("intro");

saveBtn.addEventListener("click", async ()=>{
  const p = collectProfile();
  if(!p.name){ showToast("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
  saveBtn.disabled = true;
  try{
    saveProfileLocal(p);
    const out = await saveProfileRemote(p);
    if(out.ok){
      if(out.writeToken) localStorage.setItem(LS_TOKEN, out.writeToken);
      showToast("âœ… í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ");
      // ë‚´ ë§í¬ ìë™ ë³µì‚¬ (ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ?me=uid ë¡œ ë‚´ í”„ë¡œí•„ ë³µêµ¬)
      try{
        const link = new URL('rimo_ambassadors.html', location.href);
        link.searchParams.set('me', p.uid);
        await navigator.clipboard.writeText(link.href);
        showToast("ë‚´ ë§í¬ ë³µì‚¬ë¨");
      }catch(_){}
      showPreview(p);
    } else {
      showToast("âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + (out.msg || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  }catch(err){
    showToast("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
  }finally{
    saveBtn.disabled = false;
  }
});

confirmBtn.addEventListener("click", ()=> previewModal.classList.remove('show'));
editBtn.addEventListener("click", ()=> previewModal.classList.remove('show'));
</script>
</body>
</html>
