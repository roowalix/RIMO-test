<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ë¼ì´ë” í”„ë¡œí•„</title>

<link rel="stylesheet" href="rimo_theme.css?v=20250910" />

<style>
  :root{
    --label-width:40px;
    --accent:#2a5bff;
    --accent-glow: rgba(122,167,255,.45);
    --chip-bg:#101223; --chip-bd:#2b2e54;

    /* ë‚´ í”„ë¡œí•„ ì°¾ê¸° ëª¨ë‹¬ ì „ìš© ë³€ìˆ˜ */
    --claim-results-min: 140px;
    --claim-card-h: 132px;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif}

  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9);
    -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1);
  }
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}

  main{display:flex;flex-direction:column;gap:12px}
  .panel{padding:12px;display:flex;flex-direction:column;gap:10px}

  .form-row{display:flex;align-items:center;gap:6px;margin-bottom:0}
  .form-row.top{align-items:flex-start}
  .form-row label{width:var(--label-width);font-size:14px;font-weight:700;white-space:nowrap}
  .field{flex:1.5;min-width:0}
  /* PIN ì…ë ¥ì¹¸ ë£© */
  #pin{letter-spacing:2px;text-align:center}

  /* ì§€ì—­/íƒ ë¤ 1í–‰ 2ì—´ */
  .form-row.split{
    display:grid; grid-template-columns:minmax(0,1.6fr) minmax(0,1fr);
    column-gap:16px; align-items:center;
  }
  .form-row.split .col{display:flex;align-items:center;gap:6px;min-width:0}
  .form-row.split .col label{width:var(--label-width);font-size:14px;font-weight:700;color:#fff;white-space:nowrap}
  .form-row.split .col:nth-child(2){ gap:4px }
  .form-row.split .col:nth-child(2) label{ width:calc(var(--label-width) - 8px) }
  .form-row.split .col:nth-child(2) .field{ flex:1 1 auto; min-width:0 }
  .form-row.split select{ width:100% }

  textarea{resize:none;height:40px}

  .toggles{display:flex;gap:10px;flex-wrap:wrap;margin:0}
  .toggle{
    display:inline-flex;align-items:center;gap:14px;padding:8px 12px;border-radius:999px;
    color:#e6e9ff;font-size:13px;cursor:pointer;user-select:none;white-space:nowrap;
    transition:transform .15s ease, box-shadow .15s ease;
    background:var(--chip-bg); border:1px solid var(--chip-bd);
  }
  .toggle.active{
    border-color:var(--accent); background:rgba(122,167,255,.16);
    box-shadow:0 0 10px var(--accent-glow); transform:translateY(-1px) scale(1.03);
    font-weight:800;
  }

  .profile-icons{display:flex;flex-direction:column;align-items:center;gap:10px;margin:0}
  .icons{display:grid;grid-template-columns:repeat(5,48px);grid-auto-rows:48px;gap:10px;justify-content:center}
  .icon-btn{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:28px;cursor:pointer;transition:.15s ease;color:#fff;
    background:var(--chip-bg); border:1px solid var(--chip-bd)}
  .icon-btn.active{border-color:var(--accent);box-shadow:0 0 10px var(--accent-glow);transform:scale(1.05)}
  .intro-box{width:calc(48px*5 + 10px*4);margin:8px 0 0}
  #intro{width:100%;text-align:center}

  .save-btn{width:100%;padding:14px;margin-top:10px;font-size:15px;font-weight:700;background:var(--accent);border:none;color:#fff;border-radius:10px;cursor:pointer}
  .save-btn[disabled]{opacity:.6;cursor:not-allowed}

  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:2500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);
    padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}

  /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:3000;padding:16px}
  .modal.show{display:flex}
  .modal-content.panel{max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .card-head{display:flex;gap:14px;align-items:center}
  .avatar{width:72px;height:72px;border-radius:50%;font-size:36px;display:flex;align-items:center;justify-content:center;flex:0 0 auto}
  .idcol{min-width:0}
  .name{margin:0 0 4px;font-size:18px;font-weight:800}
  .sub{margin:0;color:var(--muted);font-size:13px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tag{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border-radius:999px;font-size:12px;white-space:nowrap;background:var(--chip-bg);border:1px solid var(--chip-bd)}
  .modal-actions{display:flex;gap:12px;justify-content:center;margin-top:6px}
  .modal-actions button{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;font-weight:800;cursor:pointer;color:#fff}
  .modal-actions .ok{background:var(--accent)}
  .modal-actions .edit{background:#2c2f48}

  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);padding:10px 14px;background:rgba(0,0,0,.78);color:#fff;border-radius:10px;font-size:13px;display:none;z-index:5000;border:1px solid rgba(255,255,255,.12)}
  .toast.show{display:block;animation:fade 2s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}
                  10%{opacity:1;transform:translateX(-50%) translateY(0)}
                  90%{opacity:1}
                  100%{opacity:0}}

  /* ===== ë‚´ í”„ë¡œí•„ ì°¾ê¸° ëª¨ë‹¬ ===== */
  #claimModal .sheet{width:100%; max-width:680px}
  #claimModal .sheet.panel{
    background:#0e1222; border:1px solid #2b304f; border-radius:18px;
    box-shadow:0 14px 40px rgba(0,0,0,.55);
    max-height:88vh; display:flex; flex-direction:column; padding:16px 16px 18px;
  }
  #claimModal .hint{color:#cfd2ff; margin:0 0 8px}
  #claimModal .search-row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
  #claimModal .search-btn{width:100%; padding:12px 16px; border:none; border-radius:10px; background:var(--accent); color:#fff; font-weight:800; cursor:pointer; margin-bottom:10px}
  #claimResults{
    display:grid; gap:10px; overflow:auto;
    min-height:var(--claim-results-min);
    max-height: clamp(180px, 48vh, 420px);
  }
  .claim-card{
    height: var(--claim-card-h);
    min-height: var(--claim-card-h);
    display:grid; grid-template-rows:auto 1fr auto; gap:10px;
    padding:12px; background:var(--chip-bg); border:1px solid var(--chip-bd); border-radius:12px; overflow:hidden;
  }
  .claim-card .head{display:grid; grid-template-columns:44px 1fr; gap:10px; align-items:center}
  .claim-card .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#1a1c2f;border:1px solid #2b2e54;font-size:22px}
  .claim-card .name{margin:0 0 2px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .claim-card .sub{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .claim-card .foot{display:grid; grid-template-columns: minmax(0, calc(100% - 160px - 10px)) 160px; gap:10px; align-items:center; margin-top:auto}
  .claim-card .pin{height:36px;padding:8px 10px;border:1px solid #2b2e54;border-radius:8px;background:#0f1020;color:#fff;letter-spacing:2px;text-align:center}
  .claim-card .pin:focus{outline:none;box-shadow:0 0 0 2px rgba(122,167,255,.25) inset;border-color:var(--accent)}
  .claim-card .connect{
    height:36px; padding:0 18px; border-radius:10px; border:1px solid transparent;
    background:var(--accent); color:#fff; font-weight:800; cursor:pointer;
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
    white-space:nowrap;
  }
  .claim-card .connect:hover,
  .claim-card .connect:focus-visible{
    border-color:var(--accent); background:rgba(122,167,255,.16);
    color:#e6e9ff;
    box-shadow:0 0 10px var(--accent-glow), 0 0 0 2px rgba(122,167,255,.25) inset;
    transform:translateY(-1px) scale(1.03);
  }
  .claim-card .connect.active{
    border-color:var(--accent); background:rgba(122,167,255,.16);
    color:#e6e9ff; box-shadow:0 0 10px var(--accent-glow), 0 0 0 2px rgba(122,167,255,.25) inset;
    transform:translateY(-1px) scale(1.03);
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ë¼ì´ë” í”„ë¡œí•„</div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="form-row">
      <label>ì´ë¦„</label>
      <div class="field"><input id="handle" type="text" placeholder="ì˜ˆ: RIMO rider" autocomplete="nickname"></div>
    </div>
    <div class="form-row">
      <label>ê¸°ì¢…</label>
      <div class="field"><input id="bike" type="text" placeholder="ì˜ˆ: Honda MSX125" autocomplete="off"></div>
    </div>

    <div class="form-row split">
      <div class="col">
        <label for="region">ì§€ì—­</label>
        <div class="field">
          <select id="region">
            <option value="">ì§€ì—­ ì„ íƒ</option>
            <option>ì„œìš¸ ê°•ë‚¨êµ¬</option><option>ì„œìš¸ ê°•ë™êµ¬</option><option>ì„œìš¸ ê°•ë¶êµ¬</option>
            <option>ì„œìš¸ ê°•ì„œêµ¬</option><option>ì„œìš¸ ê´€ì•…êµ¬</option><option>ì„œìš¸ ê´‘ì§„êµ¬</option>
            <option>ì„œìš¸ êµ¬ë¡œêµ¬</option><option>ì„œìš¸ ê¸ˆì²œêµ¬</option><option>ì„œìš¸ ë…¸ì›êµ¬</option>
            <option>ì„œìš¸ ë„ë´‰êµ¬</option><option>ì„œìš¸ ë™ëŒ€ë¬¸êµ¬</option><option>ì„œìš¸ ë™ì‘êµ¬</option>
            <option>ì„œìš¸ ë§ˆí¬êµ¬</option><option>ì„œìš¸ ì„œëŒ€ë¬¸êµ¬</option><option>ì„œìš¸ ì„œì´ˆêµ¬</option>
            <option>ì„œìš¸ ì„±ë™êµ¬</option><option>ì„œìš¸ ì„±ë¶êµ¬</option><option>ì„œìš¸ ì†¡íŒŒêµ¬</option>
            <option>ì„œìš¸ ì–‘ì²œêµ¬</option><option>ì„œìš¸ ì˜ë“±í¬êµ¬</option><option>ì„œìš¸ ìš©ì‚°êµ¬</option>
            <option>ì„œìš¸ ì€í‰êµ¬</option><option>ì„œìš¸ ì¢…ë¡œêµ¬</option><option>ì„œìš¸ ì¤‘êµ¬</option>
            <option>ì„œìš¸ ì¤‘ë‘êµ¬</option>
          </select>
        </div>
      </div>
      <div class="col">
        <label for="tandem">íƒ ë¤</label>
        <div class="field">
          <select id="tandem">
            <option value="í—ˆìš©">í—ˆìš©</option>
            <option value="ë¶ˆê°€">ë¶ˆê°€</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-row">
      <label>ì‹œê°„ëŒ€</label>
      <div class="field">
        <select id="time">
          <option value="">ì‹œê°„ëŒ€ ì„ íƒ</option>
          <option value="05:00â€“10:00 (ì•„ì¹¨)">05:00â€“10:00 (ì•„ì¹¨)</option>
          <option value="14:00â€“17:00 (ì˜¤í›„)">14:00â€“17:00 (ì˜¤í›„)</option>
          <option value="18:00â€“22:00 (ì €ë…)">18:00â€“22:00 (ì €ë…)</option>
          <option value="23:00â€“03:00 (ì‹¬ì•¼)">23:00â€“03:00 (ì‹¬ì•¼)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <label>ìŠ¤íƒ€ì¼</label>
      <div class="toggles" data-group="style">
        <span class="toggle" data-value="Urban">Urban</span>
        <span class="toggle" data-value="Curve">Curve</span>
        <span class="toggle" data-value="Tour">Tour</span>
      </div>
    </div>

    <div class="form-row">
      <label>í˜ì´ìŠ¤</label>
      <div class="toggles" data-group="speed">
        <span class="toggle" data-value="Easy">Easy</span>
        <span class="toggle" data-value="Balanced">Balanced</span>
        <span class="toggle" data-value="Dynamic">Dynamic</span>
      </div>
    </div>

    <!-- âœ… PIN(4ìë¦¬) â€” ì €ì¥ ì‹œ í•¨ê»˜ ì „ì†¡ (í•´ì‹œ ì €ì¥) -->
    <div class="form-row">
      <label>PIN</label>
      <div class="field">
        <input id="pin" type="password" inputmode="numeric" pattern="\d*" maxlength="4" placeholder="4ìë¦¬ ìˆ«ì (ìƒˆë¡œ ì„¤ì •/ë³€ê²½)">
      </div>
    </div>

    <div class="profile-icons">
      <div class="icons" id="iconSelect">
        <div class="icon-btn" data-icon="ğŸï¸">ğŸï¸</div>
        <div class="icon-btn" data-icon="ğŸ›µ">ğŸ›µ</div>
        <div class="icon-btn" data-icon="ğŸ”¥">ğŸ”¥</div>
        <div class="icon-btn" data-icon="ğŸŒŠ">ğŸŒŠ</div>
        <div class="icon-btn" data-icon="â˜•">â˜•</div>
        <div class="icon-btn" data-icon="â­">â­</div>
        <div class="icon-btn" data-icon="ğŸ">ğŸ</div>
        <div class="icon-btn" data-icon="ğŸ¶">ğŸ¶</div>
        <div class="icon-btn" data-icon="âš¡">âš¡</div>
        <div class="icon-btn" data-icon="ğŸ±">ğŸ±</div>
      </div>
      <div class="intro-box">
        <textarea id="intro" maxlength="25" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œ (25ì ì´ë‚´)"></textarea>
      </div>
    </div>

    <button class="save-btn" id="saveBtn">í”„ë¡œí•„ ì €ì¥</button>
    <button class="save-btn" id="findMineBtn" style="background:#2c2f48;margin-top:8px">ë‚´ í”„ë¡œí•„ ì°¾ê¸°</button>
  </section>
</main>

<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab primary">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal" id="previewModal">
  <div class="modal-content panel">
    <div class="card-head">
      <div class="avatar" id="avatarPreview">ğŸï¸</div>
      <div class="idcol">
        <h3 class="name" id="namePreview">ë¼ì´ë” ì´ë¦„</h3>
        <p class="sub" id="bikePreview">ë°”ì´í¬ ë¯¸ì…ë ¥ Â· ì„œìš¸</p>
      </div>
    </div>
    <div class="grid-2">
      <div class="tag" id="timePreview">-</div>
      <div class="tag" id="tandemPreview">íƒ ë¤ í—ˆìš©</div>
    </div>
    <div class="grid-3" id="styleGrid"></div>
    <div class="grid-3" id="paceGrid"></div>
    <div class="modal-actions">
      <button class="ok" id="confirmBtn">í™•ì¸</button>
      <button class="edit" id="editBtn">ìˆ˜ì •</button>
    </div>
  </div>
</div>

<!-- ë‚´ í”„ë¡œí•„ ì°¾ê¸° ëª¨ë‹¬ -->
<div class="modal" id="claimModal" aria-modal="true" role="dialog">
  <div class="sheet panel" id="claimSheet">
    <h3 style="margin:0 0 8px">ë‚´ í”„ë¡œí•„ ì°¾ê¸°</h3>
    <p class="hint" style="margin:0 0 10px">ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ í›„ ë‚´ í”„ë¡œí•„ì„ ì„ íƒí•˜ì„¸ìš”.</p>
    <div class="search-row">
      <input id="claimName" type="text" placeholder="ì´ë¦„" style="flex:1;min-width:160px;padding:10px 12px;border:1px solid #2c2f48;border-radius:10px;background:#0f1020;color:#fff">
      <input id="claimRegion" type="text" placeholder="ì§€ì—­(ì„ íƒ)" style="flex:1;min-width:160px;padding:10px 12px;border:1px solid #2c2f48;border-radius:10px;background:#0f1020;color:#fff">
    </div>
    <button id="claimSearch" class="search-btn">ê²€ìƒ‰</button>
    <div id="claimResults"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* uid/me ì¿¼ë¦¬ë¡œ ë“¤ì–´ì˜¤ë©´ ë‚´ UIDë¡œ ì €ì¥ */
(function seedUIDFromQuery(){
  try{
    const p = new URLSearchParams(location.search);
    const v = p.get('uid') || p.get('me');
    if(v){
      localStorage.setItem('rimo_uid_v1', v);
      history.replaceState({}, '', location.pathname);
    }
  }catch(_){}
})();

/* ìƒìˆ˜ */
const REG_URL = "https://script.google.com/macros/s/AKfycbyVF4YYdzsucME-81RusrsOg89FJIgR7NLplRZ1kIMhGQmdh0_lRD-zWz4NG9xoFN43IQ/exec";
const LS_KEY  = 'rimo_profile_v1';
const LS_UID  = 'rimo_uid_v1';
let selectedIcon = "ğŸï¸";

/* í† ìŠ¤íŠ¸ */
function showToast(msg, ms=2000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.animationDuration = (ms/1000)+'s';
  t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=> t.classList.remove('show'), ms);
}

/* ì•„ì´ì½˜ ì„ íƒ */
const iconWrap = document.getElementById("iconSelect");
function updateIconActive(){
  iconWrap.querySelectorAll(".icon-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.icon === selectedIcon);
  });
}
iconWrap.addEventListener("click", e=>{
  const btn = e.target.closest(".icon-btn");
  if(!btn) return;
  selectedIcon = btn.dataset.icon;
  updateIconActive();
});
updateIconActive();

/* í† ê¸€ì¹© */
document.querySelectorAll('.toggles').forEach(group=>{
  group.addEventListener('click',e=>{
    if(e.target.classList.contains('toggle')){
      e.target.classList.toggle('active');
    }
  });
});

/* ë¡œì»¬ â†’ í¼ (PINì€ ë³´ì•ˆìƒ ë¯¸í‘œì‹œ) */
let _localPinSha = '';
(function hydrateLocal(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS_KEY)||'null');
    if(saved){
      selectedIcon = saved.icon || 'ğŸï¸';
      updateIconActive();
      document.getElementById('handle').value = saved.name || '';
      document.getElementById('bike').value   = saved.bike || '';
      document.getElementById('region').value = saved.region || '';
      document.getElementById('time').value   = saved.time || '';
      document.getElementById('tandem').value = saved.tandem || 'í—ˆìš©';
      (saved.styles||[]).forEach(v=>{
        const el = [...document.querySelectorAll('.toggles[data-group="style"] .toggle')].find(x=>x.dataset.value===v);
        if(el) el.classList.add('active');
      });
      (saved.pace||[]).forEach(v=>{
        const el = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle')].find(x=>x.dataset.value===v);
        if(el) el.classList.add('active');
      });
      document.getElementById('intro').value = saved.intro || '';
      _localPinSha = saved.pin_sha256 || '';
    }
  }catch(_){}
})();

/* ìœ í‹¸: UID ë³´ì¥ */
function ensureUID(){
  let u = localStorage.getItem(LS_UID);
  if(!u){
    u = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(LS_UID, u);
  }
  return u;
}

/* ìœ í‹¸: SHA-256(hex) */
async function sha256Hex(text){
  const buf = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  const bytes = Array.from(new Uint8Array(hash));
  return bytes.map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ìˆ˜ì§‘ (PIN í•´ì‹œ í¬í•¨) */
async function collectProfile(){
  const styles = [...document.querySelectorAll('.toggles[data-group="style"] .toggle.active')].map(el=>el.dataset.value);
  const pace   = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle.active')].map(el=>el.dataset.value);
  const introVal = (document.getElementById('intro').value||'').slice(0,25);

  // PIN ì…ë ¥ì´ ìˆìœ¼ë©´ ìƒˆ í•´ì‹œ, ì—†ìœ¼ë©´ ê¸°ì¡´ í•´ì‹œ ìœ ì§€
  const pinRaw = (document.getElementById('pin').value || '').trim();
  let pinSha = _localPinSha || '';
  if(pinRaw){
    if(!/^\d{4}$/.test(pinRaw)){ showToast('PINì€ ìˆ«ì 4ìë¦¬ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); throw new Error('bad pin'); }
    pinSha = await sha256Hex(pinRaw);
  }

  return {
    uid: ensureUID(),
    name: document.getElementById('handle').value.trim(),
    bike: document.getElementById('bike').value.trim(),
    region: document.getElementById('region').value,
    styles, pace,
    time: document.getElementById('time').value,
    tandem: document.getElementById('tandem').value,
    icon: selectedIcon,
    intro: introVal,
    pin_sha256: pinSha
  };
}

/* ì €ì¥ */
function saveProfileLocal(p){
  localStorage.setItem(LS_KEY, JSON.stringify(p));
  localStorage.setItem(LS_UID, p.uid);
  _localPinSha = p.pin_sha256 || '';
}
async function saveProfileRemote(p){
  const res = await fetch(REG_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"registerProfile", profile:p })
  });
  const out = await res.json().catch(()=>({ok:false,msg:'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'}));
  return out;
}

/* ë¯¸ë¦¬ë³´ê¸° */
function showPreview(p){
  document.getElementById('avatarPreview').textContent = p.icon || 'ğŸï¸';
  document.getElementById('namePreview').textContent   = p.name || 'ë¼ì´ë” ì´ë¦„';
  document.getElementById('bikePreview').textContent   = `${p.region? p.region+' Â· ' : ''}${p.bike||'ë°”ì´í¬ ë¯¸ì…ë ¥'}`;
  document.getElementById('timePreview').textContent   = p.time || '-';
  document.getElementById('tandemPreview').textContent = `íƒ ë¤ ${p.tandem||'-'}`;
  document.getElementById('styleGrid').innerHTML = p.styles.map(s=>`<div class="tag">${s}</div>`).join('');
  document.getElementById('paceGrid').innerHTML  = p.pace.map(s=>`<div class="tag">${s}</div>`).join('');
  document.getElementById('previewModal').classList.add('show');
}

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  try{
    const p = await collectProfile();          // â† PIN í•´ì‹œë¥¼ ìœ„í•´ async
    if(!p.name){ showToast("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
    const btn = document.getElementById("saveBtn");
    btn.disabled = true;
    try{
      saveProfileLocal(p);
      const out = await saveProfileRemote(p);
      if(out.ok){
        showToast("âœ… í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ");
        // ì €ì¥ í›„ PIN ì…ë ¥ì¹¸ì€ ë¹„ì›Œë‘ê¸°
        const pinEl = document.getElementById('pin'); if(pinEl) pinEl.value='';
        showPreview(p);
      }else{
        showToast("âš ï¸ ì €ì¥ ì‹¤íŒ¨: " + (out.msg || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    }finally{
      btn.disabled = false;
    }
  }catch(_e){ /* PIN ì˜¤ë¥˜ ë“±ì€ í† ìŠ¤íŠ¸ë¡œ ì•ˆë‚´ë¨ */ }
});
document.getElementById("confirmBtn").addEventListener("click",()=> {
  document.getElementById('previewModal').classList.remove('show');
});
document.getElementById("editBtn").addEventListener("click",()=> {
  document.getElementById('previewModal').classList.remove('show');
});

/* ===== ë‚´ í”„ë¡œí•„ ì°¾ê¸° ===== */
(function addClaimMyProfile(){
  const REG = REG_URL;
  const findBtn   = document.getElementById('findMineBtn');
  const modal     = document.getElementById('claimModal');
  const sheet     = document.getElementById('claimSheet');
  const nameInp   = document.getElementById('claimName');
  const regionInp = document.getElementById('claimRegion');
  const searchBtn = document.getElementById('claimSearch');
  const results   = document.getElementById('claimResults');

  function openModal(){
    const nameEl = document.getElementById('handle');
    const regEl  = document.getElementById('region');
    if(nameEl) nameInp.value = nameEl.value || '';
    if(regEl)  regionInp.value = regEl.value || '';
    results.innerHTML = '';
    modal.classList.add('show');
    nameInp.focus();
  }
  function closeModal(){ modal.classList.remove('show'); }
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
  sheet.addEventListener('click', (e)=> e.stopPropagation());
  if (findBtn) findBtn.addEventListener('click', openModal);

  async function fetchAll(){
    try{
      const res = await fetch(`${REG}?action=listProfiles&ts=${Date.now()}`, {cache:'no-store'});
      const j = await res.json().catch(()=>null);
      return (j && j.ok && Array.isArray(j.data)) ? j.data : (Array.isArray(j) ? j : []);
    }catch(_){ showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return []; }
  }

  function render(list){
    results.innerHTML = '';
    if(!list.length){
      results.innerHTML = '<p style="color:var(--muted);text-align:center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    list.forEach(r=>{
      const card = document.createElement('div');
      card.className = 'claim-card';
      card.innerHTML = `
        <div class="head">
          <div class="avatar">${r.icon || 'ğŸï¸'}</div>
          <div class="text">
            <div class="name">${r.name || 'ì´ë¦„ì—†ìŒ'}</div>
            <div class="sub">${r.region || '-'} Â· ${r.bike || '-'}</div>
          </div>
        </div>
        <div class="foot">
          <input class="pin" type="password" inputmode="numeric" pattern="\\d*" maxlength="4" placeholder="PIN(4ìë¦¬)" aria-label="PIN(4ìë¦¬)"/>
          <button class="connect">í”„ë¡œí•„ ì—°ê²°</button>
        </div>
      `;
      const btn = card.querySelector('.connect');
      const pinEl = card.querySelector('.pin');

      btn.addEventListener('click', async ()=>{
        const pin = (pinEl.value||'').trim();
        if(pin.length !== 4){ showToast('PIN 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); pinEl.focus(); return; }

        // (ì„ íƒ) ì„œë²„ì—ì„œ ê²€ì¦í•˜ë ¤ë©´ ë³„ë„ APIë¡œ pin_sha256 ì „ë‹¬í•´ í™•ì¸í•˜ì„¸ìš”.
        // const ok = await verifyOnServer(r.uid, await sha256Hex(pin));

        btn.classList.add('active');
        setTimeout(()=>btn.classList.remove('active'), 600);

        const normalized = {
          uid:r.uid||'', name:r.name||'', bike:r.bike||'', region:r.region||'',
          styles:Array.isArray(r.styles)?r.styles:[], pace:Array.isArray(r.pace)?r.pace:[],
          time:r.time||'', tandem:r.tandem||'í—ˆìš©', icon:r.icon||'ğŸï¸', intro:r.intro||'',
          pin_sha256: await sha256Hex(pin)
        };
        localStorage.setItem(LS_UID, normalized.uid);
        localStorage.setItem(LS_KEY, JSON.stringify(normalized));
        _localPinSha = normalized.pin_sha256 || '';

        // í¼ ë°˜ì˜ (PINì€ ë¹„ì›Œë‘ )
        const set=(id,val)=>{const el=document.getElementById(id); if(el) el.value=val;};
        set('handle', normalized.name);
        set('bike',   normalized.bike);
        set('region', normalized.region);
        set('time',   normalized.time);
        set('tandem', normalized.tandem);
        const pinInput = document.getElementById('pin'); if(pinInput) pinInput.value='';

        selectedIcon = normalized.icon; updateIconActive();
        document.querySelectorAll('.toggles .toggle').forEach(t=>t.classList.remove('active'));
        (normalized.styles||[]).forEach(v=>{
          const t=[...document.querySelectorAll('.toggles[data-group="style"] .toggle')].find(x=>x.dataset.value===v);
          if(t) t.classList.add('active');
        });
        (normalized.pace||[]).forEach(v=>{
          const t=[...document.querySelectorAll('.toggles[data-group="speed"] .toggle')].find(x=>x.dataset.value===v);
          if(t) t.classList.add('active');
        });
        const introEl=document.getElementById('intro');
        if(introEl) introEl.value=(normalized.intro||'').slice(0,25);

        showToast('ì´ ê¸°ê¸°ì— ë‚´ í”„ë¡œí•„ ì—°ê²° ì™„ë£Œ');
        closeModal();
      });

      results.appendChild(card);
    });
  }

  if (searchBtn){
    searchBtn.addEventListener('click', async ()=>{
      const qn=(nameInp.value||'').trim().toLowerCase();
      const qr=(regionInp.value||'').trim().toLowerCase();
      if(!qn){ showToast('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); nameInp.focus(); return; }
      const rows = await fetchAll();
      const hits = rows.filter(r=>{
        const n=String(r.name||'').toLowerCase();
        const rg=String(r.region||'').toLowerCase();
        return (n.includes(qn) || n===qn) && (!qr || rg.includes(qr));
      }).slice(0,30);
      render(hits);
    });
  }
})();
</script>
</body>
</html>
