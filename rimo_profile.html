<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 라이더 프로필</title>

<link rel="stylesheet" href="rimo_theme.css?v=20250910" />

<style>
  :root{ --label-width:40px; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif; }

  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9);
    -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1);
  }
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}

  main{display:flex;flex-direction:column;gap:12px}
  .panel{padding:12px;display:flex;flex-direction:column;gap:10px;padding-bottom:4px}

  .form-row{display:flex;align-items:center;gap:6px;margin-bottom:0}
  .form-row.top{align-items:flex-start}
  .form-row label{width:var(--label-width);font-size:14px;font-weight:700;white-space:nowrap}
  .field{flex:1.5;min-width:0}

  /* 지역/탠덤 1행 2열 */
  .form-row.split{
    display:grid; grid-template-columns:minmax(0,1.6fr) minmax(0,1fr);
    column-gap:16px; align-items:center;
  }
  .form-row.split .col{display:flex;align-items:center;gap:6px;min-width:0}
  .form-row.split .col label{width:var(--label-width);font-size:14px;font-weight:700;color:#fff;white-space:nowrap}
  /* 탠덤(오른쪽)만 살짝 더 붙여서 ‘허용’ 잘림 방지 */
  .form-row.split .col:nth-child(2){ gap:4px }
  .form-row.split .col:nth-child(2) label{ width:calc(var(--label-width) - 8px) }
  .form-row.split .col:nth-child(2) .field{ flex:1 1 auto; min-width:0 }
  .form-row.split select{ width:100% }

  /* 드롭다운 가독성 */
  select{color:#fff;background:#0f1020;border:1px solid #2c2f48;border-radius:8px;padding:8px 12px;font-size:14px;appearance:none}
  select option{color:#fff;background:#0f1020}
  input[type="text"], textarea{
    width:100%;padding:8px 12px;border-radius:8px;border:1px solid #2c2f48;background:#0f1020;color:#fff;font-size:14px
  }
  textarea{resize:none;height:40px}

  .toggles{display:flex;gap:10px;flex-wrap:wrap;margin:0}
  .toggle{
    display:inline-flex;align-items:center;gap:14px;padding:8px 12px;border-radius:999px;
    background:var(--surface-2); border:1px solid var(--border-2);
    color:#e6e9ff;font-size:13px;cursor:pointer;user-select:none;white-space:nowrap;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .toggle.active{
    border-color:var(--accent); background:rgba(122,167,255,.16);
    box-shadow:0 0 10px rgba(122,167,255,.45); transform:translateY(-1px) scale(1.03);
    font-weight:800;
  }

  .profile-icons{display:flex;flex-direction:column;align-items:center;gap:10px;margin:0}
  .icons{display:grid;grid-template-columns:repeat(5,48px);grid-auto-rows:48px;gap:10px;justify-content:center}
  .icon-btn{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:28px;cursor:pointer;transition:.15s ease;color:#fff;background:#1a1c2f;border:1px solid #2c2f48}
  .icon-btn.active{border-color:var(--accent);box-shadow:0 0 10px rgba(122,167,255,.4);transform:scale(1.05)}
  .intro-box{width:calc(48px*5 + 10px*4);margin:8px 0 0}
  #intro{width:100%;text-align:center}

  .save-btn{width:100%;padding:14px;margin-top:10px;font-size:15px;font-weight:700;background:#2a5bff;border:none;color:#fff;border-radius:10px;cursor:pointer}
  .save-btn[disabled]{opacity:.6;cursor:not-allowed}

  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:2500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);
    padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:3000;padding:16px}
  .modal.show{display:flex}
  .modal-content.panel{max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  .card-head{display:flex;gap:14px;align-items:center}
  .avatar{width:72px;height:72px;border-radius:50%;font-size:36px;display:flex;align-items:center;justify-content:center;flex:0 0 auto;background:#1a1c2f;border:1px solid #2c2f48}
  .idcol{min-width:0}
  .name{margin:0 0 4px;font-size:18px;font-weight:800}
  .sub{margin:0;color:var(--muted);font-size:13px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tag{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 10px;border-radius:999px;font-size:12px;white-space:nowrap;background:var(--surface-2);border:1px solid var(--border-2)}
  .modal-actions{display:flex;gap:12px;justify-content:center;margin-top:6px}
  .modal-actions button{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;font-weight:800;cursor:pointer;color:#fff}
  .modal-actions .ok{background:#2a5bff}
  .modal-actions .edit{background:#2c2f48}

  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);padding:10px 14px;background:rgba(0,0,0,.78);color:#fff;border-radius:10px;font-size:13px;display:none;z-index:5000;border:1px solid rgba(255,255,255,.12)}
  .toast.show{display:block;animation:fade 2s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}
                  10%{opacity:1;transform:translateX(-50%) translateY(0)}
                  90%{opacity:1}
                  100%{opacity:0}}
  
  /* === Claim My Profile (내 프로필 찾기/복구) === */
.claim-actions{
  text-align:center;
  margin-top:8px;
  font-size:12px;
  color:var(--muted);
}
.claim-actions a{
  color:#9fb7ff;
  text-decoration:underline;
  margin:0 8px;
}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">라이더 프로필</div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="form-row">
      <label>이름</label>
      <div class="field"><input id="handle" type="text" placeholder="예: RIMO rider" autocomplete="nickname"></div>
    </div>
    <div class="form-row">
      <label>기종</label>
      <div class="field"><input id="bike" type="text" placeholder="예: Honda MSX125" autocomplete="off"></div>
    </div>

    <div class="form-row split">
      <div class="col">
        <label for="region">지역</label>
        <div class="field">
          <select id="region">
            <option value="">지역 선택</option>
            <option>서울 강남구</option><option>서울 강동구</option><option>서울 강북구</option>
            <option>서울 강서구</option><option>서울 관악구</option><option>서울 광진구</option>
            <option>서울 구로구</option><option>서울 금천구</option><option>서울 노원구</option>
            <option>서울 도봉구</option><option>서울 동대문구</option><option>서울 동작구</option>
            <option>서울 마포구</option><option>서울 서대문구</option><option>서울 서초구</option>
            <option>서울 성동구</option><option>서울 성북구</option><option>서울 송파구</option>
            <option>서울 양천구</option><option>서울 영등포구</option><option>서울 용산구</option>
            <option>서울 은평구</option><option>서울 종로구</option><option>서울 중구</option>
            <option>서울 중랑구</option>
          </select>
        </div>
      </div>
      <div class="col">
        <label for="tandem">탠덤</label>
        <div class="field">
          <select id="tandem">
            <option value="허용">허용</option>
            <option value="불가">불가</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-row">
      <label>시간대</label>
      <div class="field">
        <select id="time">
          <option value="">시간대 선택</option>
          <option value="05:00–10:00 (아침)">05:00–10:00 (아침)</option>
          <option value="14:00–17:00 (오후)">14:00–17:00 (오후)</option>
          <option value="18:00–22:00 (저녁)">18:00–22:00 (저녁)</option>
          <option value="23:00–03:00 (심야)">23:00–03:00 (심야)</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <label>스타일</label>
      <div class="toggles" data-group="style">
        <span class="toggle" data-value="Urban">Urban</span>
        <span class="toggle" data-value="Curve">Curve</span>
        <span class="toggle" data-value="Tour">Tour</span>
      </div>
    </div>

    <div class="form-row">
      <label>페이스</label>
      <div class="toggles" data-group="speed">
        <span class="toggle" data-value="Easy">Easy</span>
        <span class="toggle" data-value="Balanced">Balanced</span>
        <span class="toggle" data-value="Dynamic">Dynamic</span>
      </div>
    </div>

    <div class="profile-icons">
      <div class="icons" id="iconSelect">
        <div class="icon-btn" data-icon="🏍️">🏍️</div>
        <div class="icon-btn" data-icon="🛵">🛵</div>
        <div class="icon-btn" data-icon="🔥">🔥</div>
        <div class="icon-btn" data-icon="🌊">🌊</div>
        <div class="icon-btn" data-icon="☕">☕</div>
        <div class="icon-btn" data-icon="⭐">⭐</div>
        <div class="icon-btn" data-icon="🏁">🏁</div>
        <div class="icon-btn" data-icon="🐶">🐶</div>
        <div class="icon-btn" data-icon="⚡">⚡</div>
        <div class="icon-btn" data-icon="🎱">🎱</div>
      </div>
      <div class="intro-box">
        <textarea id="intro" maxlength="25" placeholder="간단한 자기소개 (25자 이내)"></textarea>
      </div>
    </div>

   <button class="save-btn" id="saveBtn">프로필 저장</button>

<!-- ✅ 추가: 내 프로필 찾기 링크 -->
<p style="text-align:center;margin:8px 0 0">
  <a href="#" id="findMineLink" style="color:#9fb7ff;text-decoration:underline">내 프로필 찾기</a>
</p>
  </section>
</main>

<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab">메인</a>
  <a href="rimo_profile.html" class="tab primary">프로필</a>
  <a href="rimo_ambassadors.html" class="tab">엠버서더</a>
</nav>

<div class="modal" id="previewModal">
  <div class="modal-content panel">
    <div class="card-head">
      <div class="avatar" id="avatarPreview">🏍️</div>
      <div class="idcol">
        <h3 class="name" id="namePreview">라이더 이름</h3>
        <p class="sub" id="bikePreview">바이크 미입력 · 서울</p>
      </div>
    </div>
    <div class="grid-2">
      <div class="tag" id="timePreview">-</div>
      <div class="tag" id="tandemPreview">탠덤 허용</div>
    </div>
    <div class="grid-3" id="styleGrid"></div>
    <div class="grid-3" id="paceGrid"></div>
<div class="modal-actions">
  <button class="ok" id="confirmBtn">확인</button>
  <button class="edit" id="editBtn">수정</button>
  <!-- ✅ 추가 -->
  <button class="edit" id="copyRecovery">복구 링크 복사</button>
</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// 1) URL의 ?uid= 또는 ?me= 가 있으면 내 UID로 저장
(function seedUIDFromQuery(){
  try{
    const p = new URLSearchParams(location.search);
    const v = p.get('uid') || p.get('me');
    if(v){
      localStorage.setItem('rimo_uid_v1', v);
      document.cookie = `rimo_uid_v1=${encodeURIComponent(v)}; path=/; SameSite=Lax; max-age=${365*86400}`;
      history.replaceState({}, '', location.pathname);
    }
  }catch(_){}
})();

// 2) 상수/상태
const REG_URL = "https://script.google.com/macros/s/AKfycbwUWRmyofeMKOQX9iErQLypTT_oOrgZVFZh7i8HjO0VODFIEjoV7HDjA9a3jUe8rBreug/exec";
const LS_KEY  = 'rimo_profile_v1';
const LS_UID  = 'rimo_uid_v1';
let selectedIcon = "🏍️";

// cookie helpers
function setCookie(k,v,days=365){
  const d=new Date(); d.setTime(d.getTime()+days*864e5);
  document.cookie = `${k}=${encodeURIComponent(v)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
}
function getCookie(k){
  const m = document.cookie.match(new RegExp('(?:^|; )'+k+'=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

// UID 보장( URL > local > cookie > 생성 )
function ensureUID(){
  const q = new URLSearchParams(location.search);
  const qs = q.get('uid') || q.get('me');
  if(qs){ localStorage.setItem(LS_UID, qs); setCookie(LS_UID, qs); return qs; }
  let u = localStorage.getItem(LS_UID) || getCookie(LS_UID);
  if(!u){
    u = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(LS_UID, u); setCookie(LS_UID, u);
  }
  return u;
}

function showToast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.animationDuration=(ms/1000)+'s';
  t.classList.add('show');
  clearTimeout(window._toastTimer); window._toastTimer=setTimeout(()=>t.classList.remove('show'), ms);
}

// 아이콘 토글
const iconWrap = document.getElementById("iconSelect");
iconWrap.addEventListener("click", e=>{
  const btn = e.target.closest(".icon-btn"); if(!btn) return;
  selectedIcon = btn.dataset.icon; updateIconActive();
});
function updateIconActive(){
  iconWrap.querySelectorAll(".icon-btn").forEach(b => b.classList.toggle("active", b.dataset.icon === selectedIcon));
}

// 원격 단건 조회(getProfile)
async function fetchProfileByUid(uid){
  try{
    const url = `${REG_URL}?action=getProfile&uid=${encodeURIComponent(uid)}&ts=${Date.now()}`;
    const res = await fetch(url, {cache:'no-store'});
    const j = await res.json().catch(()=>null);
    if(j && j.ok && j.data) return j.data;
  }catch(_){}
  return null;
}

// 수집/저장
function collectProfile(){
  const styles = [...document.querySelectorAll('.toggles[data-group="style"] .toggle.active')].map(el=>el.dataset.value);
  const pace   = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle.active')].map(el=>el.dataset.value);
  const introVal = (document.getElementById('intro').value||'').slice(0,25);
  return {
    uid: ensureUID(),
    name: document.getElementById('handle').value.trim(),
    bike: document.getElementById('bike').value.trim(),
    region: document.getElementById('region').value,
    styles, pace,
    time: document.getElementById('time').value,
    tandem: document.getElementById('tandem').value,
    icon: selectedIcon,
    intro: introVal
  };
}
function saveProfileLocal(p){
  localStorage.setItem(LS_KEY, JSON.stringify(p));
  localStorage.setItem(LS_UID, p.uid);
  setCookie(LS_UID, p.uid);
}
async function saveProfileRemote(p){
  const res = await fetch(REG_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" }, // preflight 회피
    body: JSON.stringify({ action:"registerProfile", profile: p })
  });
  const out = await res.json().catch(()=>({ok:false,msg:'응답 파싱 실패'}));
  return out;
}

// 프리뷰
function showPreview(p){
  document.getElementById('avatarPreview').textContent = p.icon || '🏍️';
  document.getElementById('namePreview').textContent   = p.name || '라이더 이름';
  document.getElementById('bikePreview').textContent   = `${p.region? p.region+' · ' : ''}${p.bike||'바이크 미입력'}`;
  document.getElementById('timePreview').textContent   = p.time || '-';
  document.getElementById('tandemPreview').textContent = `탠덤 ${p.tandem||'-'}`;
  document.getElementById('styleGrid').innerHTML = p.styles.map(s=>`<div class="tag">${s}</div>`).join('');
  document.getElementById('paceGrid').innerHTML  = p.pace.map(s=>`<div class="tag">${s}</div>`).join('');
  document.getElementById('previewModal').classList.add('show');
}

// 초기 프리필 (URL uid > local > server(uid))
async function hydrate(){
  const q = new URLSearchParams(location.search);
  const urlUid = q.get('uid') || q.get('me');
  const ls = localStorage.getItem(LS_KEY);

  if(urlUid){
    const remote = await fetchProfileByUid(urlUid);
    if(remote){ fillForm(remote); return; }
  }
  if(ls){
    try{ fillForm(JSON.parse(ls)); return; }catch(_){}
  }
  const uid = ensureUID();
  const remote = await fetchProfileByUid(uid);
  if(remote){ fillForm(remote); }
}
function fillForm(data){
  selectedIcon = data.icon || '🏍️'; updateIconActive();
  document.getElementById('handle').value = data.name || '';
  document.getElementById('bike').value   = data.bike || '';
  document.getElementById('region').value = data.region || '';
  document.getElementById('time').value   = data.time || '';
  document.getElementById('tandem').value = data.tandem || '허용';
  (data.styles||[]).forEach(v=>{
    const el = [...document.querySelectorAll('.toggles[data-group="style"] .toggle')].find(x=>x.dataset.value===v);
    if(el) el.classList.add('active');
  });
  (data.pace||[]).forEach(v=>{
    const el = [...document.querySelectorAll('.toggles[data-group="speed"] .toggle')].find(x=>x.dataset.value===v);
    if(el) el.classList.add('active');
  });
  document.getElementById('intro').value = (data.intro || '').slice(0,25);
}

// wire
updateIconActive();
document.querySelectorAll('.toggles').forEach(group=>{
  group.addEventListener('click',e=>{
    if(e.target.classList.contains('toggle')){
      e.target.classList.toggle('active');
    }
  });
});
(async ()=>{ await hydrate(); })();

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const p = collectProfile();
  if(!p.name){ showToast("이름을 입력해 주세요."); return; }
  const btn = document.getElementById("saveBtn");
  btn.disabled = true;
  try{
    saveProfileLocal(p);
    const out = await saveProfileRemote(p);
    if(out.ok){ showToast("✅ 프로필 저장 완료"); showPreview(p); }
    else{ showToast("⚠️ 저장 실패: " + (out.msg || "알 수 없는 오류")); }
  }catch(err){
    showToast("⚠️ 네트워크 오류: " + err.message);
  }finally{
    btn.disabled = false;
  }
});
document.getElementById("confirmBtn").addEventListener("click",()=> {
  document.getElementById('previewModal').classList.remove('show');
});
document.getElementById("editBtn").addEventListener("click",()=> {
  document.getElementById('previewModal').classList.remove('show');
});
</script>

<!-- ✅ 내 프로필 찾기 모달 -->
<div class="modal" id="claimModal" role="dialog" aria-modal="true" aria-labelledby="claimTitle">
  <div class="modal-content panel" style="max-width:520px">
    <h3 id="claimTitle" style="margin:0 0 8px">내 프로필 찾기</h3>
    <p style="color:var(--muted);margin:0 0 10px">이름으로 검색 후 내 프로필을 선택하세요.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="claimName" type="text" placeholder="이름" style="flex:1;min-width:160px;padding:8px 12px;border:1px solid #2c2f48;border-radius:8px;background:#0f1020;color:#fff">
      <input id="claimRegion" type="text" placeholder="지역(선택)" style="flex:1;min-width:160px;padding:8px 12px;border:1px solid #2c2f48;border-radius:8px;background:#0f1020;color:#fff">
      <button id="claimSearch" class="save-btn" style="flex:0 0 auto;padding:10px 14px;border-radius:8px">검색</button>
    </div>
    <div id="claimResults" class="claim-list" style="margin-top:10px;display:grid;gap:8px"></div>
    <div style="display:flex;justify-content:center;margin-top:10px">
      <button class="edit" id="claimClose" style="padding:10px 14px;border-radius:8px;border:none;color:#fff;background:#2c2f48">닫기</button>
    </div>
  </div>
</div>

<script>
/* ==== RIMO | 내 프로필 찾기 (단일 모듈, 중복 제거/이벤트 위임) ==== */
(function claimMyProfileInit(){
  const LS_KEY='rimo_profile_v1', LS_UID='rimo_uid_v1';
  const REG=(typeof REG_URL!=='undefined')?REG_URL:'';

  /* 0) 혹시 남아있을 이전 삽입물(중복) 정리 */
  document.querySelectorAll('#claimModal').forEach((n,i)=>{ if(i>0) n.remove(); });
  document.querySelectorAll('#claimActions').forEach((n,i)=>{ if(i>0) n.remove(); });

  /* 1) 저장 버튼 아래 ‘내 프로필 찾기’ 버튼(한 개만) 주입 — 텍스트 링크는 만들지 않음 */
  const saveBtn = document.getElementById('saveBtn');
  if (saveBtn && !document.getElementById('claimActions')) {
    const line = document.createElement('div');
    line.id = 'claimActions';
    line.style.cssText = 'display:flex;justify-content:center;gap:8px;margin-top:6px';
    line.innerHTML = `
      <button id="findMineBtn" type="button" class="save-btn"
              style="padding:10px 14px;border-radius:8px;max-width:200px">
        내 프로필 찾기
      </button>`;
    saveBtn.insertAdjacentElement('afterend', line);
  }

  /* 2) 모달 DOM (없으면 생성) */
  if (!document.getElementById('claimModal')) {
    const wrap = document.createElement('div');
    wrap.innerHTML = `
    <div class="modal" id="claimModal" role="dialog" aria-modal="true" aria-labelledby="claimTitle"
         style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:3000;background:rgba(0,0,0,.45);padding:22px 12px">
      <div class="modal-content panel" style="max-width:520px">
        <h3 id="claimTitle" style="margin:0 0 8px">내 프로필 찾기</h3>
        <p style="color:var(--muted);margin:0 0 10px">이름으로 검색 후 내 프로필을 선택하세요.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="claimName" type="text" placeholder="이름"
                 style="flex:1;min-width:160px;padding:8px 12px;border:1px solid #2c2f48;border-radius:8px;background:#0f1020;color:#fff">
          <input id="claimRegion" type="text" placeholder="지역(선택)"
                 style="flex:1;min-width:160px;padding:8px 12px;border:1px solid #2c2f48;border-radius:8px;background:#0f1020;color:#fff">
          <button id="claimSearch" class="save-btn"
                  style="flex:0 0 auto;padding:10px 14px;border-radius:8px">검색</button>
        </div>
        <div id="claimResults" style="margin-top:10px;display:grid;gap:8px"></div>
        <div style="display:flex;justify-content:center;margin-top:10px">
          <button id="claimClose"
                  style="padding:10px 14px;border-radius:8px;border:none;color:#fff;background:#2c2f48">닫기</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(wrap.firstElementChild);
  }

  /* 3) 참조는 ‘해당 모달 내부’에서만 잡기 (중복 아이디 충돌 방지) */
  const modal = document.getElementById('claimModal');
  const nameInp   = modal.querySelector('#claimName');
  const regionInp = modal.querySelector('#claimRegion');
  const results   = modal.querySelector('#claimResults');

  function toast(m){ try{ showToast(m); }catch{ alert(m); } }

  function openModal(){
    const nameEl = document.getElementById('handle');
    const regEl  = document.getElementById('region');
    if(nameEl) nameInp.value = nameEl.value || '';
    if(regEl)  regionInp.value = regEl.value || '';
    results.innerHTML = '';
    modal.style.display = 'flex';
    setTimeout(()=> nameInp.focus(), 0);
  }
  function closeModal(){ modal.style.display='none'; }

  async function fetchAll(){
    if(!REG){ toast('REG_URL이 정의되어야 합니다.'); return []; }
    try{
      const res = await fetch(`${REG}?action=listProfiles&ts=${Date.now()}`, {cache:'no-store'});
      const j = await res.json().catch(()=>null);
      return (j && j.ok && Array.isArray(j.data)) ? j.data : (Array.isArray(j) ? j : []);
    }catch(_){ toast('불러오기 실패'); return []; }
  }

  function render(list){
    results.innerHTML = '';
    if(!list.length){
      results.innerHTML = '<p style="color:var(--muted);text-align:center">검색 결과가 없습니다.</p>';
      return;
    }
    list.forEach(r=>{
      const row = document.createElement('div');
      row.dataset.uid = r.uid || '';
      row.dataset.payload = JSON.stringify({
        uid:r.uid||'', name:r.name||'', bike:r.bike||'', region:r.region||'',
        styles:Array.isArray(r.styles)?r.styles:[], pace:Array.isArray(r.pace)?r.pace:[],
        time:r.time||'', tandem:r.tandem||'허용', icon:r.icon||'🏍️', intro:r.intro||''
      });
      row.style.cssText='display:flex;gap:10px;align-items:center;padding:10px;border:1px solid #2b2e54;border-radius:12px;background:#101223';
      row.innerHTML = `
        <div style="width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#1a1c2f;border:1px solid #2b2e54;font-size:22px;flex:0 0 auto">${r.icon||'🏍️'}</div>
        <div style="min-width:0">
          <div style="font-weight:800;margin:0 0 2px">${r.name||'이름없음'}</div>
          <div style="font-size:13px;color:var(--muted)">${r.region||'-'} · ${r.bike||'-'}</div>
        </div>
        <div style="margin-left:auto">
          <button type="button" class="claim-pick save-btn" style="padding:8px 12px;border-radius:8px">프로필 발견</button>
        </div>`;
      results.appendChild(row);
    });
  }

  async function doSearch(){
    const qn=(nameInp.value||'').trim().toLowerCase();
    const qr=(regionInp.value||'').trim().toLowerCase();
    if(!qn){ toast('이름을 입력해 주세요.'); nameInp.focus(); return; }
    const rows = await fetchAll();
    const hits = rows.filter(r=>{
      const n=String(r.name||'').toLowerCase();
      const rg=String(r.region||'').toLowerCase();
      return (n.includes(qn) || n===qn) && (!qr || rg.includes(qr));
    }).slice(0,30);
    render(hits);
  }

  /* 4) 모달 내부는 ‘이벤트 위임’으로 한 번에 처리 → 버튼 안 먹는 문제 방지 */
  modal.addEventListener('click', async (e)=>{
    if(e.target.closest('#claimClose')){ closeModal(); return; }
    if(e.target.closest('#claimSearch')){ await doSearch(); return; }
    const pick = e.target.closest('.claim-pick');
    if(pick){
      const row = pick.closest('[data-uid]');
      if(!row) return;
      const normalized = JSON.parse(row.dataset.payload||'{}');

      // 4-1) LocalStorage 저장
      localStorage.setItem(LS_UID, normalized.uid||'');
      localStorage.setItem(LS_KEY, JSON.stringify(normalized));

      // 4-2) 폼 반영
      const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; };
      set('handle', normalized.name);
      set('bike',   normalized.bike);
      set('region', normalized.region);
      set('time',   normalized.time);
      set('tandem', normalized.tandem);
      // 아이콘 & 토글
      window.selectedIcon = normalized.icon || '🏍️';
      if (typeof updateIconActive==='function') updateIconActive();
      document.querySelectorAll('.toggles .toggle').forEach(t=>t.classList.remove('active'));
      (normalized.styles||[]).forEach(v=>{
        const t=[...document.querySelectorAll('.toggles[data-group="style"] .toggle')].find(x=>x.dataset.value===v);
        if(t) t.classList.add('active');
      });
      (normalized.pace||[]).forEach(v=>{
        const t=[...document.querySelectorAll('.toggles[data-group="speed"] .toggle')].find(x=>x.dataset.value===v);
        if(t) t.classList.add('active');
      });
      const introEl=document.getElementById('intro');
      if(introEl) introEl.value=(normalized.intro||'').slice(0,25);

      toast('이 기기에 내 프로필 연결 완료');
      closeModal();
    }
  });

  /* 5) 열기 버튼 */
  const openBtn = document.getElementById('findMineBtn') || document.getElementById('findMineLink');
  if(openBtn){
    openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openModal(); });
  }
})();
</script>

</body>
</html>


