<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 엠버서더</title>

<link rel="stylesheet" href="rimo_theme.css?v=20250910" />

<style>
  *{box-sizing:border-box}
  body{margin:0;background:#0b0b0f;color:#e8e8ef;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky; top:0; z-index:5; background:rgba(11,11,15,.9); -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px); border-bottom:1px solid #23243a}
  .bar{display:flex; gap:10px; align-items:center; padding:14px 16px; height:56px}
  .logo{font-weight:900}.title{font-weight:800; opacity:.9}

  main{padding:16px; max-width:720px; margin:0 auto; display:flex; flex-direction:column; gap:12px; padding-bottom:100px}

  .card.amb-card{background:#101223;border:1px solid #23243a;border-radius:16px;padding:10px 12px;display:flex;flex-direction:column;gap:7px;margin-bottom:10px}
  .amb-card.me{box-shadow:0 0 0 2px rgba(122,167,255,.25) inset}
  .head{display:flex; gap:14px; align-items:center}
  .avatar{width:72px; height:72px; border-radius:50%; background:#1a1c2f; border:1px solid #2b2e54; font-size:36px; display:flex; align-items:center; justify-content:center; flex:0 0 auto}
  .idcol{min-width:0; flex:1}
  .nameRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .name{margin:0; font-size:16px; font-weight:800; line-height: 1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .meBadge{padding:3px 7px; font-size:11px; font-weight:800; color:#cfe0ff; background:rgba(122,167,255,.15); border:1px solid rgba(122,167,255,.35); border-radius:999px}
  .intro{margin:4px 0 0; font-weight:600; font-size:13px; color:#e8e8ef}
  .sub{margin:6px 0 0; color:#b9b9cc; font-size:13px}
  .matchBtn{margin-left:auto; display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; background:#1a1c2f; border:1px solid #2b2e54; color:#e6e9ff; font-size:12px; font-weight:600; cursor:pointer}

  .traits{display:grid; grid-template-columns:repeat(6, max-content); gap:6px; justify-content:flex-start}
  .tag{display:inline-flex; align-items:center; justify-content:center; padding:6px 9px; border-radius:999px; background:#1a1c2f; border:1px solid #2b2e54; font-size:10px; font-weight:500; color:#e6e9ff; white-space:nowrap}
  .tag.style.pill-urban{background:#1e2d55;border-color:#2c4484}
  .tag.style.pill-curve{background:#2a1f56;border-color:#40307a}
  .tag.style.pill-tour{background:#1e3b3a;border-color:#2f5f5d}
  .tag.pace.pill-easy{background:#1f3a1f;border-color:#2f5a2f}
  .tag.pace.pill-balanced{background:#3a341e;border-color:#5a4f2f}
  .tag.pace.pill-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .tabbar{position:fixed; left:0; right:0; bottom:16px; z-index:2500; display:flex; justify-content:center; gap:12px}
  .state{color:#b9b9cc; font-size:13px; text-align:center; padding:24px 0}

  /* DM 모달 (스크롤+버튼 고정) */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:3000; background:rgba(0,0,0,.45); padding:22px 12px}
  .modal.show{display:flex}
  .sheet{width:100%; max-width:680px}
  .sheet.panel{background:#0e1222; border:1px solid #2b304f; border-radius:18px; box-shadow:0 14px 40px rgba(0,0,0,.55); max-height:88vh; display:flex; flex-direction:column; padding:16px}
  .pre{background:#0b1020; border:1px solid #293059; border-radius:12px; padding:12px; white-space:pre-wrap; line-height:1.4; max-height:48vh; overflow:auto}
  .modal-actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(14,18,34,0) 0%, #0e1222 40%); padding-top:12px; margin-top:12px; border-top:1px solid #2b304f}
  .modal-actions button{flex:1; min-width:130px; max-width:220px; padding:12px 18px; border-radius:12px; border:none; background:#2A2F4F; color:#fff; font-size:15px; font-weight:700; cursor:pointer}

  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); padding:10px 14px; background:rgba(0,0,0,.78); color:#fff; border-radius:10px; font-size:13px; display:none; z-index:5000; border:1px solid rgba(255,255,255,.12)}
  .toast.show{display:block; animation:fade 2s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}90%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">엠버서더</div>
  </div>
</header>

<main>
  <section id="list" aria-label="엠버서더 목록">
    <div class="state" id="stateMsg">불러오는 중…</div>
  </section>
</main>

<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab">메인</a>
  <a href="rimo_profile.html" class="tab">프로필</a>
  <a href="rimo_ambassadors.html" class="tab primary">엠버서더</a>
</nav>

<!-- DM 모달 -->
<div class="modal" id="dmModal" role="dialog" aria-modal="true" aria-labelledby="dmTitle">
  <div class="sheet panel" id="dmSheet">
    <h4 id="dmTitle">🤝 매칭 희망 DM 보내기</h4>
    <div class="hint" style="color:#cfd2ff;margin-bottom:10px">아래 메시지가 자동 복사됩니다. 카카오 1:1 채팅을 열어 붙여 넣기만 하세요.</div>
    <div id="dmPreview" class="pre"></div>
    <div class="modal-actions">
      <button id="openDM">카카오톡 열기</button>
      <button id="copyDM">다시 복사</button>
      <button id="editProfile">프로필 수정</button>
      <button id="closeDM">닫기</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ?uid= 또는 ?me= 로 들어오면 내 UID 저장
(function seedUIDFromQuery(){
  try{
    const p = new URLSearchParams(location.search);
    const v = p.get('uid') || p.get('me');
    if(v){
      localStorage.setItem('rimo_uid_v1', v);
      document.cookie = `rimo_uid_v1=${encodeURIComponent(v)}; path=/; SameSite=Lax; max-age=${365*86400}`;
      history.replaceState({}, '', location.pathname);
    }
  }catch(_){}
})();

const REG_URL  = "https://script.google.com/macros/s/AKfycbwUWRmyofeMKOQX9iErQLypTT_oOrgZVFZh7i8HjO0VODFIEjoV7HDjA9a3jUe8rBreug/exec";
const LS_KEY   = 'rimo_profile_v1';
const LS_UID   = 'rimo_uid_v1';
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";

function showToast(msg, ms=2000){
  const t=document.getElementById('toast'); t.textContent=msg;
  t.style.animationDuration=(ms/1000)+'s'; t.classList.add('show');
  clearTimeout(window._toastTimer); window._toastTimer=setTimeout(()=>t.classList.remove('show'), ms);
}
function uid(){ return localStorage.getItem(LS_UID)||''; }

// 목록 로드(앰버서더만, 최대 30)
async function loadAmbassadors(){
  const url = `${REG_URL}?action=listProfiles&amb=1&limit=30&ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  const text = await res.text();
  let j = null;
  try{ j = JSON.parse(text); }catch(_){ throw new Error('JSON 파싱 실패'); }
  if(j && j.ok && Array.isArray(j.data)) return j.data;
  if(Array.isArray(j)) return j;
  throw new Error('응답 형식 오류');
}

// 내 카드 맨 위 고정 + 최신순
function pinMineFirst(items){
  const me = uid();
  const arr = items.slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
  if(!me) return arr;
  const i = arr.findIndex(x => String(x.uid||'')===me);
  if(i>-1){ const my = arr.splice(i,1)[0]; return [my, ...arr]; }
  return arr;
}

function tagEl(cls, text){
  const div = document.createElement('div');
  div.className = 'tag ' + cls;
  div.textContent = text;
  return div;
}

function renderList(items){
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';

  const sorted = pinMineFirst(items);

  sorted.forEach(a=>{
    const isMe = (uid() && String(a.uid||'')===uid());

    const card = document.createElement('article');
    card.className = 'card amb-card' + (isMe ? ' me' : '');

    const head = document.createElement('div');
    head.className = 'head';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = a.icon || '🏍️';

    const idcol = document.createElement('div');
    idcol.className = 'idcol';

    const nameRow = document.createElement('div');
    nameRow.className = 'nameRow';

    const name = document.createElement('h3');
    name.className = 'name';
    name.textContent = a.name || '라이더';
    nameRow.appendChild(name);

    if (isMe) {
      const badge = document.createElement('span');
      badge.className = 'meBadge';
      badge.textContent = '내 프로필';
      nameRow.appendChild(badge);
    }

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'matchBtn';
    if(isMe){
      btn.textContent = '프로필 수정';
      btn.onclick = ()=> location.href = 'rimo_profile.html?uid=' + encodeURIComponent(a.uid || '');
    }else{
      btn.innerHTML = '🤝 매칭희망';
      btn.onclick = ()=> openDMModal(a);
    }
    nameRow.appendChild(btn);

    if (a.intro){
      const intro = document.createElement('p');
      intro.className = 'intro';
      intro.textContent = `"${String(a.intro).slice(0,25)}"`;
      idcol.appendChild(nameRow);
      idcol.appendChild(intro);
    } else {
      idcol.appendChild(nameRow);
    }

    const sub = document.createElement('p');
    sub.className = 'sub';
    sub.textContent = `${a.region? a.region+' · ' : ''}${a.bike || ''}`;
    idcol.appendChild(sub);

    head.appendChild(avatar);
    head.appendChild(idcol);

    const traits = document.createElement('div');
    traits.className = 'traits';
    const styles = Array.isArray(a.styles) ? a.styles : [];
    const pace   = Array.isArray(a.pace)   ? a.pace   : [];
    const STYLE_META = { Urban:{cls:'pill-urban',label:'Urban'}, Curve:{cls:'pill-curve',label:'Curve'}, Tour:{cls:'pill-tour',label:'Tour'} };
    const PACE_META  = { Easy:{cls:'pill-easy',label:'Easy'}, Balanced:{cls:'pill-balanced',label:'Balanced'}, Dynamic:{cls:'pill-dynamic',label:'Dynamic'} };
    const all = [
      ...styles.map(s => ({type:'style', key:s})),
      ...pace.map(p => ({type:'pace',  key:p}))
    ];
    if(all.length===0){
      traits.appendChild(tagEl('style','-'));
    }else{
      all.forEach(item=>{
        if(item.type==='style' && STYLE_META[item.key]){
          const m = STYLE_META[item.key]; traits.appendChild(tagEl(`style ${m.cls}`, m.label));
        }else if(item.type==='pace' && PACE_META[item.key]){
          const m = PACE_META[item.key]; traits.appendChild(tagEl(`pace ${m.cls}`, m.label));
        }else{
          traits.appendChild(tagEl(item.type, item.key));
        }
      });
    }

    card.appendChild(head);
    card.appendChild(traits);
    listEl.appendChild(card);
  });
}

/* ===== DM 모달 ===== */
const dmModal   = document.getElementById('dmModal');
const dmSheet   = document.getElementById('dmSheet');
const dmPreview = document.getElementById('dmPreview');

function composeDM(target){
  const stylesT = (target.styles||[]).join(' · ') || '-';
  const paceT   = (target.pace||[]).join(' · ') || '-';
  return (
`[🤝 매칭 희망] ${target.name || ''}
🏍️ ${target.bike || '-'}
📍 ${target.region || '-'}  |  👥 ${target.tandem || '-'}
⏰ ${target.time || '-'}
🎯 ${stylesT} / ${paceT}

* 위 라이더와 매칭 희망합니다.`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); return true;
  }
}
let _currentTarget = null;
function openDMModal(target){
  _currentTarget = target;
  const txt = composeDM(target);
  dmPreview.textContent = txt;
  copyText(txt).then(()=> showToast('메시지 복사 완료'));
  dmModal.classList.add('show');
}
function closeDMModal(){
  dmModal.classList.remove('show');
  _currentTarget = null;
}
document.getElementById('openDM').onclick  = ()=> window.open(ADMIN_DM, '_blank');
document.getElementById('copyDM').onclick  = ()=> copyText(dmPreview.textContent).then(()=> showToast('다시 복사 완료'));
document.getElementById('editProfile').onclick = ()=> location.href='rimo_profile.html';
document.getElementById('closeDM').onclick = closeDMModal;
dmModal.addEventListener('click', closeDMModal);
dmSheet.addEventListener('click', e=>e.stopPropagation());

/* ===== 부트 ===== */
(async function init(){
  const state = document.getElementById('stateMsg');
  if(state) state.textContent = '불러오는 중…';

  try{
    const items = await loadAmbassadors();
    if(state) state.remove();

    const normalized = items.map(r => ({
      uid: r.uid || '',
      icon: r.icon || '🏍️',
      name: r.name || '라이더',
      region: r.region || '',
      bike: r.bike || '',
      styles: Array.isArray(r.styles) ? r.styles : [],
      pace: Array.isArray(r.pace) ? r.pace : [],
      intro: String(r.intro || '').slice(0,25),
      time: r.time || '',
      tandem: r.tandem || '',
      ts: r.ts || 0
    }));
    renderList(normalized);
  }catch(err){
    console.error(err);
    if(state) state.textContent = '불러오기 실패: ' + err.message;
  }
})();
</script>
</body>
</html>
