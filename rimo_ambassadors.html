<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO ‚Äî Ïó†Î≤ÑÏÑúÎçî</title>
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#23243a;
    --tile:#101223; --tileBd:#23243a;
    --accent:#7aa7ff; --meBg:rgba(122,167,255,.10); --meBd:rgba(122,167,255,.55);

    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif;
  }

  header{
    position:sticky; top:0; z-index:5; background:rgba(11,11,15,.9);
    backdrop-filter:blur(8px); border-bottom:1px solid #232333;
  }
  .bar{display:flex; gap:10px; align-items:center; padding:14px 16px; height:56px}
  .logo{font-weight:900}
  .title{font-weight:800; opacity:.9}

  main{
    padding:16px; max-width:720px; margin:0 auto;
    display:flex; flex-direction:column; gap:12px;
    padding-bottom:100px;
  }

  .card{
    background:var(--tile);
    border:1px solid var(--tileBd);
    border-radius:16px;
    padding:10px 12px;
    display:flex; flex-direction:column; gap:7px;margin-bottom:10px;
  }
  /* ‚úÖ ÎÇ¥ ÌîÑÎ°úÌïÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ */
  .card.me{
    background:var(--meBg);
    border-color:var(--meBd);
    box-shadow:0 0 0 1px var(--meBd) inset;
  }
  .meBadge{
    margin-left:8px;
    padding:3px 7px;
    font-size:11px; font-weight:800;
    color:#cfe0ff;
    background:rgba(122,167,255,.15);
    border:1px solid rgba(122,167,255,.35);
    border-radius:999px;
  }

  .head{display:flex; gap:14px; align-items:center}
  .avatar{
    width:72px; height:72px; border-radius:50%;
    background:#1a1c2f; font-size:36px; display:flex; align-items:center; justify-content:center; flex:0 0 auto;
  }
  .idcol{min-width:0; flex:1}
  .nameRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .name{
    margin:0; font-size:16px; font-weight:800; line-height: 1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .intro{
    margin:4px 0 0;
    font-weight:600;
    font-size:13px;
    color:var(--fg);
  }
  .matchBtn{
    margin-left:auto;
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 8px; border-radius:999px;
    background:#1a1c2f; border:0px solid #2b2e54; color:#e6e9ff;
    font-size:12px; font-weight:600; cursor:pointer;
    transition:box-shadow .15s ease, transform .15s ease, border-color .15s ease, background-color .15s ease;
  }
  .matchBtn.active{
    border-color:var(--accent);
    background:rgba(122,167,255,.16);
    box-shadow:0 0 12px rgba(122,167,255,.5), 0 0 0 2px rgba(122,167,255,.25) inset;
    transform:translateY(-1px);
  }
  .sub{margin:6px 0 0; color:var(--muted); font-size:13px}

  .traits{
    display:grid;
    grid-template-columns:repeat(6, max-content);
    gap:6px;
    justify-content:flex-start;
  }
  .tag{
    display:inline-flex; align-items:center; justify-content:center;
    padding:6px 9px; border-radius:999px;
    background:#1a1c2f; border:0px solid #2b2e54;
    font-size:10px; font-weight:500; color:#e6e9ff;
    white-space:nowrap;
  }
  .tag.style.pill-urban   {background:#1e2d55;border-color:#2c4484}
  .tag.style.pill-curve   {background:#2a1f56;border-color:#40307a}
  .tag.style.pill-tour    {background:#1e3b3a;border-color:#2f5f5d}
  .tag.pace.pill-easy     {background:#1f3a1f;border-color:#2f5a2f}
  .tag.pace.pill-balanced {background:#3a341e;border-color:#5a4f2f}
  .tag.pace.pill-dynamic  {background:#3a1f1f;border-color:#5a2f2f}

  .tabbar{
    position:fixed; left:0; right:0; bottom:16px; z-index:2500;
    display:flex; gap:12px; justify-content:center;
  }
  .tabbar .tab{
    background:var(--tab-bg); border:1px solid var(--tab-bd); color:var(--tab-ink);
    padding:12px 18px; border-radius:22px; font-weight:800; text-decoration:none; font-size:14px;
  }
  .tabbar .tab.primary{background:var(--tab-pri); border-color:var(--tab-pri-bd)}

  .state{color:var(--muted); font-size:13px; text-align:center; padding:24px 0}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">üèçÔ∏è RIMO</div>
    <div class="title">Ïó†Î≤ÑÏÑúÎçî</div>
  </div>
</header>

<main>
  <section id="list" aria-label="Ïó†Î≤ÑÏÑúÎçî Î™©Î°ù">
    <div class="state" id="stateMsg">Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶</div>
  </section>
</main>

<nav class="tabbar" aria-label="ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò">
  <a href="index.html" class="tab">Î©îÏù∏</a>
  <a href="rimo_profile.html" class="tab">ÌîÑÎ°úÌïÑ</a>
  <a href="rimo_ambassadors.html" class="tab primary">Ïó†Î≤ÑÏÑúÎçî</a>
</nav>

<script>
/* ===== ÏÑ§Ï†ï ===== */
const REG_URL   = "https://script.google.com/macros/s/AKfycbzdOZDlDa8wcOt9XPCYM9HnNRS6n4fpxiEOfd5v9QEAXLICK0LERjHNM2-G0nOQ3BcV/exec";
const LS_KEY    = 'rimo_profile_v1';  // ÎÇ¥ ÌîÑÎ°úÌïÑ Î°úÏª¨
const LS_UID    = 'rimo_uid_v1';      // ÎÇ¥ uid Î°úÏª¨

const STYLE_META = {
  Urban:{cls:'pill-urban',  label:'Urban'},
  Curve:{cls:'pill-curve',  label:'Curve'},
  Tour: {cls:'pill-tour',   label:'Tour'},
};
const PACE_META = {
  Easy:    {cls:'pill-easy',     label:'Easy'},
  Balanced:{cls:'pill-balanced', label:'Balanced'},
  Dynamic: {cls:'pill-dynamic',  label:'Dynamic'},
};

function meLocal() {
  let uid = null, name = null;
  try { uid = localStorage.getItem(LS_UID) || null; } catch(_){}
  try {
    const p = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if (p && p.name) name = String(p.name).trim();
  } catch(_){}
  return { uid, name };
}

/* GET ?action=listProfiles&ts=... */
async function loadProfiles(){
  const url = `${REG_URL}?action=listProfiles&ts=${Date.now()}`;
  const res = await fetch(url);
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(_) { throw new Error('Î™©Î°ù ÏùëÎãµ ÌååÏã± Ïã§Ìå®'); }
  if (!(json && json.ok && Array.isArray(json.data))) throw new Error('Î™©Î°ù ÌòïÏãù Ïò§Î•ò');
  return json.data;
}

/* ÎÇ¥ ÌîÑÎ°úÌïÑ Í≥†Ï†ï Ï†ïÎ†¨ */
function pinMineFirst(items){
  const me = meLocal();
  if (!me.uid && !me.name) return items.slice();

  const arr = items.slice();
  let myIdx = -1;

  // 1) uid ÏµúÏö∞ÏÑ†
  if (me.uid) myIdx = arr.findIndex(x => x.uid && String(x.uid) === me.uid);
  // 2) uid ÏóÜÏúºÎ©¥ Ïù¥Î¶Ñ Ìè¥Î∞±
  if (myIdx === -1 && me.name) {
    myIdx = arr.findIndex(x => x.name && String(x.name).trim() === me.name);
  }

  if (myIdx > -1) {
    const mine = arr.splice(myIdx, 1)[0];
    // ÎÇòÎ®∏ÏßÄ ÏµúÏã†Ïàú Ï†ïÎ†¨(ÏòµÏÖò)
    arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
    return [mine, ...arr];
  } else {
    // Î™ª Ï∞æÏúºÎ©¥ Ï†ÑÏ≤¥ ÏµúÏã†Ïàú
    return arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
  }
}

function tagEl(cls, text){
  const div = document.createElement('div');
  div.className = 'tag ' + cls;
  div.textContent = text;
  return div;
}

function renderList(items){
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';

  const me = meLocal();

  // ÎÇ¥ Ïπ¥Îìú ÏµúÏÉÅÎã® Í≥†Ï†ï
  const sorted = pinMineFirst(items);

  sorted.forEach(a=>{
    const card = document.createElement('article');
    const isMe = (me.uid && a.uid === me.uid) ||
                 (!me.uid && me.name && a.name && me.name === a.name);

    card.className = 'card' + (isMe ? ' me' : '');

    const head = document.createElement('div');
    head.className = 'head';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = a.icon || 'üèçÔ∏è';

    const idcol = document.createElement('div');
    idcol.className = 'idcol';

    const nameRow = document.createElement('div');
    nameRow.className = 'nameRow';

    const name = document.createElement('h3');
    name.className = 'name';
    name.textContent = a.name || 'ÎùºÏù¥Îçî';

    nameRow.appendChild(name);

    // ‚úÖ ÎÇ¥ ÌîÑÎ°úÌïÑ Î∞∞ÏßÄ
    if (isMe) {
      const badge = document.createElement('span');
      badge.className = 'meBadge';
      badge.textContent = 'ÎÇ¥ ÌîÑÎ°úÌïÑ';
      nameRow.appendChild(badge);
    }

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'matchBtn';
    if(isMe){
      btn.textContent = 'ÌîÑÎ°úÌïÑ ÏàòÏ†ï';
      btn.onclick = ()=> location.href='rimo_profile.html';
    }else{
      btn.innerHTML = 'ü§ù Îß§Ïπ≠Ìù¨Îßù';
      btn.onclick = ()=> alert('Îß§Ïπ≠Ìù¨Îßù ÏàòÏßëÏùÄ Í≥ß Ïó∞Í≤∞Îê©ÎãàÎã§ üôÇ');
    }
    nameRow.appendChild(btn);

    // intro(ÏÑ†ÌÉùÍ∞í)
    if (a.intro){
      const intro = document.createElement('p');
      intro.className = 'intro';
      intro.textContent = `"${String(a.intro).slice(0,25)}"`;
      idcol.appendChild(nameRow);
      idcol.appendChild(intro);
    } else {
      idcol.appendChild(nameRow);
    }

    const sub = document.createElement('p');
    sub.className = 'sub';
    const region = a.region ? `${a.region} ¬∑ ` : '';
    const bike   = a.bike || '';
    sub.textContent = `${region}${bike}`;
    idcol.appendChild(sub);

    head.appendChild(avatar);
    head.appendChild(idcol);

    // ÌÉúÍ∑∏
    const traits = document.createElement('div');
    traits.className = 'traits';
    const styles = Array.isArray(a.styles) ? a.styles : [];
    const pace   = Array.isArray(a.pace)   ? a.pace   : [];
    const all    = [
      ...styles.map(s => ({type:'style', key:s})),
      ...pace.map(p => ({type:'pace',  key:p}))
    ];

    if(all.length === 0){
      traits.appendChild(tagEl('style', '-'));
    }else{
      all.forEach(item=>{
        if(item.type==='style' && STYLE_META[item.key]){
          const m = STYLE_META[item.key];
          traits.appendChild(tagEl(`style ${m.cls}`, m.label));
        }else if(item.type==='pace' && PACE_META[item.key]){
          const m = PACE_META[item.key];
          traits.appendChild(tagEl(`pace ${m.cls}`, m.label));
        }else{
          traits.appendChild(tagEl(item.type, item.key));
        }
      });
    }

    card.appendChild(head);
    card.appendChild(traits);
    listEl.appendChild(card);
  });
}

(async function init(){
  const state = document.getElementById('stateMsg');
  if(state) state.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶';

  try{
    const items = await loadProfiles();
    if(state) state.remove();

    // ÏÑúÎ≤ÑÍ∞Ä region/introÎ•º ÎÑòÍ≤®Ï£ºÎØÄÎ°ú Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
    const normalized = items.map(r => ({
      uid: r.uid || '',
      icon: r.icon || 'üèçÔ∏è',
      name: r.name || 'ÎùºÏù¥Îçî',
      region: r.region || '',
      bike: r.bike || '',
      styles: Array.isArray(r.styles) ? r.styles : [],
      pace: Array.isArray(r.pace) ? r.pace : [],
      intro: r.intro || '',
      ts: r.ts || 0
    }));

    renderList(normalized);
  }catch(err){
    console.error(err);
    if(state) state.textContent = 'Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + err.message;
  }
})();
</script>
</body>
</html>
