<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì— ë²„ì„œë”</title>

<!-- âœ… ê³µí†µ í…Œë§ˆ -->
<link rel="stylesheet" href="rimo_theme.css?v=20250910" />

<style>
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif;
  }

  /* í—¤ë”(ê³µí†µ í†¤ + ì‚¬íŒŒë¦¬ ë¸”ëŸ¬) */
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9);
    -webkit-backdrop-filter:blur(8px);
    backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1);
  }
  .bar{display:flex; gap:10px; align-items:center; padding:14px 16px; height:56px}
  .logo{font-weight:900}
  .title{font-weight:800; opacity:.9}

  /* ë©”ì¸ í­ì€ rimo_theme.cssì—ì„œ í†µì¼ */
  main{display:flex; flex-direction:column; gap:12px}

  /* ì¹´ë“œ: ê³µí†µ í‘œë©´ì€ .amb-cardë¡œ ì ìš© */
  .card.amb-card{ padding:10px 12px; display:flex; flex-direction:column; gap:7px; margin-bottom:10px }
  /* ë‚´ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ëŠ” rimo_theme.cssì˜ .amb-card.me ì‚¬ìš© */

  .head{display:flex; gap:14px; align-items:center}
  .avatar{
    width:72px; height:72px; border-radius:50%;
    background:var(--surface-2); border:1px solid var(--border-2);
    font-size:36px; display:flex; align-items:center; justify-content:center; flex:0 0 auto;
  }
  .idcol{min-width:0; flex:1}
  .nameRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .name{
    margin:0; font-size:16px; font-weight:800; line-height: 1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .meBadge{
    padding:3px 7px;
    font-size:11px; font-weight:800;
    color:#cfe0ff;
    background:rgba(122,167,255,.15);
    border:1px solid rgba(122,167,255,.35);
    border-radius:999px;
  }
  .intro{
    margin:4px 0 0;
    font-weight:600;
    font-size:13px;
    color:var(--fg);
  }
  .sub{margin:6px 0 0; color:var(--muted); font-size:13px}

  .matchBtn{
    margin-left:auto;
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 8px; border-radius:999px;
    background:var(--surface-2); border:1px solid var(--border-2); color:#e6e9ff;
    font-size:12px; font-weight:600; cursor:pointer;
    transition:box-shadow .15s ease, transform .15s ease, border-color .15s ease, background-color .15s ease;
  }
  .matchBtn.active{
    border-color:var(--accent);
    background:rgba(122,167,255,.16);
    box-shadow:0 0 12px rgba(122,167,255,.5), 0 0 0 2px rgba(122,167,255,.25) inset;
    transform:translateY(-1px);
  }

  /* ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤ íƒœê·¸ */
  .traits{
    display:grid;
    grid-template-columns:repeat(6, max-content);
    gap:6px;
    justify-content:flex-start;
  }
.tag{ padding:var(--pill-py) var(--pill-px); font-size:var(--pill-font); }
 
  .tag.style.pill-urban   {background:#1e2d55;border-color:#2c4484}
  .tag.style.pill-curve   {background:#2a1f56;border-color:#40307a}
  .tag.style.pill-tour    {background:#1e3b3a;border-color:#2f5f5d}
  .tag.pace.pill-easy     {background:#1f3a1f;border-color:#2f5a2f}
  .tag.pace.pill-balanced {background:#3a341e;border-color:#5a4f2f}
  .tag.pace.pill-dynamic  {background:#3a1f1f;border-color:#5a2f2f}

  /* í•˜ë‹¨ ë„¤ë¹„ëŠ” rimo_theme.cssë¡œ í†µì¼ë¨ */

  /* === ë§¤ì¹­ DM ëª¨ë‹¬: ìŠ¤í¬ë¡¤ + ë²„íŠ¼ ê³ ì • === */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:3000;
         background:rgba(0,0,0,.45); padding:22px 12px}
  .modal.show{display:flex}
  .sheet{width:100%; max-width:680px}
  .sheet.panel{max-height:88vh; display:flex; flex-direction:column}
  .sheet h4{margin:4px 0 10px; font-size:18px}
  .hint{color:#cfd2ff; line-height:1.5; margin-bottom:10px}
  .pre{max-height:48vh; overflow:auto; white-space:pre-wrap; line-height:1.4}
  .modal-actions{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    position:sticky; bottom:0;
    background:linear-gradient(180deg, rgba(14,18,34,0) 0%, var(--surface-1) 40%);
    padding-top:12px; margin-top:12px; border-top:1px solid var(--border-1);
  }
  .modal-actions button{
    flex:1; min-width:130px; max-width:220px; padding:12px 18px; border-radius:12px; border:none;
    background:#2A2F4F; color:#fff; font-size:15px; font-weight:700; cursor:pointer
  }
  .modal-actions button:hover{background:#3C4380}

  /* í† ìŠ¤íŠ¸ 2ì´ˆ ìœ ì§€ */
  .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); padding:10px 14px;
         background:rgba(0,0,0,.78); color:#fff; border-radius:10px; font-size:13px; display:none; z-index:5000;
         border:1px solid rgba(255,255,255,.12)}
  .toast.show{display:block; animation:fade 2s ease}
  @keyframes fade{0%{opacity:0;transform:translateX(-50%) translateY(6px)}
                  10%{opacity:1;transform:translateX(-50%) translateY(0)}
                  90%{opacity:1}
                  100%{opacity:0}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ì— ë²„ì„œë”</div>
  </div>
</header>

<main>
  <section id="list" aria-label="ì— ë²„ì„œë” ëª©ë¡">
    <div class="state" id="stateMsg" style="color:var(--muted); text-align:center; padding:24px 0; font-size:13px">
      ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦
    </div>
  </section>
</main>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab primary">ì— ë²„ì„œë”</a>
</nav>

<!-- âœ… ë§¤ì¹­í¬ë§ DM ëª¨ë‹¬ -->
<div class="modal" id="dmModal" role="dialog" aria-modal="true" aria-labelledby="dmTitle">
  <div class="sheet panel" id="dmSheet">
    <h4 id="dmTitle">ğŸ¤ ë§¤ì¹­ í¬ë§ DM ë³´ë‚´ê¸°</h4>
    <div class="hint">
      ì•„ë˜ ë©”ì‹œì§€ê°€ ìë™ ë³µì‚¬ë©ë‹ˆë‹¤. <b>ì¹´ì¹´ì˜¤ 1:1 ì±„íŒ…</b>ì„ ì—´ì–´ <b>ë¶™ì—¬ ë„£ê¸°</b>ë§Œ í•˜ì„¸ìš”.
    </div>
    <div id="dmPreview" class="pre panel" style="padding:12px"></div>
    <div class="modal-actions">
      <button id="openDM">ì¹´ì¹´ì˜¤í†¡ ì—´ê¸°</button>
      <button id="copyDM">ë‹¤ì‹œ ë³µì‚¬</button>
      <button id="editProfile">í”„ë¡œí•„ ìˆ˜ì •</button>
      <button id="closeDM">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== ì„¤ì • ===== */
const REG_URL   = "https://script.google.com/macros/s/AKfycbwHArsmGi2vsSfUsAgPLjMIG8p3iC_n3xryML6XETFPViQIDpYG0DGTSqIUejdz0Ss/exec";
const LS_KEY    = 'rimo_profile_v1';  // ë‚´ í”„ë¡œí•„ ë¡œì»¬
const LS_UID    = 'rimo_uid_v1';      // ë‚´ uid ë¡œì»¬
const ADMIN_DM  = "http://pf.kakao.com/_ceUDn/chat"; // ìš´ì˜ì 1:1 ì±„ë„

/* íƒœê·¸ ë©”íƒ€ */
const STYLE_META = {
  Urban:{cls:'pill-urban',  label:'Urban'},
  Curve:{cls:'pill-curve',  label:'Curve'},
  Tour: {cls:'pill-tour',   label:'Tour'},
};
const PACE_META = {
  Easy:    {cls:'pill-easy',     label:'Easy'},
  Balanced:{cls:'pill-balanced', label:'Balanced'},
  Dynamic: {cls:'pill-dynamic',  label:'Dynamic'},
};

/* í† ìŠ¤íŠ¸ 2ì´ˆ */
function showToast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.animationDuration=(ms/1000)+'s';
  t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer=setTimeout(()=>t.classList.remove('show'), ms);
}

function meLocal() {
  let uid = null, profile = {};
  try { uid = localStorage.getItem(LS_UID) || null; } catch(_){}
  try { profile = JSON.parse(localStorage.getItem(LS_KEY) || 'null') || {}; } catch(_){}
  return { uid, profile };
}

/* ì„œë²„ì—ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°(GET) */
async function loadProfiles(){
  const url = `${REG_URL}?action=listProfiles&ts=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store'});
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(_) { throw new Error('ëª©ë¡ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'); }
  if (!(json && json.ok && Array.isArray(json.data))) throw new Error('ëª©ë¡ í˜•ì‹ ì˜¤ë¥˜');
  return json.data;
}

/* ë‚´ í”„ë¡œí•„ ë§¨ ìœ„ ê³ ì • + ë‚˜ë¨¸ì§€ëŠ” ìµœì‹ ìˆœ(ts DESC) */
function pinMineFirst(items){
  const me = meLocal();
  const myName = (me.profile && me.profile.name) ? String(me.profile.name).trim() : null;

  const arr = items.slice();
  let myIdx = -1;
  if (me.uid) myIdx = arr.findIndex(x => x.uid && String(x.uid) === me.uid);
  if (myIdx === -1 && myName) myIdx = arr.findIndex(x => x.name && String(x.name).trim() === myName);

  if (myIdx > -1) {
    const mine = arr.splice(myIdx, 1)[0];
    arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
    return [mine, ...arr];
  } else {
    return arr.sort((a,b) => (b.ts || 0) - (a.ts || 0));
  }
}

function tagEl(cls, text){
  const div = document.createElement('div');
  div.className = 'tag ' + cls;
  div.textContent = text;
  return div;
}

/* ë Œë” */
function renderList(items){
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';

  const me = meLocal();
  const myName = (me.profile && me.profile.name) ? String(me.profile.name).trim() : null;
  const sorted = pinMineFirst(items);

  sorted.forEach(a=>{
    const isMe = (me.uid && a.uid === me.uid) ||
                 (!me.uid && myName && a.name && myName === a.name);

    const card = document.createElement('article');
    card.className = 'card amb-card' + (isMe ? ' me' : '');

    const head = document.createElement('div');
    head.className = 'head';

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = a.icon || 'ğŸï¸';

    const idcol = document.createElement('div');
    idcol.className = 'idcol';

    const nameRow = document.createElement('div');
    nameRow.className = 'nameRow';

    const name = document.createElement('h3');
    name.className = 'name';
    name.textContent = a.name || 'ë¼ì´ë”';

    nameRow.appendChild(name);

    if (isMe) {
      const badge = document.createElement('span');
      badge.className = 'meBadge';
      badge.textContent = 'ë‚´ í”„ë¡œí•„';
      nameRow.appendChild(badge);
    }

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'matchBtn';
    if(isMe){
      btn.textContent = 'í”„ë¡œí•„ ìˆ˜ì •';
      btn.onclick = ()=> location.href='rimo_profile.html';
    }else{
      btn.innerHTML = 'ğŸ¤ ë§¤ì¹­í¬ë§';
      btn.onclick = ()=> openDMModal(a); // âœ… DM ëª¨ë‹¬ ì˜¤í”ˆ
    }
    nameRow.appendChild(btn);

    // ì†Œê°œ
    if (a.intro){
      const intro = document.createElement('p');
      intro.className = 'intro';
      intro.textContent = `"${String(a.intro).slice(0,25)}"`;
      idcol.appendChild(nameRow);
      idcol.appendChild(intro);
    } else {
      idcol.appendChild(nameRow);
    }

    // ì§€ì—­ Â· ê¸°ì¢…
    const sub = document.createElement('p');
    sub.className = 'sub';
    const region = a.region ? `${a.region} Â· ` : '';
    const bike   = a.bike || '';
    sub.textContent = `${region}${bike}`;
    idcol.appendChild(sub);

    head.appendChild(avatar);
    head.appendChild(idcol);

    // ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤
    const traits = document.createElement('div');
    traits.className = 'traits';
    const styles = Array.isArray(a.styles) ? a.styles : [];
    const pace   = Array.isArray(a.pace)   ? a.pace   : [];
    const all    = [
      ...styles.map(s => ({type:'style', key:s})),
      ...pace.map(p => ({type:'pace',  key:p}))
    ];
    if(all.length === 0){
      traits.appendChild(tagEl('style', '-'));
    }else{
      all.forEach(item=>{
        if(item.type==='style' && STYLE_META[item.key]){
          const m = STYLE_META[item.key];
          traits.appendChild(tagEl(`style ${m.cls}`, m.label));
        }else if(item.type==='pace' && PACE_META[item.key]){
          const m = PACE_META[item.key];
          traits.appendChild(tagEl(`pace ${m.cls}`, m.label));
        }else{
          traits.appendChild(tagEl(item.type, item.key));
        }
      });
    }

    card.appendChild(head);
    card.appendChild(traits);
    listEl.appendChild(card);
  });
}

/* ====== DM ëª¨ë‹¬ ====== */
const dmModal   = document.getElementById('dmModal');
const dmSheet   = document.getElementById('dmSheet');
const dmPreview = document.getElementById('dmPreview');

function composeDM(me, target){
  const stylesT = (target.styles||[]).join(' Â· ') || '-';
  const paceT   = (target.pace||[]).join(' Â· ') || '-';

  return (
`[ğŸ¤ ë§¤ì¹­ í¬ë§] ${target.name || ''}
ğŸ’¬ ì†Œê°œ: ${target.intro || '-'}

ğŸï¸ ê¸°ì¢…: ${target.bike || '-'}
ğŸ“ ì§€ì—­: ${target.region || '-'}  |  ğŸ‘¥ íƒ ë¤: ${target.tandem || '-'}
â° ì‹œê°„: ${target.time || '-'}
ğŸ¯ ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤: ${stylesT} / ${paceT}

* ìœ„ ë¼ì´ë”ì™€ ë§¤ì¹­ í¬ë§í•©ë‹ˆë‹¤.`
  );
}

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){
    const ta=document.createElement('textarea');
    ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
    return true;
  }
}

let _currentTarget = null;
function openDMModal(target){
  _currentTarget = target;
  const me = meLocal();
  const txt = composeDM(me, target);
  dmPreview.textContent = txt;
  copyText(txt).then(()=> showToast('ë©”ì‹œì§€ ë³µì‚¬ ì™„ë£Œ'));
  dmModal.classList.add('show');
}
function closeDMModal(){
  dmModal.classList.remove('show');
  _currentTarget = null;
}

document.getElementById('openDM').onclick = ()=> window.open(ADMIN_DM, '_blank');
document.getElementById('copyDM').onclick = ()=> copyText(dmPreview.textContent).then(()=> showToast('ë‹¤ì‹œ ë³µì‚¬ ì™„ë£Œ'));
document.getElementById('editProfile').onclick = ()=> location.href='rimo_profile.html';
document.getElementById('closeDM').onclick = closeDMModal;
dmModal.addEventListener('click', closeDMModal);
dmSheet.addEventListener('click', e=>e.stopPropagation());

/* ====== ë¶€íŠ¸ ====== */
(async function init(){
  const state = document.getElementById('stateMsg');
  if(state) state.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

  try{
    const items = await loadProfiles();
    if(state) state.remove();

    // ì •ê·œí™”(ë°©íƒ„)
    const normalized = items.map(r => {
      let intro = r.intro || '';
      if (!intro && r.raw) {
        try {
          const raw = typeof r.raw === 'string' ? JSON.parse(r.raw) : r.raw;
          intro = raw && raw.intro ? String(raw.intro) : '';
        } catch(_) {}
      }
      intro = String(intro).slice(0,25);

      return {
        uid: r.uid || '',
        icon: r.icon || 'ğŸï¸',
        name: r.name || 'ë¼ì´ë”',
        region: r.region || '',
        bike: r.bike || '',
        styles: Array.isArray(r.styles) ? r.styles : [],
        pace: Array.isArray(r.pace) ? r.pace : [],
        intro,
        time: r.time || '',
        tandem: r.tandem || '',
        ts: r.ts || 0
      };
    });

    renderList(normalized);
  }catch(err){
    console.error(err);
    if(state) state.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message;
  }
})();
</script>
</body>
</html>
