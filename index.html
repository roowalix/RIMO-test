<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 오늘의 라이딩 크루</title>

<!-- 필요시 유지 -->
<link rel="stylesheet" href="rimo_theme.css?v=20250911">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

<style>
  :root{
    --btn:#2A2F4F; --btnHover:#3C4380;
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);

    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;

    --border-1:#2b304f;
    --muted:#b9b9cc;
  }

  *{box-sizing:border-box}
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif; background:#0b0b0f; color:#e8e8ef}

  /* 헤더 */
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9);
    -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1);
  }
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* 본문 */
  main{padding:16px;max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1); background:#0e1222}
  .leaflet-container{z-index:1}

  /* 카드 캐러셀 */
  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{
    scroll-snap-align:start;width:304px;flex:0 0 auto;border-radius:14px;padding:14px;
    display:flex;flex-direction:column;gap:8px;border:1px solid transparent;position:relative
  }
  .card h3{margin:0 0 2px;font-size:18px}
  .meta{font-size:14px;color:var(--muted)}
  .msg{font-size:14px}

  /* 칩(=필) */
  .pillrow{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
  .chip{
    padding:6px 9px; border-radius:999px; font-size:12px; font-weight:500;
    display:inline-flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#e6e8ef;
  }
  .chip.pill-urban   {background:#1e2d55; border-color:#2c4484}
  .chip.pill-curve   {background:#2a1f56; border-color:#40307a}
  .chip.pill-tour    {background:#1e3b3a; border-color:#2f5f5d}
  .chip.pill-easy    {background:#1f3a1f; border-color:#2f5a2f}
  .chip.pill-balanced{background:#3a341e; border-color:#5a4f2f}
  .chip.pill-dynamic {background:#3a1f1f; border-color:#5a2f2f}

  /* 출발 임박 배지 */
  .imminent{
    position:absolute; top:10px; right:10px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:700;
    background:var(--imminent-bg); border:1px solid var(--imminent-bd); color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* 합류 버튼 */
  .join{margin-top:2px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;
        background:rgba(255,255,255,.16);cursor:pointer}
  .card.selected{box-shadow:0 0 0 2px rgba(255,255,255,.12) inset}

  /* 지도 핀 */
  .pin{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
       font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35)}

  /* 모달 */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:4000;
         background:rgba(0,0,0,.45);padding:22px 12px}
  .modal.show{display:flex}
  #joinSheet.panel{
    width:calc(100% - 24px); max-width:680px;
    background:#0e1222; border:1px solid #2b304f; border-radius:18px; box-shadow:0 14px 40px rgba(0,0,0,.55);
    padding:16px 16px 20px;
  }
  #joinSheet h4{margin:4px 0 10px;font-size:18px}
  .hint{color:#cfd2ff;line-height:1.5;margin-bottom:10px}
  #preview.pre{
    background:#0b1020; border:1px solid #293059; border-radius:12px;
    padding:12px; white-space:pre-wrap; line-height:1.4;
    min-height:96px; max-height:42vh; overflow:auto; color:#e6e9ff;
  }
  .modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;padding-bottom:6px}
  .modal-actions button{flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;
                        background:var(--btn);color:#fff;font-size:15px;font-weight:700;cursor:pointer}
  .modal-actions button:hover{background:var(--btnHover)}

  /* 하단 네비 */
  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);
               padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}
  body.modal-open .tabbar{pointer-events:none;opacity:.28;filter:saturate(.2) blur(1px);transform:translateY(2px)}

  .filter-btn{display:none !important}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">오늘의 라이딩 크루</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map" class="panel"></div>
  <section id="list" class="carousel"></section>
</main>

<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab primary">메인</a>
  <a href="rimo_profile.html" class="tab">프로필</a>
  <a href="rimo_ambassadors.html" class="tab">엠버서더</a>
</nav>

<!-- 합류 안내 모달 -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
  <div class="sheet panel" id="joinSheet">
    <h4 id="joinTitle">✅ 합류 신청하기</h4>
    <div class="hint">아래 버튼으로 <b>운영자 1:1 채팅</b>을 열어 붙여 넣어 주세요. 승인되면 라이더 크루 채팅방으로 초대됩니다.</div>
    <div id="preview" class="pre"></div>
    <div class="modal-actions">
      <button id="goAdmin">이대로 신청하기</button>
      <button id="editProfile">프로필 수정</button>
      <button id="copyProfileBtn">다시 복사</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ========= 상수 ========= */
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";
const LS_PROFILE = 'rimo_profile_v1';
const LS_APPS    = 'rimo_applications_v1';
const LS_CACHE   = 'rimo_crews_cache_v1';

/* ★ Apps Script 웹앱 주소(요청하신 새 주소) */
const API = "https://script.google.com/macros/s/AKfycbxWLEa5-oxPQYuxQTYXInrePIBU3jbJZZf2lNFkasERyv3pftmC1niT78GZ5tVJ7i_cMQ/exec";

/* ========= 테마 팔레트 ========= */
const THEMES = {
  red:    { base:'#ff4d4d', cardBg:'rgba(255,77,77,.14)',  border:'rgba(255,77,77,.55)'},
  yellow: { base:'#ffd24d', cardBg:'rgba(255,210,77,.16)', border:'rgba(255,210,77,.55)'},
  blue:   { base:'#5b8cff', cardBg:'rgba(91,140,255,.16)', border:'rgba(91,140,255,.55)'},
  green:  { base:'#46d37d', cardBg:'rgba(70,211,125,.16)', border:'rgba(70,211,125,.55)'},
  purple: { base:'#a78bfa', cardBg:'rgba(167,139,250,.16)', border:'rgba(167,139,250,.55)'}
};

/* ========= 날짜/포맷 ========= */
document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

function pad(n){return String(n).padStart(2,'0')}
function formatKDate(dt){return `${dt.getMonth()+1}월 ${dt.getDate()}일 ${pad(dt.getHours())}:${pad(dt.getMinutes())}`}

/* ========= 지도 ========= */
const map=L.map('map',{scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const group=L.featureGroup().addTo(map);
const arcs=L.layerGroup().addTo(map);

function makePin(color,label){
  return L.divIcon({className:'pin',
    html:`<div class="pin" style="background:${color}">${label}</div>`,
    iconSize:[28,28],iconAnchor:[14,14]
  });
}
function arcCoords(aLat,aLng,bLat,bLng,k=0.18){
  const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;
  const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;
  const nx=-vy/len,ny=vx/len; let off=len*k; if(off<0.01) off=0.01;
  const cx=mx+nx*off,cy=my+ny*off; return [[y1,x1],[cy,cx],[y2,x2]];
}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const ms=L.marker([c.lat,c.lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.toLat,c.toLng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.lat,c.lng,c.toLat,c.toLng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng()));
    a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}

/* ========= 칩 색 ========= */
function chipClass(label){
  switch(String(label).toLowerCase()){
    case 'urban':    return 'pill-urban';
    case 'curve':    return 'pill-curve';
    case 'tour':     return 'pill-tour';
    case 'easy':     return 'pill-easy';
    case 'balanced': return 'pill-balanced';
    case 'dynamic':  return 'pill-dynamic';
    default:         return '';
  }
}
function chip(label){ return `<span class="chip ${chipClass(label)}">${label}</span>`; }

/* ========= 서버 로딩 (list → 폴백 3단) ========= */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb = '__rimo_cb_'+Date.now();
    const s = document.createElement('script');
    const t = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb] = data => { cleanup(); resolve(data); };
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadFromServer(){
  // 1) ?action=list (JSON)
  try{
    const r = await fetch(`${API}?action=list`, {cache:'no-store'});
    if(r.ok){
      const j = await r.json();
      const arr = Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : []);
      if(arr.length){ localStorage.setItem(LS_CACHE, JSON.stringify(arr)); return arr; }
    }
  }catch(_){}
  // 2) ?op=list (JSON)
  try{
    const r2 = await fetch(`${API}?op=list`, {cache:'no-store'});
    if(r2.ok){
      const j2 = await r2.json();
      const arr = Array.isArray(j2?.items) ? j2.items : (Array.isArray(j2) ? j2 : []);
      if(arr.length){ localStorage.setItem(LS_CACHE, JSON.stringify(arr)); return arr; }
    }
  }catch(_){}
  // 3) JSONP
  try{
    const j3 = await fetchJSONP(`${API}?op=list`);
    const arr = Array.isArray(j3?.items) ? j3.items : (Array.isArray(j3) ? j3 : []);
    if(arr.length){ localStorage.setItem(LS_CACHE, JSON.stringify(arr)); return arr; }
  }catch(_){}
  // 4) 캐시
  try{ return JSON.parse(localStorage.getItem(LS_CACHE)||'[]'); }catch(_){ return []; }
}

/* ========= 서버 데이터 → 화면용 정규화 ========= */
function toNum(n, fallback=null){
  const v = Number(n); return Number.isFinite(v) ? v : (fallback===null?null:fallback);
}
function normalize(item){
  // Apps Script가 주는 필드 이름/형식을 넉넉히 커버
  const theme = item.theme || 'blue';
  const title = item.title || '(제목 없음)';
  const from  = item.from  || item.start || '출발지';
  const to    = item.to    || item.end   || '도착지';

  // 시간
  let dtISO = item.datetime || item.date || null;
  let dt    = dtISO ? new Date(dtISO) : null;
  let timeDisplay = item.datetime_display || (dt ? formatKDate(dt) : (item.time || ''));

  // 좌표
  const lat   = toNum(item.from_lat, toNum(item.lat, 37.5665));
  const lng   = toNum(item.from_lng, toNum(item.lng, 126.9780));
  const toLat = toNum(item.to_lat,   toNum(item.toLat, 37.55));
  const toLng = toNum(item.to_lng,   toNum(item.toLng, 127.0));

  // 인원 (remaining=잔여, capacity=정원)
  const capacity  = toNum(item.capacity, toNum(item.peopleMax, 0)) || 0;
  const remaining = toNum(item.remaining, null);
  const joined = (remaining===null || remaining===undefined)
                 ? toNum(item.peopleNow, 0)
                 : Math.max(0, capacity - Math.max(0, remaining));
  const peopleNow = Math.min(Math.max(0, joined||0), capacity||0);
  const peopleMax = capacity || Math.max(peopleNow, 0);

  // 스타일/페이스
  const styles = Array.isArray(item.styles) ? item.styles
                 : String(item.styles||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean);
  const pace   = Array.isArray(item.pace) ? item.pace
                 : String(item.pace||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean);

  return {
    id: item.id || ('crew_'+Math.random().toString(36).slice(2,7)),
    theme, title, from, to,
    lat, lng, toLat, toLng,
    datetime: dtISO, time: timeDisplay,
    msg: item.message || item.msg || '',
    cc: item.cc || '',
    styles, pace,
    peopleNow, peopleMax
  };
}

/* ========= 만료/정렬 ========= */
/** 출발시간 + 5분 기준으로 화면에서 숨김 */
function isVisible(crew){
  if(!crew.datetime) return true; // 안전망
  const start = new Date(crew.datetime).getTime();
  const now   = Date.now();
  return now <= start + 5*60*1000; // 출발 + 5분까지 표시
}
/** 임박 여부(배지 표시용): 20분 이내 출발 */
function isImminent(crew){
  if(!crew.datetime) return false;
  const start = new Date(crew.datetime).getTime();
  const now   = Date.now();
  return (start - now) <= 20*60*1000 && (start - now) >= 0;
}

/* ========= 카드 렌더 ========= */
const listEl=document.getElementById('list');

function renderCards(crews){
  listEl.innerHTML="";
  if(!crews.length){
    // 데모 카드(최초 사용성 보장)
    const demo=[{
      id:"demo1", theme:"blue", title:"<예시 카드 — 관리자에서 발행하세요>",
      time:"10월 10일 19:00", from:"출발지", to:"도착지",
      lat:37.5665, lng:126.9780, toLat:37.55, toLng:127.0,
      peopleNow:0, peopleMax:4, styles:["Urban","Easy"], cc:"", msg:"관리자 페이지에서 발행하면 이 예시는 사라집니다."
    }];
    renderMap(demo);
    demo.forEach(drawCard);
    return;
  }
  renderMap(crews);
  crews.forEach(drawCard);
}

function drawCard(c){
  const t=THEMES[c.theme]||THEMES.blue;
  const el=document.createElement('article');
  el.className="card"; el.dataset.id=c.id;
  el.style.background=t.cardBg; el.style.border=`1px solid ${t.border}`;
  const immin = isImminent(c);

  el.innerHTML=`
    <h3>${c.title}</h3>
    <div class="meta">⏰ ${c.time || ''}</div>
    <div class="meta">📍 ${c.from} → ${c.to}</div>
    <div class="msg">💬 ${c.msg || '-'}</div>
    ${immin ? `<div class="imminent">🚦 출발 임박</div>` : ``}
    <div class="pillrow">
      ${(c.styles||[]).map(chip).join("")}
      ${(c.pace||[]).map(chip).join("")}
      ${c.cc ? chip(c.cc) : ""}
    </div>
    <button class="join">👥 ${c.peopleNow||0}/${c.peopleMax||0} · ✅ 합류 신청</button>
  `;
  el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));
  listEl.appendChild(el);
}

/* ========= 모달 & 합류 텍스트 ========= */
const modal=document.getElementById('joinModal');
const sheet=document.getElementById('joinSheet');
const preview=document.getElementById('preview');

function closeJoinModal(){ modal.classList.remove('show'); document.body.classList.remove('modal-open'); }
modal.addEventListener('click', closeJoinModal);
sheet.addEventListener('click', e=>e.stopPropagation());

document.getElementById('editProfile').onclick=()=> location.href='rimo_profile.html';

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_PROFILE)||'{}'); }catch(_){ return {}; } }
function composeText(crew, profile){
  const styles=(profile.styles||[]).join(' · ') || '-';
  const paces =(profile.pace  ||[]).join(' · ') || '-';
  return (
`[✅ 합류 신청] ${crew.title}
📍 출발 → 도착
${crew.from} → ${crew.to}

👤 라이더 : ${profile.name || '이름 미입력'} ${profile.icon || ''}
🏍️ 바이크 : ${profile.bike || '미입력'}
⏰ 선호 시간대 : ${profile.time || '-'}
👥 탠덤 : ${profile.tandem ? '탠덤 ' + profile.tandem : '-'}

🎯 스타일/페이스
${styles} · ${paces}`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove(); return true; }
}
function saveApplication(crew, text){
  let apps=[]; try{ apps=JSON.parse(localStorage.getItem(LS_APPS)||'[]'); }catch(_){ apps=[]; }
  apps.unshift({ id:'app'+Math.random().toString(36).slice(2,7), ts:Date.now(),
                 crewId:crew.id, title:crew.title, from:crew.from, to:crew.to, text });
  localStorage.setItem(LS_APPS, JSON.stringify(apps));
}
function openJoinModal(crew){
  const profile=loadProfile();
  const text=composeText(crew, profile);
  preview.textContent=text;
  copyText(text);
  document.body.classList.add('modal-open');
  modal.classList.add('show');
  document.getElementById('goAdmin').onclick=()=>{ saveApplication(crew, text); location.href=ADMIN_DM; };
  document.getElementById('copyProfileBtn').onclick=()=> copyText(text);
}

/* ========= 메인 로직 ========= */
async function refresh(){
  // 서버에서 불러와 정규화 → 만료 필터 → 날짜 오름차순 정렬
  let raw = await loadFromServer();
  let arr = raw.map(normalize)
               .filter(isVisible)
               .sort((a,b)=>{
                 const ta = a.datetime ? new Date(a.datetime).getTime() : 0;
                 const tb = b.datetime ? new Date(b.datetime).getTime() : 0;
                 return ta - tb;
               });
  renderCards(arr);
}

(async function init(){
  await refresh();
  // 1분마다 자동 갱신(만료 처리 포함)
  setInterval(refresh, 60*1000);
})();
</script>
</body>
</html>
