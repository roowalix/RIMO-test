<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</title>

<!-- âœ… ê³µí†µ í…Œë§ˆ(ìƒ‰/í­) -->
<link rel="stylesheet" href="rimo_theme.css?v=20250911">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

<style>
  :root{
    /* ì´ í˜ì´ì§€ í† í° */
    --chip:#1a1a24; --chipBd:#2f3247;
    --btn:#2A2F4F; --btnHover:#3C4380;
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);

    /* tabbar (ê³µí†µì€ theme.css, ì—¬ê¸°ì„  ë®ì–´ì“°ê¸°) */
    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif;
  }

  /* í—¤ë” */
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9);
    -webkit-backdrop-filter:blur(8px);
    backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1);
  }
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* ë³¸ë¬¸ */
  main{display:flex;flex-direction:column;gap:12px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1);margin-bottom:20px}
  .leaflet-container{z-index:1}

  /* ì¹´ë“œ ìºëŸ¬ì…€ */
  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{
    scroll-snap-align:start;width:304px;flex:0 0 auto;border-radius:14px;padding:14px;
    display:flex;flex-direction:column;gap:8px;border:1px solid transparent;position:relative
  }
  .card h3{margin:0 0 2px;font-size:18px}
  .meta{font-size:14px;color:var(--muted)}
  .msg{font-size:14px}
  .pillrow{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
  .chip{
    padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);font-size:12px;white-space:nowrap;display:inline-flex;align-items:center;justify-content:center
  }

  /* ë©”ì¸ ì¹©ì„ ê³µí†µ Pill ìŠ¤íƒ€ì¼ë¡œ ê°•ì œ */
  .carousel .chip{
    background:var(--pill-bg) !important;
    border-color:var(--pill-bd) !important;
    color:var(--pill-ink) !important;
    padding:var(--pill-py) var(--pill-px) !important;
    font-size:var(--pill-font) !important;
  }

  /* ì¶œë°œ ì„ë°• ë°°ì§€ */
  .imminent{
    position:absolute; top:10px; right:10px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:700;
    background:var(--imminent-bg); border:1px solid var(--imminent-bd); color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* í•©ë¥˜ ë²„íŠ¼ */
  .join{margin-top:2px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;
        background:rgba(255,255,255,.16);cursor:pointer}
  .card.selected{box-shadow:0 0 0 2px rgba(255,255,255,.12) inset}

  /* í•€ ì•„ì´ì½˜(ì§€ë„) */
  .pin{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35)
  }

  /* ëª¨ë‹¬(í•©ë¥˜ ì•ˆë‚´) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000;
         background:rgba(0,0,0,.45);padding:22px 12px}
  .modal.show{display:flex}
  .sheet{max-width:680px}
  .sheet h4{margin:4px 0 10px;font-size:18px}
  .hint{color:#cfd2ff;line-height:1.5;margin-bottom:10px}
  .pre{border-radius:12px;white-space:pre-wrap;line-height:1.4}
  .modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
  .modal-actions button{flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;
                        background:var(--btn);color:#fff;font-size:15px;font-weight:700;cursor:pointer}
  .modal-actions button:hover{background:var(--btnHover)}

  /* í•˜ë‹¨ ë„¤ë¹„ */
  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:2500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);
               padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}

  /* === í•„í„° ë°”(ì— ë²„ì„œë” ì¹©ê³¼ ë™ì¼ ë£©) === */
  .pill-bar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 16px 0}
  .pill-btn{
    appearance:none; border-radius:999px; cursor:pointer;
    padding:8px 12px; font-weight:800; font-size:12px;
    border:1px solid var(--pill-bd, #2b2e54);
    background:var(--pill-bg, #1a1c2f);
    color:var(--pill-ink, #e6e9ff);
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
  }
  .pill-btn:is(:hover,.is-active){
    transform:translateY(-1px) scale(1.02);
    box-shadow:0 0 12px rgba(122,167,255,.45), 0 0 0 2px rgba(122,167,255,.25) inset;
  }
  .pill-btn--urban   { --pill-bg:#1e2d55; --pill-bd:#2c4484; }
  .pill-btn--curve   { --pill-bg:#2a1f56; --pill-bd:#40307a; }
  .pill-btn--tour    { --pill-bg:#1e3b3a; --pill-bd:#2f5f5d; }
  .pill-btn--easy    { --pill-bg:#1f3a1f; --pill-bd:#2f5a2f; }
  .pill-btn--balanced{ --pill-bg:#3a341e; --pill-bd:#5a4f2f; }
  .pill-btn--dynamic { --pill-bg:#3a1f1f; --pill-bd:#5a2f2f; }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <!-- âœ… í•„í„° ë°” -->
  <div class="pill-bar" id="filters">
    <button type="button" class="pill-btn pill-btn--urban"   data-key="Urban">Urban</button>
    <button type="button" class="pill-btn pill-btn--curve"   data-key="Curve">Curve</button>
    <button type="button" class="pill-btn pill-btn--tour"    data-key="Tour">Tour</button>
    <button type="button" class="pill-btn pill-btn--easy"    data-key="Easy">Easy</button>
    <button type="button" class="pill-btn pill-btn--balanced"data-key="Balanced">Balanced</button>
    <button type="button" class="pill-btn pill-btn--dynamic" data-key="Dynamic">Dynamic</button>
  </div>

  <div id="map" class="panel"></div>
  <section id="list" class="carousel"></section>
</main>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab primary">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- í•©ë¥˜ ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
  <div class="sheet panel" id="joinSheet">
    <h4 id="joinTitle">âœ… í•©ë¥˜ ì‹ ì²­í•˜ê¸°</h4>
    <div class="hint">
      ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ <b>ìš´ì˜ì 1:1 ì±„íŒ…</b>ì„ ì—´ì–´ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”. ìŠ¹ì¸ë˜ë©´ ë¼ì´ë” í¬ë£¨ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ˆëŒ€ë©ë‹ˆë‹¤.
    </div>
    <div id="preview" class="pre"></div>
    <div class="modal-actions">
      <button id="goAdmin">ì´ëŒ€ë¡œ ì‹ ì²­í•˜ê¸°</button>
      <button id="editProfile">í”„ë¡œí•„ ìˆ˜ì •</button>
      <button id="copyProfileBtn">ë‹¤ì‹œ ë³µì‚¬</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ê³µí†µ */
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";
const LS_KEY   = 'rimo_profile_v1';
const LS_CREWS = 'rimo_crews_v1';
const LS_APPS  = 'rimo_applications_v1';

/* ì¹´ë“œ/í•€/ëŒ€ì‹œë¼ì¸ í…Œë§ˆ */
const THEMES = {
  red:    { base:'#ff4d4d', cardBg:'rgba(255,77,77,.14)',  border:'rgba(255,77,77,.55)'},
  yellow: { base:'#ffd24d', cardBg:'rgba(255,210,77,.16)', border:'rgba(255,210,77,.55)'},
  blue:   { base:'#5b8cff', cardBg:'rgba(91,140,255,.16)', border:'rgba(91,140,255,.55)'},
  green:  { base:'#46d37d', cardBg:'rgba(70,211,125,.16)', border:'rgba(70,211,125,.55)'}
};

/* ë‚ ì§œ ë±ƒì§€ */
document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* ë°œí–‰ëœ ì¹´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° */
let crews = [];
try {
  crews = JSON.parse(localStorage.getItem(LS_CREWS) || '[]');
} catch(e) { crews = []; }
if (!crews.length) {
  crews = [{
    id:"demo1", theme:"blue", title:"<ì˜ˆì‹œ ì¹´ë“œ â€” ê´€ë¦¬ìì—ì„œ ë°œí–‰í•˜ì„¸ìš”>",
    time:"10ì›” 10ì¼ 19:00", from:"ì¶œë°œì§€", to:"ë„ì°©ì§€",
    lat:37.5665, lng:126.9780, toLat:37.55, toLng:127.0,
    peopleNow:0, peopleMax:4, styles:["Urban","Easy"], cc:"", msg:"ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë°œí–‰í•˜ë©´ ì´ ì˜ˆì‹œëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤."
  }];
}

/* ì§€ë„ */
const map = L.map('map',{scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const group = L.featureGroup().addTo(map);
const arcs  = L.layerGroup().addTo(map);

function makePin(color,label){
  return L.divIcon({className:'pin',
    html:`<div class="pin" style="background:${color}">${label}</div>`,
    iconSize:[28,28],iconAnchor:[14,14]});
}

function arcCoords(aLat,aLng,bLat,bLng,k=0.18){
  const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;
  const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;
  const nx=-vy/len,ny=vx/len; let off=len*k; if(off<0.01) off=0.01;
  const cx=mx+nx*off,cy=my+ny*off; return [[y1,x1],[cy,cx],[y2,x2]];
}

function renderMap(){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const ms=L.marker([c.lat,c.lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.toLat,c.toLng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.lat,c.lng,c.toLat,c.toLng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng()));
    a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}
renderMap();

/* ì¹´ë“œ ë Œë”ë§ */
const listEl=document.getElementById('list');
const chip=s=>`<span class="chip">${s}</span>`;
let activeFilters=new Set();

function filteredCrews(){
  if(activeFilters.size===0) return crews;
  // í˜„ì¬ëŠ” ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤ í…ìŠ¤íŠ¸ ë§¤ì¹­ë§Œ(ë°ì´í„°ì— pace ì—†ìœ¼ë©´ stylesë§Œ ì²´í¬)
  return crews.filter(c=>{
    const keys = new Set([...(c.styles||[]), ...(c.pace||[])]);
    for(const f of activeFilters){ if(keys.has(f)) return true; }
    return false;
  });
}

function renderCards(){
  listEl.innerHTML="";
  filteredCrews().forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const el=document.createElement('article');
    el.className="card"; el.dataset.id=c.id;
    el.style.background=t.cardBg; el.style.border=`1px solid ${t.border}`;

    const departAt = new Date(); // í•„ìš”ì‹œ ì‹¤ì œ ì¶œë°œ ì‹œê°„ ì‚¬ìš©
    const now = new Date();
    const diffMin = departAt ? Math.floor((departAt - now)/60000) : null;
    const imminent = (diffMin !== null && diffMin >= 0 && diffMin <= 30);

    el.innerHTML=`
      <h3>${c.title}</h3>
      <div class="meta">â° ${c.time}</div>
      <div class="meta">ğŸ“ ${c.from} â†’ ${c.to}</div>
      <div class="msg">ğŸ’¬ ${c.msg}</div>
      ${imminent ? `<div class="imminent">ğŸš¦ ì¶œë°œ ì„ë°•</div>` : ``}
      <div class="pillrow">
        ${(c.styles||[]).map(chip).join("")}
        ${c.cc ? chip(c.cc) : ""}
      </div>
      <button class="join">ğŸ‘¥ ${c.peopleNow}/${c.peopleMax} Â· âœ… í•©ë¥˜ ì‹ ì²­</button>
    `;
    el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));
    listEl.appendChild(el);
  });
}
renderCards();

/* í•„í„° ë²„íŠ¼ í† ê¸€ */
document.getElementById('filters')?.addEventListener('click', (e)=>{
  const b = e.target.closest('.pill-btn');
  if(!b) return;
  const key = b.dataset.key;
  b.classList.toggle('is-active');
  if(b.classList.contains('is-active')) activeFilters.add(key);
  else activeFilters.delete(key);
  renderCards();
});

/* í•©ë¥˜ ëª¨ë‹¬ */
const modal = document.getElementById('joinModal');
const sheet = document.getElementById('joinSheet');
const preview = document.getElementById('preview');
modal.addEventListener('click', ()=> modal.classList.remove('show'));
sheet.addEventListener('click', (e)=> e.stopPropagation());

document.getElementById('editProfile').onclick = ()=> location.href='rimo_profile.html';

function loadProfile(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }
  catch(e){ return {}; }
}
function composeText(crew, profile){
  const styles = (profile.styles || []).join(' Â· ') || '-';
  const paces  = (profile.pace   || []).join(' Â· ') || '-';
  return (
`[âœ… í•©ë¥˜ ì‹ ì²­] ${crew.title}
ğŸ“ ì¶œë°œ â†’ ë„ì°©
${crew.from} â†’ ${crew.to}

ğŸ‘¤ ë¼ì´ë” : ${profile.name || 'ì´ë¦„ ë¯¸ì…ë ¥'} ${profile.icon || ''}
ğŸï¸ ë°”ì´í¬ : ${profile.bike || 'ë¯¸ì…ë ¥'}
â° ì„ í˜¸ ì‹œê°„ëŒ€ : ${profile.time || '-'}
ğŸ‘¥ íƒ ë¤ : ${profile.tandem ? 'íƒ ë¤ ' + profile.tandem : '-'}

ğŸ¯ ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤
${styles} Â· ${paces}`
  );
}

async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); return true;
  }
}

function saveApplication(crew, text){
  let apps = [];
  try { apps = JSON.parse(localStorage.getItem(LS_APPS)||'[]'); } catch(e){ apps = []; }
  apps.unshift({
    id: 'app'+Math.random().toString(36).slice(2,7),
    ts: Date.now(),
    crewId: crew.id,
    title: crew.title,
    from: crew.from,
    to: crew.to,
    text
  });
  localStorage.setItem(LS_APPS, JSON.stringify(apps));
}

function openJoinModal(crew){
  const profile = loadProfile();
  const text = composeText(crew, profile);
  preview.textContent = text;
  copyText(text);
  modal.classList.add('show');
  document.getElementById('goAdmin').onclick = ()=>{
    saveApplication(crew, text);
    location.href = ADMIN_DM;
  };
  document.getElementById('copyProfileBtn').onclick = ()=> copyText(text);
}
</script>
</body>
</html>
