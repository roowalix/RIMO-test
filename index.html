<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 오늘의 라이딩 크루</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#1f1f2a;
    --chip:#171822; --chipOn:#23243a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}
  header{padding:12px 16px;font-weight:900;font-size:16px;border-bottom:1px solid var(--line);background:#111}
  main{padding:16px;max-width:860px;margin:0 auto;display:grid;gap:16px}
  .r-card{background:#141627;border:1px solid #2b2e48;border-radius:16px;padding:14px;box-shadow:0 2px 12px rgba(0,0,0,.28)}
  .r-card h3{margin:0 0 6px;font-size:16px;font-weight:700}
  .r-meta{display:flex;align-items:center;gap:6px;font-size:14px;color:#cfd2ff;flex-wrap:wrap;margin-bottom:4px}
  .r-meta .sep{opacity:.5}
  .r-route{display:flex;align-items:center;gap:6px;font-size:14px;margin-bottom:6px;color:#ced2f9}
  .r-msg{font-size:14px;margin:6px 0;color:#e6e8ff}
  .r-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .r-chip{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#e6e8ef}
  .is-urban{background:#1e2d55;border-color:#2c4484}
  .is-curve{background:#2a1f56;border-color:#40307a}
  .is-tour{background:#1e3b3a;border-color:#2f5f5d}
  .is-easy{background:#1f3a1f;border-color:#2f5a2f}
  .is-balanced{background:#3a341e;border-color:#5a4f2f}
  .is-dynamic{background:#3a1f1f;border-color:#5a2f2f}
  .hint{color:#cfd2ff99;font-size:14px;padding:12px}
</style>
</head>
<body>
<header>🏍️ RIMO — 오늘의 라이딩 크루</header>
<main id="cards"></main>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4BXsdN6GEkqKyto0Yxwc3G1b6gn1p8YLOrW2PMOSRpbIZcKKZpjF0GlDcJuCPB7jiTw/exec";
const SHARED_TOKEN = "";
const CACHE_KEY = "rimo_index_cards_cache_v1";
const DEBUG = true;

/* ===== JSON 파서 보강 ===== */
function htmlDecodeEntities(str){
  const map = { '&quot;':'"', '&#34;':'"', '&#39;':"'", '&amp;':'&', '&lt;':'<', '&gt;':'>' };
  return String(str).replace(/(&quot;|&#34;|&#39;|&amp;|&lt;|&gt;)/g, m => map[m] || m);
}
function safeJSONParse(maybe){ try { return JSON.parse(maybe); } catch { return null; } }
function deepParseJSON(maybe){
  let v = safeJSONParse(maybe);
  if (typeof v === 'string') {
    const v2 = safeJSONParse(v);
    if (v2 !== null) return v2;
  }
  return v;
}
function extractJSONFromText(txt){
  const pre = String(txt).match(/<pre[^>]*>([\s\S]*?)<\/pre>/i);
  let raw = pre ? pre[1] : String(txt);
  raw = htmlDecodeEntities(raw.trim());
  let s = raw.indexOf('{'), e = raw.lastIndexOf('}');
  if(s!==-1 && e>s){ const obj = deepParseJSON(raw.slice(s,e+1)); if(obj!=null) return obj; }
  s = raw.indexOf('['); e = raw.lastIndexOf(']');
  if(s!==-1 && e>s){ const arr = deepParseJSON(raw.slice(s,e+1)); if(arr!=null) return arr; }
  return deepParseJSON(raw);
}
async function tryParseResponse(r){
  try { return await r.json(); } catch(_){}
  try {
    const txt = await r.text();
    const j = extractJSONFromText(txt);
    if (j != null) return j;
    return JSON.parse(txt);
  } catch(_){}
  return null;
}
function extractRows(payload){
  if(Array.isArray(payload)) return payload;
  if(!payload || typeof payload!=='object') return [];
  if(Array.isArray(payload.rows))      return payload.rows;
  if(Array.isArray(payload.data))      return payload.data;
  if(Array.isArray(payload.items))     return payload.items;
  if(Array.isArray(payload.result))    return payload.result;
  if(Array.isArray(payload.published)) return payload.published;
  if(Array.isArray(payload.list))      return payload.list;
  if(Array.isArray(payload.cards))     return payload.cards;
  if(payload.data && Array.isArray(payload.data.rows)) return payload.data.rows;
  return [];
}
function buildCandidateURLs(){
  const base = WEB_APP_URL + (WEB_APP_URL.includes('?') ? '&' : '?');
  const tok  = SHARED_TOKEN ? `&token=${encodeURIComponent(SHARED_TOKEN)}` : '';
  const ts   = `&_=${Date.now()}`;
  return [
    `${base}op=list&scope=published${tok}${ts}`,
    `${base}op=list&scope=main${tok}${ts}`,
    `${base}op=list&scope=all${tok}${ts}`,
  ];
}
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now(), s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}

/* ===== 데이터 불러오기 ===== */
async function loadCrews(){
  let cached=[]; try{ cached=JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch(_){}
  if(cached.length) renderAll(cached);

  const urls = buildCandidateURLs();
  for(const url of urls){
    try{
      const r=await fetch(url,{cache:'no-store',redirect:'follow'});
      if(r.ok){
        const payload=await tryParseResponse(r);
        const rows=extractRows(payload);
        if(rows.length){
          localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
          return rows;
        }
      }
    }catch(e){ if(DEBUG) console.warn('fetch fail',e); }
    try{
      const j=await fetchJSONP(url);
      const rows=extractRows(j);
      if(rows.length){
        localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
        return rows;
      }
    }catch(e){ if(DEBUG) console.warn('jsonp fail',e); }
  }
  return cached;
}

/* ===== 렌더 ===== */
function cls(label){
  switch(String(label).toLowerCase()){
    case 'urban': return 'is-urban';
    case 'curve': return 'is-curve';
    case 'tour': return 'is-tour';
    case 'easy': return 'is-easy';
    case 'balanced': return 'is-balanced';
    case 'dynamic': return 'is-dynamic';
    default: return '';
  }
}
function chip(label){ return `<span class="r-chip ${cls(label)}">${label}</span>`; }
function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function renderAll(list){
  const box=document.getElementById('cards'); box.innerHTML='';
  if(!list||!list.length){ box.innerHTML='<div class="hint">아직 카드가 없습니다.</div>'; return; }
  list.forEach(it=>{
    const dt=new Date(it.datetime||Date.now());
    const when=it.datetime_display || dt.toLocaleString();
    const styles=(it.styles||[]), pace=(it.pace||[]);
    const ccLabel = (it.cc===''||it.cc==null)?'관계없음':String(it.cc);
    const capacity=Number(it.capacity)||0;
    const remaining=Number(it.remaining)||0;
    const attended=Math.max(0, capacity-remaining);

    const el=document.createElement('article');
    el.className='r-card';
    el.innerHTML=`
      <h3>${escapeHtml(it.title||'(제목없음)')}</h3>
      <div class="r-meta">⏰ ${when}</div>
      <div class="r-route">📌 ${escapeHtml(it.from||'-')} - ${escapeHtml(it.to||'-')}</div>
      <div class="r-meta">🏍 ${escapeHtml(ccLabel)} <span class="sep">·</span> 👥 참석 ${attended}/${capacity} <span class="sep">·</span> 잔여 ${remaining}</div>
      <div class="r-msg">💬 ${escapeHtml(it.message||'-')}</div>
      <div class="r-chips">
        ${styles.map(chip).join('')}
        ${pace.map(chip).join('')}
      </div>
    `;
    box.appendChild(el);
  });
}

/* ===== 초기 실행 ===== */
(async function(){
  const rows=await loadCrews();
  renderAll(rows);
})();
</script>
</body>
</html>
