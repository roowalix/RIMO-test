<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 오늘의 라이딩 크루</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<style>
  :root{
    --border-1:#2b304f;
    --muted:#b9b9cc;

    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);

    --t-red-br:rgba(255,93,93,.45);
    --t-blue-br:rgba(122,167,255,.45);
    --t-yellow-br:rgba(255,216,93,.48);
    --t-green-br:rgba(86,211,100,.50);
    --t-purple-br:rgba(167,139,250,.52);
  }
  *{box-sizing:border-box}
  body{ margin:0; background:#0b0b0f; color:#e8e8ef; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif; }

  /* 헤더 */
  header{position:sticky; top:0; z-index:5; background:rgba(11,11,15,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--border-1)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* 본문 */
  main{padding:16px;max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1)}
  .leaflet-container{z-index:1}

  /* ====== 공통 카드 스타일(어드민과 동일 톤) ====== */
  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{
    scroll-snap-align:start;width:304px;flex:0 0 auto;
    border:1px solid var(--border-1); border-radius:14px; padding:14px;
    display:flex; flex-direction:column; gap:8px; background:#141628; position:relative;
  }
  .card h3{margin:0 0 4px 0;font-size:18px}
  .meta{font-size:14px;color:#bfc2dc}
  .msg{font-size:14px}

  .pillrow{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 9px;border-radius:999px;font-size:12px;font-weight:600;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e6e8ef}
  .chip.pill-urban{background:#1e2d55;border-color:#2c4484}
  .chip.pill-curve{background:#2a1f56;border-color:#40307a}
  .chip.pill-tour{background:#1e3b3a;border-color:#2f5f5d}
  .chip.pill-easy{background:#1f3a1f;border-color:#2f5a2f}
  .chip.pill-balanced{background:#3a341e;border-color:#5a4f2f}
  .chip.pill-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .route{display:flex;align-items:center;gap:8px;color:#e6e8ef}
  .pin{width:8px;height:8px;border-radius:999px;background:currentColor}
  .dash{flex:1;border-top:1px dashed currentColor;opacity:.6}

  /* 테마별 보더(카드 안 라벨은 숨김 유지) */
  .card[data-theme="red"]{border-color:var(--t-red-br)}
  .card[data-theme="blue"]{border-color:var(--t-blue-br)}
  .card[data-theme="yellow"]{border-color:var(--t-yellow-br)}
  .card[data-theme="green"]{border-color:var(--t-green-br)}
  .card[data-theme="purple"]{border-color:var(--t-purple-br)}

  /* 출발 임박 배지 + 글로우 */
  .imminent{
    position:absolute;top:10px;right:10px;
    display:inline-flex;gap:6px;align-items:center;
    padding:8px 10px;border-radius:10px;font-size:12px;font-weight:800;
    background:var(--imminent-bg);border:1px solid var(--imminent-bd);color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 10px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* 하단 탭 */
  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:#182039;border:1px solid #2d3559;color:#e6e8ef;padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:#26346d;border-color:#3b53a8}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">오늘의 라이딩 크루</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map"></div>
  <section id="list" class="carousel"></section>
</main>

<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab primary">메인</a>
  <a href="rimo_profile.html" class="tab">프로필</a>
  <a href="rimo_ambassadors.html" class="tab">엠버서더</a>
</nav>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ===== 상수 ===== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw7jNF2Qk0IqOSQhsGPJW5I7ifiSNl74FyNRTdHvi9jXikDDZAM19RG6zwNMakwPukn9w/exec";
const CACHE_KEY   = "rimo_published_cards_server_cache";
const GRACE_MS    = 5*60*1000; // 출발 +5분까지 노출

document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* ===== 유틸 ===== */
function pad(n){return String(n).padStart(2,'0')}
function formatKDate(dt){return `${dt.getMonth()+1}월 ${dt.getDate()}일 ${pad(dt.getHours())}:${pad(dt.getMinutes())}`}
function toList(v){
  if (v==null) return [];
  if (Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean);
  const s=String(v).trim();
  if (!s) return [];
  if (/^\[Ljava\.lang\.Object;/.test(s)) return [];
  try{ const j=JSON.parse(s); if(Array.isArray(j)) return j.map(x=>String(x).trim()).filter(Boolean); }catch(_){}
  return s.split(/[,\|/·]/).map(x=>x.trim()).filter(Boolean);
}
function normalizeRow(it){
  return {
    id: it.id || `id_${Math.random().toString(36).slice(2,8)}`,
    title: it.title||'(제목 없음)',
    datetime: it.datetime || it.date || '',
    datetime_display: it.datetime_display || (it.datetime?formatKDate(new Date(it.datetime)):''),
    from: it.from||'-', to: it.to||'-',
    from_lat:+it.from_lat||null, from_lng:+it.from_lng||null, to_lat:+it.to_lat||null, to_lng:+it.to_lng||null,
    cc: it.cc||'',
    styles: toList(it.styles),
    pace: toList(it.pace),
    message: it.message||'',
    remaining: Number.isFinite(+it.remaining)? +it.remaining : 0,
    capacity:  Number.isFinite(+it.capacity)?  +it.capacity  : 0,
    theme: it.theme||'blue'
  };
}

/* ===== 데이터 로드 (fetch → JSONP → 캐시) ===== */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now();
    const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadCrews(){
  let cached=[]; try{ cached=JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch(_){}
  if(cached.length) renderAll(cached.map(normalizeRow));

  try{
    const r=await fetch(WEB_APP_URL+'?op=list&_='+Date.now(),{cache:'no-store'});
    if(r.ok){
      const j=await r.json(); const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
      localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
      return rows.map(normalizeRow);
    }
  }catch(_){}

  try{
    const j=await fetchJSONP(WEB_APP_URL+'?op=list');
    const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
    if(rows.length){ localStorage.setItem(CACHE_KEY, JSON.stringify(rows)); return rows.map(normalizeRow); }
  }catch(_){}

  return cached.map(normalizeRow);
}

/* ===== 지도 ===== */
let map, group, arcs;
function initMap(){
  map=L.map('map',{scrollWheelZoom:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  group=L.featureGroup().addTo(map);
  arcs=L.layerGroup().addTo(map);
}
function makePin(color,label){
  return L.divIcon({className:'pin',html:`<div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35);background:${color}">${label}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
}
function arcCoords(aLat,aLng,bLat,bLng,k=.18){const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2,vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1,nx=-vy/len,ny=vx/len,off=Math.max(len*k,0.01);const cx=mx+nx*off,cy=my+ny*off;return [[y1,x1],[cy,cx],[y2,x2]];}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    if(!(c.from_lat&&c.from_lng&&c.to_lat&&c.to_lng)) return;
    const color = '#7aa7ff';
    const ms=L.marker([c.from_lat,c.from_lng],{icon:makePin(color,'S')}).addTo(group);
    const md=L.marker([c.to_lat,c.to_lng],{icon:makePin(color,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.from_lat,c.from_lng,c.to_lat,c.to_lng),{color:color,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng())); a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}

/* ===== 카드 ===== */
function chipClass(v){ switch(String(v).toLowerCase()){ case 'urban':return 'pill-urban'; case 'curve':return 'pill-curve'; case 'tour':return 'pill-tour'; case 'easy':return 'pill-easy'; case 'balanced':return 'pill-balanced'; case 'dynamic':return 'pill-dynamic'; default:return ''; } }
function chip(v){ return `<span class="chip ${chipClass(v)}">${v}</span>`; }
function renderCards(crews){
  const list=document.getElementById('list'); list.innerHTML='';
  crews.forEach(c=>{
    const joined=Math.max(0,(c.capacity||0)-(c.remaining||0));
    const el=document.createElement('article');
    el.className='card'; el.dataset.theme=c.theme;
    const t = c.datetime ? new Date(c.datetime).getTime() : null;
    const immin = t && (t - Date.now() < 30*60*1000) && (t + GRACE_MS >= Date.now()); // 출발 30분 전~출발+5분
    el.innerHTML=`
      <h3>${c.title}</h3>
      <div class="meta">⏰ ${c.datetime_display || (c.datetime?formatKDate(new Date(c.datetime)):'')}</div>
      <div class="route"><span class="pin"></span><span>${c.from}</span><span class="dash"></span><span class="pin"></span><span>${c.to}</span></div>
      ${c.message?`<div class="msg">💬 ${c.message}</div>`:''}
      <div class="pillrow">
        ${c.styles.map(chip).join('')}
        ${c.pace.map(chip).join('')}
        ${c.cc?chip(c.cc):''}
      </div>
      <div class="meta">👥 ${joined}/${c.capacity||0}</div>
      ${immin?`<div class="imminent">🚦 출발 임박</div>`:''}
    `;
    list.appendChild(el);
  });
}

/* ===== 전체 렌더: 시간 필터(+5분 유예) ===== */
function renderAll(rows){
  const now=Date.now();
  const live=rows.filter(r=>{
    if(!r.datetime) return true;
    const t=new Date(r.datetime).getTime();
    return t + GRACE_MS >= now;
  });
  renderCards(live);
  renderMap(live);
}

/* ===== init ===== */
(async function init(){
  initMap();
  const rows = await loadCrews();
  renderAll(rows);
})();
</script>
</body>
</html>
