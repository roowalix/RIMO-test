<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 오늘의 라이딩 크루</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<style>
  :root{
    --btn:#2A2F4F; --btnHover:#3C4380;
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);
    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;
    --border-1:#2b304f; --muted:#b9b9cc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b0b0f;color:#e8e8ef;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border-1)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}.title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  main{padding:16px;max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1);background:#0e1222}
  .leaflet-container{z-index:1}

  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{scroll-snap-align:start;width:304px;flex:0 0 auto;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px;border:1px solid transparent;position:relative}
  .card h3{margin:0 0 2px;font-size:18px}
  .meta{font-size:14px;color:var(--muted)}
  .msg{font-size:14px}
  .pillrow{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
  .chip{padding:6px 9px;border-radius:999px;font-size:12px;font-weight:500;display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e6e8ef}
  .chip.pill-urban{background:#1e2d55;border-color:#2c4484}
  .chip.pill-curve{background:#2a1f56;border-color:#40307a}
  .chip.pill-tour{background:#1e3b3a;border-color:#2f5f5d}
  .chip.pill-easy{background:#1f3a1f;border-color:#2f5a2f}
  .chip.pill-balanced{background:#3a341e;border-color:#5a4f2f}
  .chip.pill-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .imminent{position:absolute;top:10px;right:10px;display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;font-size:12px;font-weight:700;background:var(--imminent-bg);border:1px solid var(--imminent-bd);color:#ffe7a6;animation:pulse 2.2s ease-in-out infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}}
  .join{margin-top:2px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;background:rgba(255,255,255,.16);cursor:pointer}

  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}
  body.modal-open .tabbar{pointer-events:none;opacity:.28;filter:saturate(.2) blur(1px);transform:translateY(2px)}
  .empty{opacity:.7;border:1px dashed var(--border-1);border-radius:12px;padding:14px 12px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">오늘의 라이딩 크루</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map"></div>
  <section id="list" class="carousel"></section>
  <div id="empty" class="empty" style="display:none">표시할 라이딩이 없습니다.</div>
</main>

<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab primary">메인</a>
  <a href="rimo_profile.html" class="tab">프로필</a>
  <a href="rimo_ambassadors.html" class="tab">엠버서더</a>
</nav>

<!-- 모달 -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle" style="display:none">
  <div class="sheet panel" id="joinSheet" style="width:calc(100% - 24px);max-width:680px;background:#0e1222;border:1px solid #2b304f;border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.55);padding:16px 16px 20px">
    <h4 id="joinTitle" style="margin:4px 0 10px;font-size:18px">✅ 합류 신청하기</h4>
    <div class="hint" style="color:#cfd2ff;line-height:1.5;margin-bottom:10px">아래 버튼으로 <b>운영자 1:1 채팅</b>을 열어 붙여 넣어 주세요. 승인되면 라이더 크루 채팅방으로 초대됩니다.</div>
    <div id="preview" class="pre" style="background:#0b1020;border:1px solid #293059;border-radius:12px;padding:12px;white-space:pre-wrap;line-height:1.4;min-height:96px;max-height:42vh;overflow:auto;color:#e6e9ff"></div>
    <div class="modal-actions" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;padding-bottom:6px">
      <button id="goAdmin" style="flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;background:#2A2F4F;color:#fff;font-size:15px;font-weight:700;cursor:pointer">이대로 신청하기</button>
      <button id="editProfile" style="flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;background:#2A2F4F;color:#fff;font-size:15px;font-weight:700;cursor:pointer">프로필 수정</button>
      <button id="copyProfileBtn" style="flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;background:#2A2F4F;color:#fff;font-size:15px;font-weight:700;cursor:pointer">다시 복사</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ===== 상수/테마 ===== */
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";
const LS_PROFILE='rimo_profile_v1', LS_APPS='rimo_applications_v1', LS_CACHE='rimo_crews_cache_v1';
const API="https://script.google.com/macros/s/AKfycbxWLEa5-oxPQYuxQTYXInrePIBU3jbJZZf2lNFkasERyv3pftmC1niT78GZ5tVJ7i_cMQ/exec";

const THEMES={ red:{base:'#ff4d4d',cardBg:'rgba(255,77,77,.14)',border:'rgba(255,77,77,.55)'},
              yellow:{base:'#ffd24d',cardBg:'rgba(255,210,77,.16)',border:'rgba(255,210,77,.55)'},
              blue:{base:'#5b8cff',cardBg:'rgba(91,140,255,.16)',border:'rgba(91,140,255,.55)'},
              green:{base:'#46d37d',cardBg:'rgba(70,211,125,.16)',border:'rgba(70,211,125,.55)'},
              purple:{base:'#a78bfa',cardBg:'rgba(167,139,250,.16)',border:'rgba(167,139,250,.55)'} };

document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* ===== 지도 ===== */
const map=L.map('map',{scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const group=L.featureGroup().addTo(map), arcs=L.layerGroup().addTo(map);
function makePin(c,l){return L.divIcon({className:'pin',html:`<div class="pin" style="background:${c};width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35)">${l}</div>`,iconSize:[28,28],iconAnchor:[14,14]});}
function arcCoords(aLat,aLng,bLat,bLng,k=0.18){const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;const nx=-vy/len,ny=vx/len;let off=len*k;if(off<0.01) off=0.01;const cx=mx+nx*off,cy=my+ny*off;return [[y1,x1],[cy,cx],[y2,x2]];}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const ms=L.marker([c.lat,c.lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.toLat,c.toLng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.lat,c.lng,c.toLat,c.toLng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng())); a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}

/* ===== 도우미 ===== */
const listEl=document.getElementById('list'), emptyEl=document.getElementById('empty');
function chipClass(l){switch(String(l).toLowerCase()){case'urban':return'pill-urban';case'curve':return'pill-curve';case'tour':return'pill-tour';case'easy':return'pill-easy';case'balanced':return'pill-balanced';case'dynamic':return'pill-dynamic';default:return'';}}
function chip(l){return `<span class="chip ${chipClass(l)}">${l}</span>`;}
function pad(n){return String(n).padStart(2,'0')}
function kfmt(d){return `${d.getMonth()+1}월 ${d.getDate()}일 ${pad(d.getHours())}:${pad(d.getMinutes())}`}
function toNum(n,fb=null){const v=Number(n);return Number.isFinite(v)?v:(fb===null?null:fb);}

/* ===== 서버에서 읽기: 강력 폴백 ===== */
async function fetchJSON(url){const r=await fetch(url,{cache:'no-store'});const ct=r.headers.get('content-type')||'';const t=await r.text();try{ if(ct.includes('application/json')) return JSON.parse(t); return JSON.parse(t);}catch{ return t; }}
function jsonPickArray(j){
  // JSONP면 콜백 벗겨내기
  if(typeof j==='string'){
    const m=j.match(/^[^(]+\((.*)\)\s*;?\s*$/s);
    if(m){ try{ j=JSON.parse(m[1]); }catch{} }
    else { try{ j=JSON.parse(j); }catch{} }
  }
  if(Array.isArray(j)) return j;
  if(j && typeof j==='object'){
    return j.items||j.data||j.rows||j.crews||j.list||[];
  }
  return [];
}
function normalize(it){
  const theme=it.theme||'blue';
  const title=it.title||'(제목 없음)';
  const from =it.from ||it.start||'출발지';
  const to   =it.to   ||it.end  ||'도착지';
  const dtISO=it.datetime||it.date||null;
  const dt   =dtISO?new Date(dtISO):null;
  const time =it.datetime_display||it.time||(dt?kfmt(dt):'');
  const lat  =toNum(it.from_lat,toNum(it.lat,37.5665));
  const lng  =toNum(it.from_lng,toNum(it.lng,126.9780));
  const toLat=toNum(it.to_lat,toNum(it.toLat,37.55));
  const toLng=toNum(it.to_lng,toNum(it.toLng,127.0));
  const cap  =toNum(it.capacity,toNum(it.peopleMax,0))||0;
  const rem  =toNum(it.remaining,null);
  const joined=(rem==null)?toNum(it.peopleNow,0):Math.max(0,cap-Math.max(0,rem));
  const peopleNow=Math.min(Math.max(0,joined||0),cap||0);
  const peopleMax=cap||Math.max(peopleNow,0);
  const styles=Array.isArray(it.styles)?it.styles:String(it.styles||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean);
  const pace  =Array.isArray(it.pace)?it.pace:String(it.pace||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean);
  return {id:it.id||('crew_'+Math.random().toString(36).slice(2,7)),theme,title,from,to,lat,lng,toLat,toLng,datetime:dtISO,time,msg:it.message||it.msg||'',cc:it.cc||'',styles,pace,peopleNow,peopleMax};
}
function isVisible(c){ if(!c.datetime) return true; const start=+new Date(c.datetime); return Date.now()<=start+5*60*1000; }
function isImminent(c){ if(!c.datetime) return false; const start=+new Date(c.datetime); const diff=start-Date.now(); return diff<=20*60*1000 && diff>=0; }

/* ===== 렌더 ===== */
function drawCard(c){
  const t=THEMES[c.theme]||THEMES.blue;
  const el=document.createElement('article');
  el.className='card'; el.dataset.id=c.id;
  el.style.background=t.cardBg; el.style.border=`1px solid ${t.border}`;
  el.innerHTML=`
    <h3>${c.title}</h3>
    <div class="meta">⏰ ${c.time||''}</div>
    <div class="meta">📍 ${c.from} → ${c.to}</div>
    <div class="msg">💬 ${c.msg||'-'}</div>
    ${isImminent(c)?`<div class="imminent">🚦 출발 임박</div>`:''}
    <div class="pillrow">
      ${(c.styles||[]).map(chip).join('')}
      ${(c.pace||[]).map(chip).join('')}
      ${c.cc?chip(c.cc):''}
    </div>
    <button class="join">👥 ${c.peopleNow||0}/${c.peopleMax||0} · ✅ 합류 신청</button>
  `;
  el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));
  listEl.appendChild(el);
}
function renderCards(arr){
  listEl.innerHTML='';
  emptyEl.style.display = arr.length? 'none':'block';
  if(!arr.length){
    renderMap([ {lat:37.5665,lng:126.9780,toLat:37.55,toLng:127.0,theme:'blue'} ]);
    return;
  }
  renderMap(arr);
  arr.forEach(drawCard);
}

/* ===== 모달 ===== */
const modal=document.getElementById('joinModal'), sheet=document.getElementById('joinSheet'), preview=document.getElementById('preview');
modal.addEventListener('click',()=>{modal.style.display='none';document.body.classList.remove('modal-open');});
sheet.addEventListener('click',e=>e.stopPropagation());
document.getElementById('editProfile').onclick=()=>location.href='rimo_profile.html';
function loadProfile(){try{return JSON.parse(localStorage.getItem(LS_PROFILE)||'{}')}catch{return{}}}
function composeText(crew, p){
  const s=(p.styles||[]).join(' · ')||'-', pc=(p.pace||[]).join(' · ')||'-';
  return `[✅ 합류 신청] ${crew.title}
📍 출발 → 도착
${crew.from} → ${crew.to}

👤 라이더 : ${p.name||'이름 미입력'} ${p.icon||''}
🏍️ 바이크 : ${p.bike||'미입력'}
⏰ 선호 시간대 : ${p.time||'-'}
👥 탠덤 : ${p.tandem?('탠덤 '+p.tandem):'-'}

🎯 스타일/페이스
${s} · ${pc}`;
}
async function copyText(t){try{await navigator.clipboard.writeText(t)}catch{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();}}
function saveApplication(crew,text){
  let apps=[];try{apps=JSON.parse(localStorage.getItem(LS_APPS)||'[]')}catch{apps=[]}
  apps.unshift({id:'app'+Math.random().toString(36).slice(2,7),ts:Date.now(),crewId:crew.id,title:crew.title,from:crew.from,to:crew.to,text});
  localStorage.setItem(LS_APPS,JSON.stringify(apps));
}
function openJoinModal(crew){
  const text=composeText(crew, loadProfile());
  preview.textContent=text; copyText(text);
  document.body.classList.add('modal-open'); modal.style.display='flex';
  document.getElementById('goAdmin').onclick=()=>{saveApplication(crew,text);location.href=ADMIN_DM;};
  document.getElementById('copyProfileBtn').onclick=()=>copyText(text);
}

/* ===== 메인 로직 ===== */
async function loadCrews(){
  const ts=Date.now();
  // 1) action=list
  try{
    const j=await fetchJSON(`${API}?action=list&_=${ts}`);
    let arr=jsonPickArray(j); if(arr.length){localStorage.setItem(LS_CACHE,JSON.stringify(arr));return arr;}
  }catch{}
  // 2) op=list
  try{
    const j2=await fetchJSON(`${API}?op=list&_=${ts}`);
    let arr2=jsonPickArray(j2); if(arr2.length){localStorage.setItem(LS_CACHE,JSON.stringify(arr2));return arr2;}
  }catch{}
  // 3) JSONP
  try{
    const cb='__rimo_cb_'+ts;
    const url=`${API}?op=list&callback=${cb}&_=${ts}`;
    const txt=await fetchJSON(url); // 위 fetchJSON이 문자열 그대로 반환 가능
    let arr3=jsonPickArray(txt); if(arr3.length){localStorage.setItem(LS_CACHE,JSON.stringify(arr3));return arr3;}
  }catch{}
  // 4) 캐시
  try{ return JSON.parse(localStorage.getItem(LS_CACHE)||'[]'); }catch{ return []; }
}
async function refresh(){
  let raw=await loadCrews();
  // 서버가 rows 안에 객체를 넣어 줄 수도 있음 → 평탄화
  if(Array.isArray(raw) && raw.length && Array.isArray(raw[0]) && raw[0].length) raw=raw[0];
  let arr = raw.map(normalize).filter(isVisible).sort((a,b)=>{
    const ta=a.datetime?+new Date(a.datetime):0, tb=b.datetime?+new Date(b.datetime):0; return ta-tb;
  });
  renderCards(arr);
}
(async function init(){
  document.getElementById('today').textContent =
    new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});
  await refresh();
  setInterval(refresh, 60*1000); // 1분마다 재로딩(만료/갱신 반영)
})();
</script>
</body>
</html>
