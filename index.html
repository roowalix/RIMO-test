<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO — 오늘의 라이딩 크루</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#232333;
    --chip:#1a1a24; --chipBd:#2f3247;
    --btn:#2A2F4F; --btnHover:#3C4380;
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);

    /* tabbar (공통) */
    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
       font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Helvetica,Arial,sans-serif}

  /* 헤더 (공통: 높이 56px) */
  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);
         backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* 본문 */
  main{padding:16px; padding-bottom:100px;}
  #map{height:360px;border-radius:14px;outline:1px solid #232333;margin-bottom:20px}
  .leaflet-container{z-index:1}

  /* 카드 캐러셀 */
  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{scroll-snap-align:start;width:304px;flex:0 0 auto;border-radius:14px;padding:14px;
        display:flex;flex-direction:column;gap:8px;border:1px solid transparent;position:relative}
  .card h3{margin:0 0 2px;font-size:18px}
  .meta{font-size:14px;color:var(--muted)}
  .msg{font-size:14px}
  .pillrow{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
  .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.12);font-size:12px;white-space:nowrap;display:inline-flex;align-items:center;justify-content:center}

  /* 출발 임박 배지 (우상단) */
  .imminent{
    position:absolute; top:10px; right:10px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:700;
    background:var(--imminent-bg); border:1px solid var(--imminent-bd); color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* 합류 버튼 */
  .join{margin-top:2px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;
        background:rgba(255,255,255,.16);cursor:pointer}
  .card.selected{box-shadow:0 0 0 2px rgba(255,255,255,.12) inset}

  /* 핀 아이콘 */
  .pin{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
       font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35)}

  /* 합류 안내 모달 — 바깥 클릭 닫힘 */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000;
         background:rgba(0,0,0,.45);padding:22px 12px}
  .modal.show{display:flex}
  .sheet{width:100%;max-width:680px;background:#0e1222;border:1px solid #2b304f;border-radius:18px;
         box-shadow:0 14px 40px rgba(0,0,0,.55);padding:16px}
  .sheet h4{margin:4px 0 10px;font-size:18px}
  .hint{color:#cfd2ff;line-height:1.5;margin-bottom:10px}
  .pre{background:#0b1020;border:1px solid #293059;border-radius:12px;padding:12px;white-space:pre-wrap;line-height:1.4}
  .modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
  .modal-actions button{flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;
                        background:var(--btn);color:#fff;font-size:15px;font-weight:700;cursor:pointer}
  .modal-actions button:hover{background:var(--btnHover)}
  #copyProfileBtn{padding:8px 12px;font-size:12px;min-width:100px;max-width:140px}

  /* 🚨 프로필 필요 모달 (경고) */
  .alert-sheet{max-width:520px}
  .alert-title{margin:2px 0 8px;font-size:18px}
  .alert-text{color:#d7dbff;margin:0 0 12px;line-height:1.5}
  
    /* 하단 네비 (메인/프로필과 동일) */
  .tabbar{
    position:fixed; left:0; right:0; bottom:16px; z-index:2500;
    display:flex; gap:12px; justify-content:center;
  }
  .tabbar .tab{
    background:var(--tab-bg); border:1px solid var(--tab-bd); color:var(--tab-ink);
    padding:12px 18px; border-radius:22px; font-weight:800; text-decoration:none; font-size:14px;
  }
  .tabbar .tab.primary{background:var(--tab-pri); border-color:var(--tab-pri-bd)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">🏍️ RIMO</div>
    <div class="title">오늘의 라이딩 크루</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map"></div>
  <section id="list" class="carousel"></section>
</main>

<!-- 하단 네비 (메인 활성) -->
<nav class="tabbar" aria-label="하단 네비게이션">
  <a href="index.html" class="tab primary">메인</a>
  <a href="rimo_profile.html" class="tab">프로필</a>
  <a href="rimo_ambassadors.html" class="tab">엠버서더</a>
</nav>

<!-- 합류 안내 모달 -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
  <div class="sheet" id="joinSheet">
    <h4 id="joinTitle">✅ 합류 신청하기</h4>
    <div class="hint">
      아래 버튼으로 <b>운영자 1:1 채팅</b>을 열어 붙여 넣어 주세요. 승인되면 라이더 크루 채팅방으로 초대됩니다.
    </div>
    <div id="preview" class="pre"></div>
    <div class="modal-actions">
      <button id="goAdmin">이대로 신청하기</button>
      <button id="editProfile">프로필 수정</button>
      <button id="copyProfileBtn">다시 복사</button>
    </div>
  </div>
</div>

<!-- 🚨 프로필 필요 모달 -->
<div class="modal" id="needProfileModal" role="dialog" aria-modal="true" aria-labelledby="needProfileTitle">
  <div class="sheet alert-sheet" id="needProfileSheet">
    <h4 id="needProfileTitle" class="alert-title">프로필이 필요합니다</h4>
    <p class="alert-text">합류 신청 전에 <b>프로필</b>을 먼저 작성해 주세요.</p>
    <div class="modal-actions">
      <button id="goMakeProfile">프로필 작성</button>
      <button id="closeNeedProfile">닫기</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* 공통: 운영자 DM, 테마, 저장 키 */
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";
const LS_KEY = 'rimo_profile_v1';
const THEMES = {
  red:{ base:'#ff4d4d', cardBg:'rgba(255,77,77,.14)', border:'rgba(255,77,77,.55)'},
  yellow:{ base:'#ffd24d', cardBg:'rgba(255,210,77,.16)', border:'rgba(255,210,77,.55)'},
  blue:{ base:'#5b8cff', cardBg:'rgba(91,140,255,.16)', border:'rgba(91,140,255,.55)'}
};

/* 날짜 뱃지 */
document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* 데이터 (time: "M월 D일 HH:MM") */
let crews = [
  { id:"crew1", theme:"red", title:"<가을맞이 카페 라이딩>", time:"9월 9일 00:40",
    from:"GS25 한강르네상스 반포2호", to:"RSG 성수",
    lat:37.5086371, lng:126.9941734, toLat:37.541193, toLng:127.056428,
    peopleNow:0, peopleMax:4, styles:["Urban","Easy"], cc:"400cc 이상",
    msg:"잠수교 밤바리 후 알슥은 국룰이쥬~" },
  { id:"crew2", theme:"yellow", title:"<은평구민 와인딩 한마당>", time:"9월 20일 19:00",
    from:"서울혁신파크", to:"북악팔각정",
    lat:37.6079794, lng:126.9331676, toLat:37.603512, toLng:126.981851,
    peopleNow:0, peopleMax:3, styles:["Curve","Balanced"], cc:"125–250cc",
    msg:"저배기로 즐기는 쫀득한 와인딩 ★안전운전★" },
  { id:"crew3", theme:"blue", title:"<물안개 피는 양만장>", time:"9월 22일 05:00",
    from:"문화비축기지", to:"양평 만남의 광장",
    lat:37.5705673, lng:126.8942802, toLat:37.489, toLng:127.491,
    peopleNow:0, peopleMax:5, styles:["Tour","Dynamic"], cc:"750cc 이상",
    msg:"찌뿌둥한 몸은 해장국 → 시원한 아아!" }
];

/* 지도 */
const map = L.map('map',{scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const group = L.featureGroup().addTo(map);
const arcs = L.layerGroup().addTo(map);

function makePin(color,label){return L.divIcon({className:'pin',
  html:`<div class="pin" style="background:${color}">${label}</div>`,
  iconSize:[28,28],iconAnchor:[14,14]});}

function arcCoords(aLat,aLng,bLat,bLng,k=0.18){
  const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;
  const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;
  const nx=-vy/len,ny=vx/len; let off=len*k; if(off<0.01) off=0.01;
  const cx=mx+nx*off,cy=my+ny*off; return [[y1,x1],[cy,cx],[y2,x2]];
}

function renderMap(){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const ms=L.marker([c.lat,c.lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.toLat,c.toLng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.lat,c.lng,c.toLat,c.toLng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng()));
    a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}
renderMap();

/* 시간 파싱 → Date */
function parseKoreanDate(str){
  const m = str.match(/(\d+)\s*월\s*(\d+)\s*일\s*(\d{1,2}):(\d{2})/);
  if(!m) return null;
  const year = new Date().getFullYear();
  return new Date(year, parseInt(m[1],10)-1, parseInt(m[2],10), parseInt(m[3],10), parseInt(m[4],10));
}

/* 카드 */
const listEl=document.getElementById('list');
const chip=s=>`<span class="chip">${s}</span>`;

function renderCards(){
  listEl.innerHTML="";
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const el=document.createElement('article');
    el.className="card"; el.dataset.id=c.id;
    el.style.background=t.cardBg; el.style.border=`1px solid ${t.border}`;

    const departAt = parseKoreanDate(c.time);
    const now = new Date();
    const diffMin = departAt ? Math.floor((departAt - now)/60000) : null;
    const imminent = (diffMin !== null && diffMin >= 0 && diffMin <= 30);

    el.innerHTML=`
      <h3>${c.title}</h3>
      <div class="meta">⏰ ${c.time}</div>
      <div class="meta">📍 ${c.from} → ${c.to}</div>
      <div class="msg">💬 ${c.msg}</div>
      ${imminent ? `<div class="imminent">🚦 출발 임박</div>` : ``}
      <div class="pillrow">
        ${c.styles.map(chip).join("")}
        ${c.cc ? chip(c.cc) : ""}
      </div>
      <button class="join">👥 ${c.peopleNow}/${c.peopleMax} · ✅ 합류 신청</button>
    `;
    el.querySelector('.join').addEventListener('click',()=>onJoinClick(c));
    el.addEventListener('click',(e)=>{ if(!e.target.classList.contains('join')) focusCrew(c.id); });
    listEl.appendChild(el);
  });
}
renderCards();

function focusCrew(id){
  const c=crews.find(x=>x.id===id); if(!c) return;
  document.querySelectorAll('.card').forEach(el=>el.classList.remove('selected'));
  const card=[...document.querySelectorAll('.card')].find(el=>el.dataset.id===id);
  if(card){card.classList.add('selected');card.scrollIntoView({behavior:'smooth',inline:'start'});}
  map.setView([c.lat,c.lng],13,{animate:true});
}

/* 합류 모달 & 프로필 텍스트 */
const modal = document.getElementById('joinModal');
const sheet = document.getElementById('joinSheet');
const preview = document.getElementById('preview');
modal.addEventListener('click', ()=> modal.classList.remove('show'));
sheet.addEventListener('click', (e)=> e.stopPropagation());

document.getElementById('editProfile').onclick = ()=> location.href='rimo_profile.html';

function loadProfile(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }
  catch(e){ return {}; }
}
function hasProfile(p){
  // 최소 필드: 이름, 지역, 시간대
  return p && p.name && p.region && p.time;
}
function composeText(crew, profile){
  const styles = (profile.styles || []).join(' · ') || '-';
  const paces  = (profile.pace   || []).join(' · ') || '-';
  return (
`[✅ 합류 신청] ${crew.title}
📍 출발 → 도착
${crew.from} → ${crew.to}

👤 라이더 : ${profile.name || '이름 미입력'} ${profile.icon || ''}
🏍️ 바이크 : ${profile.bike || '미입력'}
⏰ 선호 시간대 : ${profile.time || '-'}
👥 탠덤 : ${profile.tandem ? '탠덤 ' + profile.tandem : '-'}

🎯 스타일/페이스
${styles} · ${paces}`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){
    const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); return true;
  }
}
function openJoinModal(crew){
  const profile = loadProfile();
  const text = composeText(crew, profile);
  preview.textContent = text;
  copyText(text);
  modal.classList.add('show');
  document.getElementById('goAdmin').onclick = ()=>{ location.href = ADMIN_DM; };
  document.getElementById('copyProfileBtn').onclick = ()=> copyText(text);
}

/* 🚨 프로필 필요 모달 로직 */
const needProfileModal = document.getElementById('needProfileModal');
const needProfileSheet = document.getElementById('needProfileSheet');
needProfileModal.addEventListener('click', ()=> needProfileModal.classList.remove('show'));
needProfileSheet.addEventListener('click', (e)=> e.stopPropagation());
document.getElementById('goMakeProfile').onclick = ()=> location.href='rimo_profile.html';
document.getElementById('closeNeedProfile').onclick = ()=> needProfileModal.classList.remove('show');

function showNeedProfile(){
  needProfileModal.classList.add('show');
}

/* 진입 시 프로필 확인 → 없으면 경고 모달 */
(function checkProfileOnLoad(){
  const p = loadProfile();
  if(!hasProfile(p)){
    showNeedProfile();
  }
})();

/* 합류 버튼 클릭 시에도 체크 */
function onJoinClick(crew){
  const p = loadProfile();
  if(!hasProfile(p)){
    showNeedProfile();
    return;
  }
  openJoinModal(crew);
}
</script>
</body>
</html>
