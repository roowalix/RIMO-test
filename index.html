<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />

<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --line:#232333;
    --imminent-bg: rgba(255,199,94,.16); --imminent-bd: rgba(255,199,94,.45);

    /* Theme border colors */
    --t-red-br:rgba(255,93,93,.45);
    --t-blue-br:rgba(122,167,255,.45);
    --t-yellow-br:rgba(255,216,93,.48);
    --t-green-br:rgba(86,211,100,.50);
    --t-purple-br:rgba(167,139,250,.52);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}

  /* í—¤ë” */
  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* ë³¸ë¬¸ */
  main{padding:16px;max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;border:1px solid var(--line);min-height:280px}
  .leaflet-container{z-index:1}

  /* ì¹´ë“œ ìºëŸ¬ì…€ (ê³µí†µ ì¹´ë“œ ë””ìì¸) */
  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 4px}
  .carousel::-webkit-scrollbar{display:none}
  .r-card{
    scroll-snap-align:start;width:336px;flex:0 0 auto; /* ì•½ 10% í™•ëŒ€ */
    position:relative; background:#121428; border:1px solid rgba(255,255,255,.14);
    border-radius:16px; padding:14px; box-shadow:0 2px 14px rgba(0,0,0,.28);
  }
  .r-card h3{margin:0 0 6px;font-size:18px;font-weight:800; padding-right:100px} /* ë°°ì§€ ê²¹ì¹¨ ë°©ì§€ */
  .r-meta{display:flex;align-items:center;gap:8px;color:#cfd2ff;font-size:14px}
  .r-route{display:flex;align-items:center;gap:8px;margin:6px 0 4px;color:#ced2f9}
  .r-msg{color:#e6e8ff;font-size:14px;margin:6px 0}
  .r-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .r-chip{
    padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#e6e8ef
  }
  .r-chip.is-urban{background:#1e2d55;border-color:#2c4484}
  .r-chip.is-curve{background:#2a1f56;border-color:#40307a}
  .r-chip.is-tour{background:#1e3b3a;border-color:#2f5f5d}
  .r-chip.is-easy{background:#1f3a1f;border-color:#2f5a2f}
  .r-chip.is-balanced{background:#3a341e;border-color:#5a4f2f}
  .r-chip.is-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .r-btm{
    margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap
  }
  .join{
    flex:1;min-width:140px;padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer
  }
  .cap{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);color:#dfe3ff;font-weight:800}

  /* ì„ë°• ë°°ì§€ (ê¸€ë¡œìš°) */
  .imminent{
    position:absolute; top:10px; right:10px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:800;
    background:var(--imminent-bg); border:1px solid var(--imminent-bd); color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* í…Œë§ˆ ë³´ë” */
  .r-card[data-theme="red"]   { border-color:var(--t-red-br) }
  .r-card[data-theme="blue"]  { border-color:var(--t-blue-br) }
  .r-card[data-theme="yellow"]{ border-color:var(--t-yellow-br) }
  .r-card[data-theme="green"] { border-color:var(--t-green-br) }
  .r-card[data-theme="purple"]{ border-color:var(--t-purple-br) }

  /* í•˜ë‹¨ ë„¤ë¹„ */
  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:#182039;border:1px solid #2d3559;color:#e6e8ef;padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:#26346d;border-color:#3b53a8}

  /* ëª¨ë°”ì¼ ì•ˆì „ë§ */
  @media (max-width:520px){
    #map{height:300px;min-height:240px}
    .r-card{width:88vw;max-width:420px}
  }

/* ==== ëª¨ë‹¬: íƒ€ì´í¬/íŒ¨ë”© ì¶•ì†Œ & ì—¬ë°± í™•ëŒ€ ==== */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:4000;
/* ë°”ê¹¥ í´ë¦­ ê³µê°„ ë„“í˜ */
background:rgba(0,0,0,.45);padding:min(8vh,48px) 16px;}
.modal.show{display:flex}

/* íŒ¨ë„ í¬ê¸°Â·íƒ€ì´í¬ ì¶•ì†Œ */
#joinSheet.panel{
  width:100%; max-width:560px;
  background:#0e1222; border:1px solid #2b304f; border-radius:16px;
  padding:12px 12px 14px; /* â†“ */
  font-size:13px;         /* â†“ */
}
#joinSheet h4{margin:2px 0 8px;font-size:16px} /* â†“ */
.hint{color:#cfd2ff;line-height:1.45;margin-bottom:8px;font-size:12.5px} /* â†“ */
#preview.pre{
  background:#0b1020; border:1px solid #293059; border-radius:12px;
  padding:10px; white-space:pre-wrap; line-height:1.35;
  min-height:72px; max-height:35vh; overflow:auto; color:#e6e9ff; font-size:13px; /* â†“ */
}
.modal-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px}
.modal-actions button{flex:1;min-width:112px;max-width:168px;padding:10px 12px;border-radius:10px;
  border:none;background:var(--btn,#2A2F4F);color:#fff;font-size:14px;font-weight:800;cursor:pointer}

/* í•©ë¥˜ ë²„íŠ¼(ì¹´ë“œ í•˜ë‹¨) ìŠ¤íƒ€ì¼ ë³´ê°• */
.join{margin-top:6px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;
      background:rgba(255,255,255,.14);cursor:pointer}
.join:hover{background:rgba(255,255,255,.20)}

/* ì¶œë°œ ì„ë°• ê¸€ë¡œìš° */
.imminent{
  position:absolute; top:10px; right:10px; display:inline-flex; gap:6px;
  padding:8px 10px; border-radius:10px; font-size:12px; font-weight:800;
  background:var(--imminent-bg,rgba(255,199,94,.16));
  border:1px solid var(--imminent-bd,rgba(255,199,94,.45)); color:#ffe7a6;
  animation:rimoPulse 2.2s ease-in-out infinite;
}
@keyframes rimoPulse{
  0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
  70%{box-shadow:0 0 0 10px rgba(255,199,94,0)}
  100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
}

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map"></div>
  <section id="list" class="carousel"></section>
</main>

<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab primary">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- í•©ë¥˜ ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
  <div class="sheet" id="joinSheet">
    <h4 id="joinTitle">âœ… í•©ë¥˜ ì‹ ì²­í•˜ê¸°</h4>
    <div class="hint">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ <b>ìš´ì˜ì 1:1 ì±„íŒ…</b>ì„ ì—´ì–´ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”. ìŠ¹ì¸ë˜ë©´ ë¼ì´ë” í¬ë£¨ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ˆëŒ€ë©ë‹ˆë‹¤.</div>
    <div id="preview" class="pre"></div>
    <div class="modal-actions">
      <button id="goAdmin">ì´ëŒ€ë¡œ ì‹ ì²­í•˜ê¸°</button>
      <button id="editProfile">í”„ë¡œí•„ ìˆ˜ì •</button>
      <button id="copyProfileBtn">ë‹¤ì‹œ ë³µì‚¬</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ===== ì„¤ì • ===== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw7jNF2Qk0IqOSQhsGPJW5I7ifiSNl74FyNRTdHvi9jXikDDZAM19RG6zwNMakwPukn9w/exec";
const CACHE_KEY   = "rimo_published_cards_server_cache";
const GRACE_MS    = 8*60*1000;     // ì¶œë°œ +8ë¶„ê¹Œì§€ ë…¸ì¶œ
const IMMINENT_MS = 30*60*1000;    // ì¶œë°œ 30ë¶„ ì „ ì„ë°•
const ADMIN_DM    = "http://pf.kakao.com/_ceUDn/chat";
const LS_KEY      = "rimo_profile_v1";

document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* ===== ìœ í‹¸ ===== */
function pad(n){return String(n).padStart(2,'0')}
function formatKDate(dt){
  const y  = dt.getFullYear();
  const mm = pad(dt.getMonth()+1);
  const dd = pad(dt.getDate());
  let h = dt.getHours();
  const ampm = (h >= 12) ? 'ì˜¤í›„' : 'ì˜¤ì „';
  h = h % 12; if (h === 0) h = 12;
  const hh = pad(h); const mi = pad(dt.getMinutes());
  return `${y}/${mm}/${dd}/${ampm} ${hh}:${mi}`;
  const THEME_COLORS = {
  red:'#ff5d5d', blue:'#7aa7ff', yellow:'#ffd85d', green:'#56d364', purple:'#a78bfa'
};

function toList(v){
  if (v==null) return [];
  if (Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean);
  const s=String(v).trim(); if(!s) return [];
  if (/^\[Ljava\.lang\.Object;/.test(s)) return [];
  try{ const j=JSON.parse(s); if(Array.isArray(j)) return j.map(x=>String(x).trim()).filter(Boolean); }catch(_){}
  return s.split(/[,\|/Â·]/).map(x=>x.trim()).filter(Boolean);
}
function normalizeRow(it){
  const dt = it.datetime ? new Date(it.datetime) : null;
  return {
    id: it.id || `id_${Math.random().toString(36).slice(2,8)}`,
    title: it.title||'(ì œëª© ì—†ìŒ)',
    datetime: it.datetime || '',
    datetime_display: it.datetime_display || (dt?formatKDate(dt):''),
    from: it.from||'-', to: it.to||'-',
    from_lat:+it.from_lat||null, from_lng:+it.from_lng||null, to_lat:+it.to_lat||null, to_lng:+it.to_lng||null,
    cc: it.cc||'',
    styles: toList(it.styles),
    pace: toList(it.pace),
    message: it.message||'',
    remaining: Number.isFinite(+it.remaining)? +it.remaining : 0,
    capacity:  Number.isFinite(+it.capacity)?  +it.capacity  : 0,
    theme: it.theme||'blue'
  };
}

/* ===== ë°ì´í„° ë¡œë“œ (fetch â†’ JSONP â†’ ìºì‹œ) ===== */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now(); const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url+(url.includes('?')?'&':'?')+'op=list&callback='+cb+'&_='+Date.now();
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadCrews(){
  let cached=[]; try{ cached=JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch(_){}
  if(cached.length) renderAll(cached.map(normalizeRow)); // ëª¨ë°”ì¼ ì´ˆê¸° ì²´ê° ê°œì„ 

  try{
    const r=await fetch(WEB_APP_URL+'?op=list&_='+Date.now(),{cache:'no-store'});
    if(r.ok){
      const j=await r.json(); const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
      localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
      return rows.map(normalizeRow);
    }
  }catch(_){}

  try{
    const j=await fetchJSONP(WEB_APP_URL); const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
    if(rows.length){ localStorage.setItem(CACHE_KEY, JSON.stringify(rows)); return rows.map(normalizeRow); }
  }catch(_){}

  return cached.map(normalizeRow);
}

/* ===== ì§€ë„ ===== */
let map, group, arcs;
function initMap(){
  map=L.map('map',{scrollWheelZoom:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  group=L.featureGroup().addTo(map);
  arcs=L.layerGroup().addTo(map);
}
function makePin(color,label){
  return L.divIcon({className:'pin',html:`<div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35);background:${color}">${label}</div>`,iconSize:[28,28],iconAnchor:[14,14]});
}
function arcCoords(aLat,aLng,bLat,bLng,k=.18){const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2,vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1,nx=-vy/len,ny=vx/len,off=Math.max(len*k,0.01);const cx=mx+nx*off,cy=my+ny*off;return [[y1,x1],[cy,cx],[y2,x2]];}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    if(!(c.from_lat&&c.from_lng&&c.to_lat&&c.to_lng)) return;
    const color = THEME_COLORS[c.theme] || THEME_COLORS.blue; // â† ì¹´ë“œ í…Œë§ˆì™€ ë™ì¼
    const ms=L.marker([c.from_lat,c.from_lng],{icon:makePin(color,'S')}).addTo(group);
    const md=L.marker([c.to_lat,c.to_lng],{icon:makePin(color,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.from_lat,c.from_lng,c.to_lat,c.to_lng),{color,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng())); a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}


/* ===== ì¹´ë“œ ===== */
function cls(label){
  switch(String(label).toLowerCase()){
    case 'urban': return 'is-urban';
    case 'curve': return 'is-curve';
    case 'tour': return 'is-tour';
    case 'easy': return 'is-easy';
    case 'balanced': return 'is-balanced';
    case 'dynamic': return 'is-dynamic';
    default: return '';
  }
}
function chip(label){ return `<span class="r-chip ${cls(label)}">${label}</span>`; }

const listEl=document.getElementById('list');

function renderCards(crews){
  const list=document.getElementById('list'); list.innerHTML='';
  crews.forEach(c=>{
    const capacity = Number(c.capacity)||0;
    const remaining = Number.isFinite(Number(c.remaining)) ? Number(c.remaining) : 0;
    const joined = Math.max(0, capacity - remaining);
    const immin = (c.datetime && (new Date(c.datetime).getTime() - Date.now() < 30*60*1000) && (Date.now() <= new Date(c.datetime).getTime()));

    const el=document.createElement('article');
    el.className='card'; el.dataset.theme=c.theme;
    el.innerHTML=`
      <h3>${c.title||''}</h3>
      <div class="meta">â° ${c.datetime_display || (c.datetime?formatKDate(new Date(c.datetime)):'')}</div>
      <div class="route"><span class="pin"></span><span>${c.from||'-'}</span><span class="dash"></span><span class="pin"></span><span>${c.to||'-'}</span></div>
      ${c.message?`<div class="msg">ğŸ’¬ ${c.message}</div>`:''}
      <div class="pillrow">
        ${c.styles.map(chip).join('')}
        ${c.pace.map(chip).join('')}
        ${c.cc?chip(c.cc):''}
      </div>
      <button class="join">ğŸ‘¥ ${joined}/${capacity} Â· âœ… í•©ë¥˜ ì‹ ì²­</button>
      ${immin?`<div class="imminent">ğŸš¦ ì¶œë°œ ì„ë°•</div>`:''}
    `;
    el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));
    list.appendChild(el);
  });
}


    // í•©ë¥˜ ë²„íŠ¼
    el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));

    listEl.appendChild(el);
  });
}

/* ===== ì „ì²´ ë Œë”: ì‹œê°„ í•„í„°(+8ë¶„ ìœ ì˜ˆ), ì •ë ¬ ===== */
function renderAll(rows){
  const now=Date.now();
  const live=rows
    .filter(r=>{
      if(!r.datetime) return true;
      const t=new Date(r.datetime).getTime();
      return t + GRACE_MS >= now; // ì¶œë°œ + 8ë¶„ê¹Œì§€ë§Œ ë…¸ì¶œ
    })
    .sort((a,b)=>{
      const ta=a.datetime?new Date(a.datetime).getTime():Infinity;
      const tb=b.datetime?new Date(b.datetime).getTime():Infinity;
      return ta - tb;
    });

  renderCards(live);
  renderMap(live);
}

/* ===== í•©ë¥˜ ëª¨ë‹¬ ===== */
const modal=document.getElementById('joinModal');
const sheet=document.getElementById('joinSheet');
const preview=document.getElementById('preview');

function closeJoinModal(){ modal.classList.remove('show'); }
modal.addEventListener('click', closeJoinModal);
sheet.addEventListener('click', e=>e.stopPropagation());

document.getElementById('editProfile').onclick=()=> location.href='rimo_profile.html';

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function composeText(crew, profile){
  const styles=(profile.styles||[]).join(' Â· ') || '-';
  const paces =(profile.pace  ||[]).join(' Â· ') || '-';
  const t = crew.datetime ? formatKDate(new Date(crew.datetime)) : (crew.datetime_display||'-');
  return (
`[âœ… í•©ë¥˜ ì‹ ì²­] ${crew.title}
â° ì‹œê°„ : ${t}
ğŸ“ ê²½ë¡œ : ${crew.from} â†’ ${crew.to}

ğŸ‘¤ ë¼ì´ë” : ${profile.name || 'ì´ë¦„ ë¯¸ì…ë ¥'} ${profile.icon || ''}
ğŸï¸ ë°”ì´í¬ : ${profile.bike || 'ë¯¸ì…ë ¥'}
â° ì„ í˜¸ ì‹œê°„ëŒ€ : ${profile.time || '-'}
ğŸ‘¥ íƒ ë¤ : ${profile.tandem ? 'íƒ ë¤ ' + profile.tandem : '-'}

ğŸ¯ ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤
${styles} Â· ${paces}`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); return true; }
}
function openJoinModal(crew){
  const profile=loadProfile();
  const text=composeText(crew, profile);
  preview.textContent=text;
  copyText(text);
  modal.classList.add('show');
  document.getElementById('goAdmin').onclick=()=>{ window.open(ADMIN_DM,'_blank'); };
  document.getElementById('copyProfileBtn').onclick=()=> copyText(text);
}

/* ===== init ===== */
(async function init(){
  initMap();
  const rows = await loadCrews();
  renderAll(rows);
})();
</script>
</body>
</html>
