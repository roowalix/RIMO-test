<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<style>
  :root{
    --bg:#0b0b0f; --fg:#e8e8ef; --muted:#b9b9cc; --border-1:#232333;

    /* ì„ë°• ë°°ì§€ */
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);

    /* í…Œë§ˆ ë³´ë”ìƒ‰ (rimo_crewì™€ ë™ì¼) */
    --t-red-br:rgba(255,93,93,.35);
    --t-blue-br:rgba(122,167,255,.35);
    --t-yellow-br:rgba(255,216,93,.38);
    --t-green-br:rgba(86,211,100,.42);
    --t-purple-br:rgba(167,139,250,.42);
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif;
  }

  /* í—¤ë” */
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(11,11,15,.9); backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border-1)
  }
  .bar{display:flex;gap:10px;align-items:center;padding:12px 16px}
  .logo{font-weight:900}
  .title{font-weight:900;font-size:16px}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  /* ë³¸ë¬¸ */
  main{padding:16px;max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1)}
  .leaflet-container{z-index:1}

/* ê¸°ì¡´: padding:8px 4px 0;  â†’ ì˜¤ë¥¸ìª½/ì•„ë˜ ê³µê°„ ë¶€ì¡± */
.carousel{
  display:flex; gap:12px; overflow-x:auto;
  /* ê· í˜• ì¡íŒ ì—¬ë°±ìœ¼ë¡œ êµì²´ */
  padding:8px 12px 12px;
  scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain;
}
.carousel::-webkit-scrollbar{display:none}


  /* ì¹´ë“œ: ì„¸ë¡œ ë¦¬ë“¬ ì •ë ¬ */
  .r-card{
    position:relative; flex:0 0 304px; width:304px; scroll-snap-align:start; scroll-snap-stop:always;
    background:#121428; border:1px solid rgba(255,255,255,.14);
    border-radius:16px; padding:14px; box-shadow:0 2px 14px rgba(0,0,0,.28);
    display:flex; flex-direction:column; gap:10px; cursor:pointer;
    transition:box-shadow .18s, transform .12s, border-color .18s, background-color .18s;
  }
  .r-card *{ line-height:1.35 }              /* í…ìŠ¤íŠ¸ ë¼ì¸ ë†’ì´ í†µì¼ */
  .r-card:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.34) }

  .r-card h3{margin:0;font-size:16px;font-weight:700}
  .r-meta{display:flex;align-items:center;gap:4px;color:#cfd2ff;font-size:14px}
  .r-route{display:flex;align-items:center;gap:8px;color:#ced2f9;font-size:14px;margin:0}
  .r-msg{color:#e6e8ff;font-size:14px;margin:0}
  .r-chips{display:flex;flex-wrap:wrap;gap:8px;margin:0}
  .r-chip{
    padding:6px 8px;border-radius:999px;font-size:12px;font-weight:600;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:#e6e8ef
  }
  .r-chip.is-urban{background:#1e2d55;border-color:#2c4484}
  .r-chip.is-curve{background:#2a1f56;border-color:#40307a}
  .r-chip.is-tour{background:#1e3b3a;border-color:#2f5f5d}
  .r-chip.is-easy{background:#1f3a1f;border-color:#2f5a2f}
  .r-chip.is-balanced{background:#3a341e;border-color:#5a4f2f}
  .r-chip.is-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .r-cta{
    margin-top:2px; width:100%; padding:12px; border-radius:12px; border:none;
    background:rgba(255,255,255,.06); color:#dfe3ff; font-weight:800; cursor:pointer;
  }
  .r-cta:focus{outline:2px solid rgba(255,255,255,.25); outline-offset:2px}

  /* ì¹´ë“œ í…Œë§ˆ ë³´ë” */
  .r-card[data-theme="red"]   { border-color:var(--t-red-br) }
  .r-card[data-theme="blue"]  { border-color:var(--t-blue-br) }
  .r-card[data-theme="yellow"]{ border-color:var(--t-yellow-br) }
  .r-card[data-theme="green"] { border-color:var(--t-green-br) }
  .r-card[data-theme="purple"]{ border-color:var(--t-purple-br) }

  /* ê³µí†µ: ê³¼í•œ ë°”ê¹¥ ê¸€ë¡œìš° ì œê±°, ì¸ì…‹ ë³´ë” + ë¯¸ì„¸ ë°°ê²½ë§Œ */
.r-card.selected{
  transform:none;
  /* ê³µí†µ ê¸°ë³¸ê°’(blue ê³„ì—´) â€” í…Œë§ˆë³„ ë³€ìˆ˜ë¡œ ë®ì–´ì”€ */
  --sel-bd: rgba(122,167,255,.60);
  --sel-bg: rgba(122,167,255,.06);

  border-color: var(--sel-bd);
  box-shadow:
    0 0 0 1px var(--sel-bd) inset,    /* ì–‡ì€ ì¸ì…‹ ë³´ë” */
    0 10px 26px rgba(0,0,0,.44);      /* ì‚´ì§ë§Œ ë“œë */
  background: linear-gradient(180deg, var(--sel-bg), #121428 42%);
}

/* í…Œë§ˆë³„ ì»¬ëŸ¬ ë³€ìˆ˜ë§Œ ì§€ì • (ë°°ê²½/ë³´ë” ì¼ê´€) */
.r-card[data-theme="red"].selected    { --sel-bd: rgba(255, 93, 93,.60);  --sel-bg: rgba(255, 93, 93,.06); }
.r-card[data-theme="yellow"].selected { --sel-bd: rgba(255,216, 93,.60);  --sel-bg: rgba(255,216, 93,.06); }
.r-card[data-theme="green"].selected  { --sel-bd: rgba( 86,211,100,.60);  --sel-bg: rgba( 86,211,100,.06); }
.r-card[data-theme="purple"].selected { --sel-bd: rgba(167,139,250,.60);  --sel-bg: rgba(167,139,250,.06); }
/* blue í…Œë§ˆëŠ” ê³µí†µ ê¸°ë³¸ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© */


  /* ì¶œë°œ ì„ë°• */
  .imminent{
    position:absolute; top:10px; right:10px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:800;
    background:var(--imminent-bg); border:1px solid var(--imminent-bd); color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}
    70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}
    100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}
  }

  /* í•˜ë‹¨ íƒ­ */
  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:#182039;border:1px solid #2d3559;color:#e6e8ef;
               padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:#26346d;border-color:#3b53a8}

  /* íŒíŠ¸ */
  .hint{color:#cfd2ff99;font-size:14px;padding:12px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map" aria-label="ë¼ì´ë”© ê²½ë¡œ ì§€ë„"></div>
  <section id="list" class="carousel" aria-label="ë¼ì´ë”© ëª©ë¡"></section>
</main>

<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab primary">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- í•©ë¥˜ ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle" style="display:none;align-items:center;justify-content:center;z-index:4000;background:rgba(0,0,0,.45);padding:22px 12px;position:fixed;inset:0;">
  <div class="sheet" style="width:min(680px, 92vw);background:#0e1222;border:1px solid #2b304f;border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.55);padding:12px;">
    <h4 id="joinTitle" style="margin:0 0 8px;font-size:16px">âœ… í•©ë¥˜ ì‹ ì²­í•˜ê¸°</h4>
    <div class="hint">ì•„ë˜ ë‚´ìš©ì„ <b>ìš´ì˜ì 1:1 ì±„íŒ…</b>ì— ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”. ìŠ¹ì¸ë˜ë©´ í¬ë£¨ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ˆëŒ€ë©ë‹ˆë‹¤.</div>
    <div id="joinPreview" class="pre" style="background:#0b1020;border:1px solid #293059;border-radius:12px;padding:10px;white-space:pre-wrap;line-height:1.35;min-height:84px;max-height:38vh;overflow:auto;color:#e6e9ff;font-size:13px"></div>
    <div class="modal-actions" style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px">
      <button id="goAdmin" style="flex:1;min-width:110px;max-width:160px;padding:10px;border-radius:10px;border:none;background:#2A2F4F;color:#fff;font-size:14px;font-weight:800;cursor:pointer">ì´ëŒ€ë¡œ ì‹ ì²­</button>
      <button id="editProfile" style="flex:1;min-width:110px;max-width:160px;padding:10px;border-radius:10px;border:none;background:#2A2F4F;color:#fff;font-size:14px;font-weight:800;cursor:pointer">í”„ë¡œí•„ ìˆ˜ì •</button>
      <button id="copyProfileBtn" style="flex:1;min-width:110px;max-width:160px;padding:10px;border-radius:10px;border:none;background:#2A2F4F;color:#fff;font-size:14px;font-weight:800;cursor:pointer">ë³µì‚¬</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ===== ì„¤ì • & ìƒìˆ˜ ===== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzjogZFqCVW3pjTRtvet4J0uTyu3gsNiEHbbsTND9nI6v6PPjbhYSW9R7iz0Kcy5N_t5w/exec"; // rimo_crewì™€ ë™ì¼
const SHARED_TOKEN = ""; // (ì˜µì…˜) Apps Scriptì—ì„œ ê²€ì‚¬ ì‹œ ë§ì¶”ì„¸ìš”.
const CACHE_KEY   = "rimo_published_cards_server_cache";
const PROFILE_KEY = "rimo_profile_v1";
const ADMIN_DM    = "http://pf.kakao.com/_ceUDn/chat";

/* ì‹œê°„ ì •ì±… */
const IMMINENT_MS = 30*60*1000;   // ì¶œë°œ 30ë¶„ ì „
const GRACE_MS    = 8*60*1000;    // ì¶œë°œ 8ë¶„ í›„ê¹Œì§€ ë…¸ì¶œ

/* í…Œë§ˆë³„ ìƒ‰ (ì§€ë„ í•€/ë¼ì¸ê³¼ ì¼ì¹˜) */
const THEMES = {
  red:    { base:'#ff4d4d', border:'var(--t-red-br)'   },
  yellow: { base:'#ffd24d', border:'var(--t-yellow-br)'},
  blue:   { base:'#5b8cff', border:'var(--t-blue-br)'  },
  green:  { base:'#46d37d', border:'var(--t-green-br)' },
  purple: { base:'#a78bfa', border:'var(--t-purple-br)'}
};

/* ì˜¤ëŠ˜ í‘œì‹œ */
document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* ===== ìœ í‹¸ ===== */
const pad = n => String(n).padStart(2,'0');
function formatTimeKOR(d){
  const Y=d.getFullYear(), M=pad(d.getMonth()+1), D=pad(d.getDate());
  const h=d.getHours(), m=pad(d.getMinutes());
  const ampm = h>=12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
  const hh = String((h%12)||12).padStart(2,'0');
  return `${Y}/${M}/${D}/${ampm} ${hh}:${m}`;
}
function toList(v){
  if(v==null) return [];
  if(Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean);
  const s=String(v).trim(); if(!s) return [];
  if(/Ljava\.lang\.Object/i.test(s)) return [];
  try{ const j=JSON.parse(s); if(Array.isArray(j)) return j.map(x=>String(x).trim()).filter(Boolean); }catch(_){}
  return s.split(/[,\|/Â·]/).map(x=>x.trim()).filter(Boolean);
}
function normalizeRow(it){
  const dtStr = it.datetime || it.date || '';
  const dt = dtStr ? new Date(dtStr) : null;
  return {
    id: it.id || `id_${Math.random().toString(36).slice(2,8)}`,
    title: it.title||'(ì œëª© ì—†ìŒ)',
    datetime: dtStr,
    timeLabel: it.datetime_display || (dt ? formatTimeKOR(dt) : ''),
    from: it.from||'-', to: it.to||'-',
    from_lat:+it.from_lat||null, from_lng:+it.from_lng||null, to_lat:+it.to_lat||null, to_lng:+it.to_lng||null,
    cc: it.cc||'',
    styles: toList(it.styles),
    pace: toList(it.pace),
    message: it.message||'',
    remaining: Number.isFinite(+it.remaining)? +it.remaining : 0, // remaining = ì°¸ì„ì ìˆ˜
    capacity:  Number.isFinite(+it.capacity)?  +it.capacity  : 0,
    theme: it.theme||'blue'
  };
}

/* ===== ë°ì´í„° ë¡œë“œ (fetch â†’ JSONP â†’ ìºì‹œ) ===== */
function buildListURL(){
  return WEB_APP_URL + `?op=list&scope=all${SHARED_TOKEN ? `&token=${encodeURIComponent(SHARED_TOKEN)}` : ''}&_=${Date.now()}`;
}
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now(), s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadCrews(){
  let cached=[]; try{ cached=JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch(_){}
  if(cached.length) renderAll(cached.map(normalizeRow)); // ë¨¼ì € ìºì‹œ í‘œì‹œ

  const listURL = buildListURL();

  // ì‹œë„1: fetch (CORS í—ˆìš©ì‹œ)
  try{
    const r=await fetch(listURL,{cache:'no-store'});
    if(r.ok){
      const j=await r.json().catch(()=>null);
      const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
      if(rows?.length){
        localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
        return rows.map(normalizeRow);
      }
    }
  }catch(_){}

  // ì‹œë„2: JSONP í´ë°±
  try{
    const j=await fetchJSONP(listURL);
    const rows=Array.isArray(j)?j:(Array.isArray(j?.rows)?j.rows:[]);
    if(rows?.length){
      localStorage.setItem(CACHE_KEY, JSON.stringify(rows));
      return rows.map(normalizeRow);
    }
  }catch(_){}

  // ì‹œë„3: ìºì‹œ
  return cached.map(normalizeRow);
}

/* ===== ì§€ë„ ===== */
let map, group, arcs;
const boundsById = new Map();
function initMap(){
  map=L.map('map',{scrollWheelZoom:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  group=L.featureGroup().addTo(map);
  arcs=L.layerGroup().addTo(map);
}
function makePin(color,label){
  return L.divIcon({className:'pin',
    html:`<div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35);background:${color}">${label}</div>`,
    iconSize:[28,28],iconAnchor:[14,14]
  });
}
function arcCoords(aLat,aLng,bLat,bLng,k=.18){
  const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;
  const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;
  const nx=-vy/len,ny=vx/len,off=Math.max(len*k,0.01);
  const cx=mx+nx*off,cy=my+ny*off; return [[y1,x1],[cy,cx],[y2,x2]];
}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers(); boundsById.clear();
  const allBounds=L.latLngBounds([]);
  crews.forEach(c=>{
    if(!(c.from_lat&&c.from_lng&&c.to_lat&&c.to_lng)) return;
    const t=THEMES[c.theme]||THEMES.blue;
    const ms=L.marker([c.from_lat,c.from_lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.to_lat,c.to_lng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.from_lat,c.from_lng,c.to_lat,c.to_lng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);

    const b=L.latLngBounds([ms.getLatLng(), md.getLatLng(), ...a.getLatLngs()]);
    boundsById.set(c.id, b);
    allBounds.extend(b);
  });
  if(allBounds.isValid()) map.fitBounds(allBounds.pad(0.25));
}

/* ===== ì¹© ===== */
function chipClass(v){ switch(String(v).toLowerCase()){
  case 'urban':return 'is-urban'; case 'curve':return 'is-curve'; case 'tour':return 'is-tour';
  case 'easy':return 'is-easy'; case 'balanced':return 'is-balanced'; case 'dynamic':return 'is-dynamic';
  default:return ''; } }
const chip = v => `<span class="r-chip ${chipClass(v)}">${v}</span>`;

/* ===== ì¹´ë“œ ë Œë” & ì„ íƒ ===== */
let currentSelectedId = null;
function selectCardAndZoom(id){
  currentSelectedId = id;
  document.querySelectorAll('.r-card').forEach($c=>{
    $c.classList.toggle('selected', $c.dataset.id===id);
  });
  const b = boundsById.get(id);
  if(b && b.isValid()){
    map.fitBounds(b.pad(0.25), { animate:true, duration:.6 });
  }
}

function renderCards(crews){
  const list=document.getElementById('list'); list.innerHTML='';

  if(!crews.length){
    const empty=document.createElement('div');
    empty.className='r-card';
    empty.innerHTML='<div class="r-msg">í‘œì‹œí•  ë¼ì´ë”©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    list.appendChild(empty);
    return;
  }

  crews.forEach(c=>{
    const capacity  = Math.max(0, c.capacity||0);
    const attendees = Math.max(0, c.remaining||0); // remaining = ì°¸ì„ì ìˆ˜

    const immin  = (c.datetime? (new Date(c.datetime).getTime()-Date.now()) : 0);
    const showImmin = (immin<=IMMINENT_MS && immin>=-GRACE_MS);

    const el=document.createElement('article');
    el.className='r-card'; el.dataset.theme=c.theme; el.dataset.id=c.id;
    el.setAttribute('role','button'); el.setAttribute('tabindex','0');
    el.setAttribute('aria-label', `${c.title} ìƒì„¸ ë³´ê¸° ë° ì§€ë„ ì´ë™`);

    el.innerHTML=`
      <h3>${c.title}</h3>
      <div class="r-meta">â° <span>${c.timeLabel || ''}</span></div>
      <div class="r-route">ğŸ“Œ  ${c.from} - ${c.to}</div>
      ${c.message?`<div class="r-msg">ğŸ’¬  ${c.message}</div>`:''}
      <div class="r-chips">
        ${c.styles.map(chip).join('')}
        ${c.pace.map(chip).join('')}
        ${c.cc?chip(c.cc):''}
      </div>
      <button class="r-cta" aria-label="í•©ë¥˜ ì‹ ì²­">ğŸ‘¥ ${attendees}/${capacity} Â· í•©ë¥˜ ì‹ ì²­</button>
      ${showImmin?`<div class="imminent">ğŸš¦ ì¶œë°œ ì„ë°•</div>`:''}
    `;

    el.addEventListener('click', ()=> selectCardAndZoom(c.id));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectCardAndZoom(c.id); } });
    el.querySelector('.r-cta').addEventListener('click',(ev)=>{ ev.stopPropagation(); openJoinModal(c); });

    list.appendChild(el);
  });

  const first = list.querySelector('.r-card');
  if(first && !currentSelectedId) selectCardAndZoom(first.dataset.id);
}

/* ===== ì „ì²´ ë Œë”: ì‹œê°„ í•„í„°(+8ë¶„ ìœ ì˜ˆ) + ì‹œê°„ìˆœ ì •ë ¬ ===== */
function renderAll(rows){
  const now=Date.now();
  const live=rows.filter(r=>{
    if(!r.datetime) return true;
    const t=new Date(r.datetime).getTime();
    return (t + GRACE_MS) >= now;
  }).sort((a,b)=>{
    const ta=a.datetime?new Date(a.datetime).getTime():Infinity;
    const tb=b.datetime?new Date(b.datetime).getTime():Infinity;
    return ta-tb;
  });

  renderMap(live);   // ì§€ë„ ë¨¼ì €
  renderCards(live); // ê·¸ ë‹¤ìŒ ì¹´ë“œ (ì´ˆê¸° ì„ íƒ ì‹œ ì¦‰ì‹œ ì¤Œ)
}

/* ===== í•©ë¥˜ ì‹ ì²­ ëª¨ë‹¬ ===== */
const modal=document.getElementById('joinModal');
const preview=document.getElementById('joinPreview');
function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(_){ return {}; } }
function composeText(crew, profile){
  const styles=(profile.styles||[]).join(' Â· ') || '-';
  const paces =(profile.pace  ||[]).join(' Â· ') || '-';
  return (
`[âœ… í•©ë¥˜ ì‹ ì²­] ${crew.title}
ğŸ“ ì¶œë°œ â†’ ë„ì°©
${crew.from} â†’ ${crew.to}

â° ${crew.timeLabel}
ğŸ‘¤ ë¼ì´ë” : ${profile.name || 'ì´ë¦„ ë¯¸ì…ë ¥'} ${profile.icon || ''}
ğŸï¸ ë°”ì´í¬ : ${profile.bike || 'ë¯¸ì…ë ¥'}
ğŸ‘¥ íƒ ë¤ : ${profile.tandem ? 'íƒ ë¤ ' + profile.tandem : '-'}

ğŸ¯ ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤
${styles} Â· ${paces}`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove(); return true; }
}
function openJoinModal(crew){
  const profile=loadProfile();
  const text=composeText(crew, profile);
  preview.textContent=text;
  try{ awaitCopy(text); }catch(_){}
  modal.style.display='flex';
  document.body.classList.add('modal-open');
  document.getElementById('goAdmin').onclick=()=>{ location.href=ADMIN_DM; };
  document.getElementById('editProfile').onclick=()=>{ location.href='rimo_profile.html'; };
  document.getElementById('copyProfileBtn').onclick=()=> copyText(text);
}
function awaitCopy(t){ return copyText(t); }
modal.addEventListener('click', e=>{
  if(e.target===modal) { modal.style.display='none'; document.body.classList.remove('modal-open'); }
});

/* ===== init ===== */
(async function init(){
  initMap();
  try{
    const rows = await loadCrews();
    renderAll(rows);
  }catch(err){
    const list=document.getElementById('list');
    const msg=document.createElement('div');
    msg.className='r-card';
    msg.innerHTML=`<div class="r-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì˜¤í”„ë¼ì¸ì´ê±°ë‚˜ ì›¹ì•± ì‘ë‹µ ì—†ìŒ)</div>`;
    list.appendChild(msg);
    console.warn(err);
  }
})();
</script>
</body>
</html>
