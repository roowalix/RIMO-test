<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIMO â€” ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<style>
  :root{
    --btn:#2A2F4F; --btnHover:#3C4380;
    --imminent-bg: rgba(255,199,94,.16);
    --imminent-bd: rgba(255,199,94,.45);
    --tab-bg:#182039; --tab-bd:#2d3559; --tab-ink:#e6e8ef;
    --tab-pri:#26346d; --tab-pri-bd:#3b53a8;
    --border-1:#2b2e48; --muted:#b9b9cc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b0b0f;color:#e8e8ef;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Roboto,Arial,sans-serif}

  header{position:sticky;top:0;z-index:5;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border-1)}
  .bar{display:flex;gap:10px;align-items:center;padding:14px 16px;height:56px}
  .logo{font-weight:900}
  .title{font-weight:800;opacity:.9}
  .pill{margin-left:auto;padding:6px 10px;border-radius:999px;background:#151525;color:#b9b9cc;font-size:12px}

  main{padding:16px;max-width:960px;margin:0 auto;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}
  #map{height:360px;border-radius:14px;outline:1px solid var(--border-1);background:#0f1220}
  .leaflet-container{z-index:1;border-radius:14px}

  .carousel{display:flex;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 4px 0}
  .carousel::-webkit-scrollbar{display:none}
  .card{
    scroll-snap-align:start;width:304px;flex:0 0 auto;border-radius:14px;padding:14px;
    display:flex;flex-direction:column;gap:8px;border:1px solid transparent;position:relative;
    background:rgba(255,255,255,.04);
  }
  .card h3{margin:0 0 2px;font-size:18px}
  .meta{font-size:14px;color:var(--muted)}
  .msg{font-size:14px}

  .pillrow{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px}
  .chip{padding:6px 9px;border-radius:999px;font-size:12px;font-weight:500;display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e6e8ef}
  .chip.pill-urban{background:#1e2d55;border-color:#2c4484}
  .chip.pill-curve{background:#2a1f56;border-color:#40307a}
  .chip.pill-tour{background:#1e3b3a;border-color:#2f5f5d}
  .chip.pill-easy{background:#1f3a1f;border-color:#2f5a2f}
  .chip.pill-balanced{background:#3a341e;border-color:#5a4f2f}
  .chip.pill-dynamic{background:#3a1f1f;border-color:#5a2f2f}

  .imminent{
    position:absolute;top:10px;right:10px;display:inline-flex;align-items:center;gap:6px;
    padding:8px 10px;border-radius:10px;font-size:12px;font-weight:700;
    background:var(--imminent-bg);border:1px solid var(--imminent-bd);color:#ffe7a6;
    animation:pulse 2.2s ease-in-out infinite;
  }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,199,94,.35)}70%{box-shadow:0 0 0 8px rgba(255,199,94,0)}100%{box-shadow:0 0 0 0 rgba(255,199,94,0)}}

  .join{margin-top:2px;width:100%;padding:14px;border-radius:12px;border:none;color:#fff;font-weight:800;background:rgba(255,255,255,.16);cursor:pointer}
  .card.selected{box-shadow:0 0 0 2px rgba(255,255,255,.12) inset}

  .pin{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#0b0b0f;border:2px solid rgba(255,255,255,.9);box-shadow:0 1px 6px rgba(0,0,0,.35)}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:4000;background:rgba(0,0,0,.45);padding:22px 12px}
  .modal.show{display:flex}
  #joinSheet.panel{width:calc(100% - 24px);max-width:680px;background:#0e1222;border:1px solid #2b304f;border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.55);padding:16px 16px 20px}
  #joinSheet h4{margin:4px 0 10px;font-size:18px}
  .hint{color:#cfd2ff;line-height:1.5;margin-bottom:10px}
  #preview.pre{background:#0b1020;border:1px solid #293059;border-radius:12px;padding:12px;white-space:pre-wrap;line-height:1.4;min-height:96px;max-height:42vh;overflow:auto;color:#e6e9ff}
  .modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;padding-bottom:6px}
  .modal-actions button{flex:1;min-width:110px;max-width:160px;padding:12px 18px;border-radius:12px;border:none;background:var(--btn);color:#fff;font-size:15px;font-weight:700;cursor:pointer}
  .modal-actions button:hover{background:var(--btnHover)}

  .tabbar{position:fixed;left:0;right:0;bottom:16px;z-index:1500;display:flex;gap:12px;justify-content:center}
  .tabbar .tab{background:var(--tab-bg);border:1px solid var(--tab-bd);color:var(--tab-ink);padding:12px 18px;border-radius:22px;font-weight:800;text-decoration:none;font-size:14px}
  .tabbar .tab.primary{background:var(--tab-pri);border-color:var(--tab-pri-bd)}
  body.modal-open .tabbar{pointer-events:none;opacity:.28;filter:saturate(.2) blur(1px);transform:translateY(2px)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">ğŸï¸ RIMO</div>
    <div class="title">ì˜¤ëŠ˜ì˜ ë¼ì´ë”© í¬ë£¨</div>
    <div class="pill" id="today"></div>
  </div>
</header>

<main>
  <div id="map" class="panel"></div>
  <section id="list" class="carousel"></section>
</main>

<nav class="tabbar" aria-label="í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜">
  <a href="index.html" class="tab primary">ë©”ì¸</a>
  <a href="rimo_profile.html" class="tab">í”„ë¡œí•„</a>
  <a href="rimo_ambassadors.html" class="tab">ì— ë²„ì„œë”</a>
</nav>

<!-- í•©ë¥˜ ì•ˆë‚´ ëª¨ë‹¬ -->
<div class="modal" id="joinModal" role="dialog" aria-modal="true" aria-labelledby="joinTitle">
  <div class="sheet panel" id="joinSheet">
    <h4 id="joinTitle">âœ… í•©ë¥˜ ì‹ ì²­í•˜ê¸°</h4>
    <div class="hint">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ <b>ìš´ì˜ì 1:1 ì±„íŒ…</b>ì„ ì—´ì–´ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”. ìŠ¹ì¸ë˜ë©´ ë¼ì´ë” í¬ë£¨ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ˆëŒ€ë©ë‹ˆë‹¤.</div>
    <div id="preview" class="pre"></div>
    <div class="modal-actions">
      <button id="goAdmin">ì´ëŒ€ë¡œ ì‹ ì²­í•˜ê¸°</button>
      <button id="editProfile">í”„ë¡œí•„ ìˆ˜ì •</button>
      <button id="copyProfileBtn">ë‹¤ì‹œ ë³µì‚¬</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ===== ê³µí†µ ìƒìˆ˜ ===== */
const ADMIN_DM = "http://pf.kakao.com/_ceUDn/chat";
const LS_KEY   = 'rimo_profile_v1';
const PUBLIST_KEY = 'rimo_published_cards_server_cache';
const EXP_MIN_AFTER_START = 5; // ì¶œë°œ +5ë¶„ê¹Œì§€ ë³´ì´ê¸°
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzdq7Qnr0FWAeTegP4aT06B9wXj5mC9Yi-5QCwcJYXd2sZTX8DFc0lfBlLrzpTE7TMNwQ/exec";

/* UI ë³´ì¡° */
document.getElementById('today').textContent =
  new Date().toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});

/* í…Œë§ˆ ìƒ‰ìƒ (ì§€ë„/ì¹´ë“œ) */
const THEMES = {
  red:    { base:'#ff4d4d', cardBg:'rgba(255,77,77,.14)',  border:'rgba(255,77,77,.55)'},
  yellow: { base:'#ffd24d', cardBg:'rgba(255,210,77,.16)', border:'rgba(255,210,77,.55)'},
  blue:   { base:'#5b8cff', cardBg:'rgba(91,140,255,.16)', border:'rgba(91,140,255,.55)'},
  green:  { base:'#46d37d', cardBg:'rgba(70,211,125,.16)', border:'rgba(70,211,125,.55)'},
  purple: { base:'#a78bfa', cardBg:'rgba(167,139,250,.16)', border:'rgba(167,139,250,.55)'},
};

/* ìœ í‹¸ */
const $ = (s,p=document)=>p.querySelector(s);
function pad(n){return String(n).padStart(2,'0')}
function formatKDate(d){return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ${pad(d.getHours())}:${pad(d.getMinutes())}`}
function normalizeArr(v){ if(Array.isArray(v)) return v; if(v==null) return []; return String(v).split(/[|,]/).map(s=>s.trim()).filter(Boolean); }
function parseStartISO(rec){
  if(rec.datetime){ const d=new Date(rec.datetime); if(!isNaN(d)) return d; }
  if(rec.datetime_display){
    const m = String(rec.datetime_display).match(/(\d+)ì›”\s+(\d+)ì¼\s+(\d+):(\d+)/);
    if(m){ const now=new Date(); return new Date(now.getFullYear(), m[1]-1, m[2], m[3], m[4], 0); }
  }
  return null;
}

/* ë°ì´í„° ë¡œë“œ (fetch â†’ JSONP í´ë°±) */
function fetchJSONP(url, timeoutMs=9000){
  return new Promise((resolve,reject)=>{
    const cb='__rimo_cb_'+Date.now();
    const s=document.createElement('script');
    const t=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'));},timeoutMs);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(t); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP error')); };
    document.body.appendChild(s);
  });
}
async function loadFromServer(){
  // 1) ìºì‹œ ë¨¼ì €
  let cached=[]; try{ cached=JSON.parse(localStorage.getItem(PUBLIST_KEY)||'[]'); }catch(_){}
  if (cached.length) renderAll(cached);

  // 2) í‘œì¤€ fetch
  try{
    const res = await fetch(WEB_APP_URL+'?op=list&_='+Date.now(), {cache:'no-store'});
    if(res.ok){
      const data = await res.json();
      const rows = Array.isArray(data) ? data : (Array.isArray(data?.rows) ? data.rows : []);
      if(rows.length){ localStorage.setItem(PUBLIST_KEY, JSON.stringify(rows)); return rows; }
    }
  }catch(e){ console.warn('fetch list failed; jsonp fallback', e); }

  // 3) JSONP í´ë°±
  try{
    const data = await fetchJSONP(WEB_APP_URL+'?op=list');
    const rows = Array.isArray(data) ? data : (Array.isArray(data?.rows) ? data.rows : []);
    if(rows.length){ localStorage.setItem(PUBLIST_KEY, JSON.stringify(rows)); return rows; }
  }catch(e){ console.warn('jsonp list failed', e); }

  return cached;
}

/* ì§€ë„ */
const map = L.map('map',{scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const group=L.featureGroup().addTo(map);
const arcs=L.layerGroup().addTo(map);

function makePin(color,label){
  return L.divIcon({className:'pin',
    html:`<div class="pin" style="background:${color}">${label}</div>`,
    iconSize:[28,28],iconAnchor:[14,14]
  });
}
function arcCoords(aLat,aLng,bLat,bLng,k=0.18){
  const x1=aLng,y1=aLat,x2=bLng,y2=bLat,mx=(x1+x2)/2,my=(y1+y2)/2;
  const vx=x2-x1,vy=y2-y1,len=Math.hypot(vx,vy)||1;
  const nx=-vy/len,ny=vx/len; let off=len*k; if(off<0.01) off=0.01;
  const cx=mx+nx*off,cy=my+ny*off; return [[y1,x1],[cy,cx],[y2,x2]];
}
function renderMap(crews){
  group.clearLayers(); arcs.clearLayers();
  const bounds=L.latLngBounds([]);
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    if(!(isFinite(c.from_lat)&&isFinite(c.from_lng)&&isFinite(c.to_lat)&&isFinite(c.to_lng))) return;
    const ms=L.marker([c.from_lat,c.from_lng],{icon:makePin(t.base,'S')}).addTo(group);
    const md=L.marker([c.to_lat,c.to_lng],{icon:makePin(t.base,'D')}).addTo(group);
    const a=L.polyline(arcCoords(c.from_lat,c.from_lng,c.to_lat,c.to_lng),{color:t.base,weight:2.5,dashArray:"6 8",opacity:.9}).addTo(arcs);
    [ms,md].forEach(m=>bounds.extend(m.getLatLng()));
    a.getLatLngs().forEach(p=>bounds.extend(p));
  });
  if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
}

/* ì¹´ë“œ */
const listEl=document.getElementById('list');
function chipClass(label){
  switch(String(label).toLowerCase()){
    case 'urban': return 'pill-urban';
    case 'curve': return 'pill-curve';
    case 'tour': return 'pill-tour';
    case 'easy': return 'pill-easy';
    case 'balanced': return 'pill-balanced';
    case 'dynamic': return 'pill-dynamic';
    default: return '';
  }
}
function chip(label){ return `<span class="chip ${chipClass(label)}">${label}</span>`; }

function renderCards(crews){
  listEl.innerHTML="";
  crews.forEach(c=>{
    const t=THEMES[c.theme]||THEMES.blue;
    const styles = normalizeArr(c.styles);
    const paces  = normalizeArr(c.pace);
    const start  = parseStartISO(c);
    const immin  = start ? (start - Date.now() <= 20*60*1000 && start - Date.now() > -5*60*1000) : false;

    const el=document.createElement('article');
    el.className="card"; el.dataset.id=c.id;
    el.style.border=`1px solid ${t.border}`; el.style.background=t.cardBg;
    el.innerHTML=`
      <h3>${c.title || '(ì œëª© ì—†ìŒ)'}</h3>
      <div class="meta">â° ${c.datetime_display || (start?formatKDate(start):'-')}</div>
      <div class="meta">ğŸ“ ${c.from || '-'} â†’ ${c.to || '-'}</div>
      <div class="msg">ğŸ’¬ ${c.message || '-'}</div>
      ${immin ? `<div class="imminent">ğŸš¦ ì¶œë°œ ì„ë°•</div>` : ``}
      <div class="pillrow">
        ${styles.map(chip).join("")}
        ${paces.map(chip).join("")}
        ${c.cc ? chip(c.cc) : ""}
      </div>
      <button class="join">ğŸ‘¥ ${(c.remaining ?? 0)}/${(c.capacity ?? '-')} Â· âœ… í•©ë¥˜ ì‹ ì²­</button>
    `;
    el.querySelector('.join').addEventListener('click',()=>openJoinModal(c));
    listEl.appendChild(el);
  });
}

/* í•©ë¥˜ ëª¨ë‹¬ */
const modal=document.getElementById('joinModal');
const sheet=document.getElementById('joinSheet');
const preview=document.getElementById('preview');
function closeJoinModal(){ modal.classList.remove('show'); document.body.classList.remove('modal-open'); }
modal.addEventListener('click', closeJoinModal);
sheet.addEventListener('click', e=>e.stopPropagation());
document.getElementById('editProfile').onclick=()=> location.href='rimo_profile.html';

function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
function composeText(crew, profile){
  const styles=(normalizeArr(profile.styles)).join(' Â· ') || '-';
  const paces =(normalizeArr(profile.pace  )).join(' Â· ') || '-';
  return (
`[âœ… í•©ë¥˜ ì‹ ì²­] ${crew.title}
ğŸ“ ì¶œë°œ â†’ ë„ì°©
${crew.from || '-'} â†’ ${crew.to || '-'}

ğŸ‘¤ ë¼ì´ë” : ${profile.name || 'ì´ë¦„ ë¯¸ì…ë ¥'} ${profile.icon || ''}
ğŸï¸ ë°”ì´í¬ : ${profile.bike || 'ë¯¸ì…ë ¥'}
â° ì„ í˜¸ ì‹œê°„ëŒ€ : ${profile.time || '-'}
ğŸ‘¥ íƒ ë¤ : ${profile.tandem ? 'íƒ ë¤ ' + profile.tandem : '-'}

ğŸ¯ ìŠ¤íƒ€ì¼/í˜ì´ìŠ¤
${styles} Â· ${paces}`
  );
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(_){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove(); return true; }
}
function openJoinModal(crew){
  const profile=loadProfile();
  const text=composeText(crew, profile);
  preview.textContent=text;
  copyText(text);
  document.body.classList.add('modal-open');
  modal.classList.add('show');
  document.getElementById('goAdmin').onclick=()=>{ location.href=ADMIN_DM; };
  document.getElementById('copyProfileBtn').onclick=()=> copyText(text);
}

/* ë Œë” íŒŒì´í”„ë¼ì¸ */
function filterActiveRows(rows){
  const now = Date.now();
  return rows
    .map(r=>({
      id: r.id || r.ID || `crew_${Math.random().toString(36).slice(2,8)}`,
      title: r.title || r.ì œëª© || '',
      datetime: r.datetime || r.Datetime || '',
      datetime_display: r.datetime_display || r.Time || r.ì¼ì‹œí‘œì‹œ || '',
      from: r.from || r.ì¶œë°œ || '',
      to: r.to || r.ë„ì°© || '',
      from_lat: Number(r.from_lat ?? r.From_Lat ?? r.ìœ„ë„ ?? NaN),
      from_lng: Number(r.from_lng ?? r.From_Lng ?? r.ê²½ë„ ?? NaN),
      to_lat:   Number(r.to_lat   ?? r.To_Lat   ?? r.ë„ì°©ìœ„ë„ ?? NaN),
      to_lng:   Number(r.to_lng   ?? r.To_Lng   ?? r.ë„ì°©ê²½ë„ ?? NaN),
      capacity: Number(r.capacity ?? r.ì •ì› ?? NaN),
      remaining:Number(r.remaining?? r.ì”ì—¬ ?? NaN),
      cc: r.cc || r.ë°°ê¸°ëŸ‰ || '',
      styles: r.styles ?? r.ìŠ¤íƒ€ì¼ ?? '',
      pace: r.pace ?? r.í˜ì´ìŠ¤ ?? '',
      message: r.message || r.ë©”ì‹œì§€ || '',
      theme: r.theme || r.í…Œë§ˆ || 'blue',
    }))
    .filter(rec=>{
      const start = parseStartISO(rec);
      if(!start) return true;
      const hideAfter = start.getTime() + EXP_MIN_AFTER_START*60*1000;
      return Date.now() <= hideAfter;
    })
    .sort((a,b)=>{
      const da=parseStartISO(a)?.getTime() ?? 0;
      const db=parseStartISO(b)?.getTime() ?? 0;
      return da - db;
    });
}
function renderAll(rows){
  const active = filterActiveRows(rows);
  renderCards(active);
  renderMap(active);
}

/* init */
(async function init(){
  const rows = await loadFromServer();
  renderAll(rows.length ? rows : [{
    id:"demo1", theme:"blue", title:"<ì˜ˆì‹œ ì¹´ë“œ â€” ê´€ë¦¬ìì—ì„œ ë°œí–‰í•˜ì„¸ìš”>",
    datetime_display:"10ì›” 10ì¼ 19:00",
    from:"ì¶œë°œì§€", to:"ë„ì°©ì§€",
    from_lat:37.5665, from_lng:126.9780, to_lat:37.55, to_lng:127.0,
    remaining:0, capacity:4, styles:["Urban","Easy"], cc:"", message:"ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë°œí–‰í•˜ë©´ ì´ ì˜ˆì‹œëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤."
  }]);

  // 1ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹  (ë§Œë£Œ/ì‹ ê·œ ë°˜ì˜)
  setInterval(async()=>{
    const latest = await loadFromServer();
    renderAll(latest);
  }, 60*1000);
})();
</script>
</body>
</html>
